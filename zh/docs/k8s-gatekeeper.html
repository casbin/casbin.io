<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-k8s-gatekeeper">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Admission Webhook For K8s | Casbin</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://casbin.io/zh/docs/k8s-gatekeeper"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="Casbin" content="An authorization library that supports access control models like ACL, RBAC, ABAC for Golang, Java, C/C++, Node.js, Javascript, PHP, Laravel, Python, .NET (C#), Delphi, Rust, Ruby, Swift (Objective-C), Lua (OpenResty), Dart (Flutter) and Elixir"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Admission Webhook For K8s | Casbin"><meta data-rh="true" name="description" content="Kubernetes (k8s) RBAC &amp; åŸºäºCasbinçš„ABACæˆæƒä¸­é—´ä»¶"><meta data-rh="true" property="og:description" content="Kubernetes (k8s) RBAC &amp; åŸºäºCasbinçš„ABACæˆæƒä¸­é—´ä»¶"><meta data-rh="true" name="keywords" content="k8s-gatekeeper,Kubernetes,k8s"><link data-rh="true" rel="icon" href="/zh/img/favicon.png"><link data-rh="true" rel="canonical" href="https://casbin.io/zh/docs/k8s-gatekeeper"><link data-rh="true" rel="alternate" href="https://casbin.io/docs/k8s-gatekeeper" hreflang="en"><link data-rh="true" rel="alternate" href="https://casbin.io/zh/docs/k8s-gatekeeper" hreflang="zh"><link data-rh="true" rel="alternate" href="https://casbin.io/ko/docs/k8s-gatekeeper" hreflang="ko"><link data-rh="true" rel="alternate" href="https://casbin.io/ru/docs/k8s-gatekeeper" hreflang="ru"><link data-rh="true" rel="alternate" href="https://casbin.io/fr/docs/k8s-gatekeeper" hreflang="fr"><link data-rh="true" rel="alternate" href="https://casbin.io/de/docs/k8s-gatekeeper" hreflang="de"><link data-rh="true" rel="alternate" href="https://casbin.io/ja/docs/k8s-gatekeeper" hreflang="ja"><link data-rh="true" rel="alternate" href="https://casbin.io/docs/k8s-gatekeeper" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://6NBEV8TOFK-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Casbin RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Casbin Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Casbin" href="/zh/opensearch.xml">
<script>!function(t,h,e,j,s,n){t.hj=t.hj||function(){(t.hj.q=t.hj.q||[]).push(arguments)},t._hjSettings={hjid:1689878,hjsv:6},s=h.getElementsByTagName("head")[0],(n=h.createElement("script")).async=1,n.src="https://static.hotjar.com/c/hotjar-"+t._hjSettings.hjid+".js?sv="+t._hjSettings.hjsv,s.appendChild(n)}(window,document)</script>
<script src="/js/isMainland.js"></script>
<script src="/js/gitter.js" async></script><link rel="stylesheet" href="/zh/assets/css/styles.c46d1be6.css">
<link rel="preload" href="/zh/assets/js/runtime~main.40e10046.js" as="script">
<link rel="preload" href="/zh/assets/js/main.6c9b915f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="è·³è½¬è‡³ä¸»è¦å†…å®¹"><a href="#" class="skipToContent_fXgn">è·³è½¬è‡³ä¸»è¦å†…å®¹</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><a href="https://casdoor.org/">ğŸ’– Looking for an open-source identity and access management solution like Okta, Auth0, Keycloak ? Learn more about: Casdoor</a></div><button type="button" aria-label="å…³é—­" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/casbin.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh/img/casbin.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Casbin</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/docs/overview">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/help">å¸®åŠ©</a><a class="navbar__item navbar__link" href="/zh/docs/management-api">API</a><a class="navbar__item navbar__link" href="/zh/editor">ç¼–è¾‘å™¨</a><a class="navbar__item navbar__link" href="/zh/docs/ide-plugins">IDE æ’ä»¶</a><a href="https://casdoor.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Casdoor<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://forum.casbin.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">è®ºå›<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>ä¸­æ–‡</a><ul class="dropdown__menu"><li><a href="/docs/k8s-gatekeeper" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh/docs/k8s-gatekeeper" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">ä¸­æ–‡</a></li><li><a href="/ko/docs/k8s-gatekeeper" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ko">í•œêµ­ì–´</a></li><li><a href="/ru/docs/k8s-gatekeeper" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</a></li><li><a href="/fr/docs/k8s-gatekeeper" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="fr">FranÃ§ais</a></li><li><a href="/de/docs/k8s-gatekeeper" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="de">Deutsch</a></li><li><a href="/ja/docs/k8s-gatekeeper" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">æ—¥æœ¬èª</a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://crowdin.com/project/casbin-website" target="_blank" rel="noopener noreferrer" class="dropdown__link">Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/casbin/casbin" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><a int="https://gitter.im/casbin/Lobby" cn="https://shang.qq.com/wpa/qunwpa?idkey=8ac8b91fc97ace3d383d0035f7aa06f7d670fd8e8d4837347354a31c18fac885" position="right" class="navbar__item navbar__link header-community-link"></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div><a int="https://door.casdoor.org/signup" cn="https://door.casdoor.com/signup" position="right" class="navbar__item navbar__link casdoor-signup casdoor-link">Sign Up</a><a int="https://door.casdoor.org/login" cn="https://door.casdoor.com/login" position="right" class="navbar__item navbar__link casdoor-login casdoor-link">Login</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="åˆ‡æ¢æµ…è‰²/æ·±è‰²æ¨¡å¼(å½“å‰ä¸ºæ—¥é—´æ¨¡å¼)" aria-label="åˆ‡æ¢æµ…è‰²/æ·±è‰²æ¨¡å¼(å½“å‰ä¸ºæ—¥é—´æ¨¡å¼)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="å›åˆ°é¡¶éƒ¨" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/zh/docs/category/the-basics">åŸºç¡€çŸ¥è¯†</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€ŒåŸºç¡€çŸ¥è¯†ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/overview">æ¦‚è¿°</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/get-started">å¼€å§‹ä½¿ç”¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/how-it-works">å·¥ä½œåŸç†</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/tutorials">ä½¿ç”¨æŒ‡å—</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/zh/docs/category/model">è®¿é—®æ§åˆ¶æ¨¡å‹</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œè®¿é—®æ§åˆ¶æ¨¡å‹ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/supported-models">æ”¯æŒçš„æ¨¡å‹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/syntax-for-models">Model çš„è¯­æ³•</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/effector">Effector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/function">å‡½æ•°</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/rbac">RBAC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/rbac-with-pattern">RBAC with Pattern</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/rbac-with-domains">åŸŸå†…åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/rbac-96">Casbin RBACå’ŒRBAC96</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/abac">ABAC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/priority-model">ä¼˜å…ˆçº§æ¨¡å‹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/superadmin">è¶…çº§ç®¡ç†å‘˜</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/zh/docs/category/storage">å­˜å‚¨</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œå­˜å‚¨ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/model-storage">Model çš„å­˜å‚¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/policy-storage">Policyçš„å­˜å‚¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/policy-subset-loading">ç­–ç•¥å­é›†åŠ è½½</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/zh/docs/category/extensions">æ‰©å±•åŠŸèƒ½</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œæ‰©å±•åŠŸèƒ½ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/enforcers">æ‰§è¡Œå™¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/adapters">é€‚é…å™¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/watchers">ç›‘è§†å™¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/dispatchers">è°ƒåº¦å™¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/role-managers">è§’è‰²ç®¡ç†å™¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/middlewares">ä¸­é—´ä»¶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/graphql-middlewares">Graphql-ä¸­é—´ä»¶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/cloud-native">äº‘ç«¯åŸç”Ÿä¸­é—´ä»¶</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/zh/docs/category/api">API</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€ŒAPIã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/api-overview">APIæ¦‚è¿°</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/management-api">ç®¡ç† API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/rbac-api">RBAC API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/rbac-with-domains-api">åŸŸå†…åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/rolemanager-api">è§’è‰²ç®¡ç†å™¨API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/data-permissions">æ•°æ®æƒé™</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/zh/docs/category/advanced-usage">é«˜çº§ç”¨æ³•</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œé«˜çº§ç”¨æ³•ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/multi-threading">å¤šçº¿ç¨‹</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/benchmark">æ€§èƒ½æµ‹è¯•</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance">æ€§èƒ½ä¼˜åŒ–</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/k8s">Kubernetesçš„æˆæƒ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zh/docs/k8s-gatekeeper">Admission Webhook For K8s</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/envoy">ä½¿ç”¨ Envoy å®ç° Service Mesh æƒé™ç®¡ç†</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/zh/docs/category/management">ç®¡ç†</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œç®¡ç†ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/admin-portal">Admin Portal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/service">CasbinæœåŠ¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/log-error">æ—¥å¿— &amp; é”™è¯¯å¤„ç†</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/frontend">å‰ç«¯ä½¿ç”¨</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/zh/docs/category/editor">ç¼–è¾‘å™¨</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œç¼–è¾‘å™¨ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/online-editor">Online Editor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/ide-plugins">IDE æ’ä»¶</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/zh/docs/category/more">æ›´å¤š</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œæ›´å¤šã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/adopters">ä½¿ç”¨è€…</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/contributing">å‚ä¸è´¡çŒ®</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/privacy-policy">éšç§æ”¿ç­–</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/terms-of-service">æœåŠ¡æ¡æ¬¾</a></li></ul></li></ul></nav><button type="button" title="æ”¶èµ·ä¾§è¾¹æ " aria-label="æ”¶èµ·ä¾§è¾¹æ " class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="è¶³è¿¹"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ä¸»é¡µ" class="breadcrumbs__link" href="/zh/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/zh/docs/category/advanced-usage"><span itemprop="name">é«˜çº§ç”¨æ³•</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Admission Webhook For K8s</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">æœ¬é¡µæ€»è§ˆ</button></div><div class="theme-doc-markdown markdown"><h1>Kubernetes + Casbin æ’ä»¶ï¼šK8s-Gatekeeper</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-æ¦‚è¿°-casbin-k8s-gatekeeper">1. æ¦‚è¿° Casbin K8s-Gatekeeper<a class="hash-link" href="#1-æ¦‚è¿°-casbin-k8s-gatekeeper" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h2><p>Casbin K8s-GateKeeper æ˜¯ Kubernetes çš„ä¸€ä¸ªæ¥å…¥webhook ï¼Œè¯¥æ¥å£å°†Cassbin ä½œä¸ºè®¿é—®æ§åˆ¶å·¥å…·ã€‚ é€šè¿‡ä½¿ç”¨Casbin K8s- gatekeeperï¼Œæ‚¨å¯ä»¥å»ºç«‹çµæ´»çš„è§„åˆ™æ¥æˆæƒæˆ–æ‹¦æˆªK8sèµ„æºä¸Šçš„ä»»ä½•æ“ä½œï¼Œè€Œæ— éœ€ç¼–å†™ä»»ä½•ä»£ç ï¼Œåªéœ€ç¼–å†™å‡ è¡Œå…³äºCasbinæ¨¡å‹å’Œç­–ç•¥çš„å£°æ˜æ€§é…ç½®(å®ƒä»¬æ˜¯Casbin ACL(è®¿é—®æ§åˆ¶åˆ—è¡¨)è¯­è¨€çš„ä¸€éƒ¨åˆ†)ã€‚</p><p>Casbin K8s-GateKeeperç”±Cassbinç¤¾åŒºå¼€å‘ã€ç»´æŠ¤ã€‚ è¯¥é¡¹ç›®ä»“åº“å¦‚ä¸‹ï¼š <a href="https://github.com/casbin/k8s-gatekeeper" target="_blank" rel="noopener noreferrer">https://github.com/casbin/k8s-gatekeeper</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="01-ç®€å•çš„ä¾‹å­">0.1 ç®€å•çš„ä¾‹å­<a class="hash-link" href="#01-ç®€å•çš„ä¾‹å­" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>ä¾‹å¦‚ï¼Œä½ æ— éœ€å†™ä»»ä½•ä»£ç ï¼Œåªéœ€ä½¿ç”¨ä»¥ä¸‹é…ç½®å³å¯å®ç°æ­¤åŠŸèƒ½:â€œç¦æ­¢åœ¨ä»»ä½•éƒ¨ç½²ä¸­ä½¿ç”¨å¸¦æœ‰ç‰¹å®šæ ‡ç­¾çš„å›¾åƒâ€:</p><p>æ¨¡å‹:</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">request_definition</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">r</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain">  </span><span class="token value attr-value" style="color:#e3116c">obj</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">policy_definition</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">p</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain">  </span><span class="token value attr-value" style="color:#e3116c">obj,eft</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">policy_effect</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">e</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token value attr-value" style="color:#e3116c">!some(where (p.eft == deny))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">matchers</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">m</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token value attr-value" style="color:#e3116c">r.obj.Request.Namespace == &quot;default&quot; &amp;&amp; r.obj.Request.Resource.Resource ==&quot;deployments&quot; &amp;&amp; \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contain(split(accessWithWildcard(${OBJECT}.Spec.Template.Spec.Containers , &quot;*&quot;, &quot;Image&quot;),&quot;:&quot;,1) , p.obj)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ç­–ç•¥ï¼š</p><div class="language-csv codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csv codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token value">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token value">â€œ1.14.1â€</span><span class="token punctuation" style="color:#393A34">,</span><span class="token value">å¦è®¤</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>è¿™äº›éƒ½æ˜¯ç”¨å¸¸è§çš„Casbin ACLè¯­è¨€ç¼–å†™çš„ã€‚ å¦‚è‹¥ä½ å·²é˜…è¯»è¿‡ç›¸å…³ç« èŠ‚ï¼Œé‚£å°±å¾ˆå®¹æ˜“ç†è§£ã€‚</p><p>Casbin K8s-Gatekeeperå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>å®ƒç®€å•æ˜“ç”¨ã€‚ å†™å‡ è¡ŒACLæ¯”å†™å¤§é‡ä»£ç è¦å¥½å¾—å¤šã€‚</li><li>å®ƒå…è®¸å¿«é€Ÿæ›´æ–°é…ç½®ã€‚ æ‚¨æ— éœ€å…³é—­æ•´ä¸ªæ’ä»¶æ¥ä¿®æ”¹é…ç½®ã€‚</li><li>å®ƒæ˜¯æ–°å…´å·¥å…·ã€‚ æ‚¨å¯ä»¥åœ¨ä»»ä½•k8sèµ„æºä¸Šåˆ¶å®šä»»æ„è§„åˆ™ï¼Œå®ƒéƒ½å¯ä»¥æ¢ç´¢åˆ°ã€‚</li><li>å®ƒå¯¹k8sæ¥å…¥webhookè¿›è¡Œäº†å¤æ‚æ£€æŸ¥ã€‚ ä½ æ— éœ€äº†è§£â€œK8s admission webhook â€æ˜¯ä»€ä¹ˆï¼Œä¹Ÿæ— éœ€çŸ¥é“å¦‚ä½•ä¸ºå®ƒç¼–å†™ä»£ç ã€‚ æ‚¨éœ€è¦åšçš„æ˜¯äº†è§£æ‚¨æƒ³è¦è®¾ç½®çº¦æŸçš„èµ„æºï¼Œç„¶åå†™å…¥Casbin ACLã€‚ å¤§å®¶éƒ½çŸ¥é“K8sååˆ†å¤æ‚ï¼Œä½†ä½¿ç”¨Casbin K8s-Gatekeeperå¯ä»¥èŠ‚çœæ‚¨çš„æ—¶é—´ã€‚</li><li>å®ƒç”±Cassbin ç¤¾åŒºç®¡ç†ã€‚ å¦‚æœæ­¤æ’ä»¶æœ‰ä»»ä½•å†…å®¹ä½¿æ‚¨æ„Ÿåˆ°å›°æƒ‘ï¼Œæˆ–è€…æ‚¨åœ¨å°è¯•æ­¤æ’ä»¶æ—¶é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-casbin-k8s-gatekeepeæ˜¯å¦‚ä½•è¿ä½œçš„">1.1 Casbin K8s-gatekeepeæ˜¯å¦‚ä½•è¿ä½œçš„ï¼Ÿ<a class="hash-link" href="#11-casbin-k8s-gatekeepeæ˜¯å¦‚ä½•è¿ä½œçš„" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>K8s-gatekeeper is an admission webhook for k8s, using <a href="/zh/docs/overview">Casbin</a> to apply arbitrary user-defined access control rules to help prevent any operation on k8s which administrator doesn&#x27;t want.</p><p>Casbinæ˜¯ä¸€ä¸ªå¼ºå¤§ã€é«˜æ•ˆçš„å¼€æ”¾æºç è®¿é—®æ§åˆ¶åº“ã€‚ å®ƒæ”¯æŒæ ¹æ®å„ç§å‡ºå…¥æ§åˆ¶æ¨¡å¼æ‰§è¡Œæˆæƒã€‚ å…³äºCasbinçš„æ›´å¤šè¯¦æƒ…ï¼Œè¯·å‚é˜… <a href="/zh/docs/overview">æ¦‚è¿°</a>ã€‚</p><p>Admission webhooks in K8s are HTTP callbacks that receive &#x27;admission requests&#x27; and do something with them. K8s-gatekeeper æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ webhook: &#x27;éªŒè¯å‡†å…¥Webhook&#x27; ï¼Œå®ƒå¯ä»¥å†³å®šæ˜¯å¦æ¥å—å‡†å…¥è¯·æ±‚ã€‚ å‡†å…¥è¯·æ±‚ï¼Œæ˜¯æŒ‡ç‰¹å®šçš„ K8 èµ„æºæ“ä½œçš„ HTTP è¯·æ±‚(ä¾‹å¦‚ï¼Œåˆ›å»º/åˆ é™¤ä¸€ä¸ªéƒ¨ç½²)ã€‚ æ›´å¤šå…³äºæ¥å…¥webhooksçš„ä¿¡æ¯ï¼Œè¯·å‚é˜…  <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#what-are-admission-webhooks" target="_blank" rel="noopener noreferrer">K8så®˜æ–¹çš„è”ç³»æ–¹å¼</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-è¯´æ˜å…¶è¿ä½œæ–¹å¼çš„ä¸€ä¸ªä¾‹å­">1.2 è¯´æ˜å…¶è¿ä½œæ–¹å¼çš„ä¸€ä¸ªä¾‹å­ã€‚<a class="hash-link" href="#12-è¯´æ˜å…¶è¿ä½œæ–¹å¼çš„ä¸€ä¸ªä¾‹å­" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>ä¾‹å¦‚ï¼Œå¦‚æœæƒ³è¦åˆ›å»ºä¸€ä¸ªåŒ…å«æ­£åœ¨è¿è¡Œnginx çš„pod çš„éƒ¨ç½²(ä½¿ç”¨ kubectl æˆ– k8 s å®¢æˆ·ç«¯)ï¼Œ K8så°†ç”Ÿæˆä¸€ä¸ªè®¸å¯è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚(å¦‚æœç¿»è¯‘æˆyamlæ ¼å¼)å¯èƒ½æ˜¯è¿™æ ·çš„ã€‚</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.14.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>æ­¤è¯·æ±‚å°†ç»è¿‡å›¾ç‰‡ä¸­æ˜¾ç¤ºçš„æ‰€æœ‰ä¸­é—´ä»¶å®¡æ ¸ï¼ŒåŒ…æ‹¬æˆ‘ä»¬çš„K8s-gatekeeperã€‚ K8s-gatekeeperå¯ä»¥æ£€æµ‹åˆ° K8sä¸­å­˜å‚¨çš„ Casbin æ‰§è¡Œç¨‹åºï¼Œè¿™äº›æ‰§è¡Œç¨‹åºç”±ç”¨æˆ·åˆ›å»ºå’Œç»´æŠ¤(é€šè¿‡æˆ‘ä»¬æä¾›çš„ kubectl æˆ– go-client )ã€‚ æ¯ä¸ªæ‰§è¡Œç¨‹åºéƒ½æœ‰Cassbinæ¨¡å‹å’ŒCassbinæ”¿ç­–ã€‚ è®¸å¯è¯·æ±‚å°†ç”±æ‰§è¡Œç¨‹åºä¸€ä¸€å¤„ç†ï¼Œåªæœ‰é€šè¿‡æ‰€æœ‰æ‰§è¡Œç¨‹åºï¼Œk8 -gatekeeperæ‰ä¼šæ¥å—è¯¥è¯·æ±‚ã€‚</p><p>(å¦‚æœæ‚¨ä¸ç†è§£Casbin æ‰§è¡Œç¨‹åºã€æ¨¡å‹æˆ–æ”¿ç­–ï¼Œè§æœ¬æ–‡æ¡£ï¼š <a href="/zh/docs/get-started">å¼€å§‹</a>)</p><p>ä¾‹å¦‚ï¼Œç”±äºæŸäº›åŸå› ï¼Œç®¡ç†å‘˜æƒ³ç¦æ­¢å›¾åƒâ€œnginx:1.14.1â€ï¼ŒåŒæ—¶å…è®¸â€œnginx:1.3â€ã€‚é‚£ä¹ˆå¯ä»¥åˆ›å»ºä¸€ä¸ªæ‰§è¡Œç¨‹åºï¼Œå…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹è§„åˆ™å’Œæ”¿ç­–ï¼šï¼ˆæˆ‘ä»¬å°†è§£é‡Šå¦‚ä½•åˆ›å»ºä¸€ä¸ªæ‰§è¡Œç¨‹åºï¼Œ è¿™äº›æ¨¡å¼å’Œæ”¿ç­–æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•å°†å…¶å†™å…¥ä»¥ä¸‹ç« èŠ‚ã€‚)</p><p>æ¨¡å‹:</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">request_definition</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">r</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain">  </span><span class="token value attr-value" style="color:#e3116c">obj</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">policy_definition</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">p</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain">  </span><span class="token value attr-value" style="color:#e3116c">obj,eft</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">policy_effect</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">e</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token value attr-value" style="color:#e3116c">!some(where (p.eft == deny))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">matchers</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">m</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token value attr-value" style="color:#e3116c">r.obj.Request.Namespace == &quot;default&quot; &amp;&amp; r.obj.Request.Resource.Resource ==&quot;deployments&quot; &amp;&amp; \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, &quot;Image&quot;)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token value attr-value" style="color:#e3116c">= p.obj</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ç­–ç•¥:</p><div class="language-csv codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csv codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token value">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token value"> </span><span class="token value">&quot;nginx:1.13.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token value">allow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token value">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token value"> </span><span class="token value">&quot;nginx:1.14.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token value">deny</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>é€šè¿‡åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸Šè¿°æ¨¡å‹å’Œç­–ç•¥çš„æ‰§è¡Œç¨‹åºï¼Œ æ­¤æ‰§è¡Œç¨‹åºå°†æ‹’ç»å…ˆå‰çš„è®¸å¯ç”³è¯·ï¼Œè¿™æ„å‘³ç€K8sä¸ä¼šåˆ›å»ºæ­¤éƒ¨ç½²ã€‚</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-å®‰è£…-k8s-gatekeeper">2 å®‰è£… K8s-gatekeeper<a class="hash-link" href="#2-å®‰è£…-k8s-gatekeeper" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h2><p>æœ‰ä¸‰ç§æ–¹æ³•å®‰è£… K8s-gateeperï¼šå¤–éƒ¨webhookã€å†…éƒ¨webhook å’Œhelmã€‚</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>å¤‡æ³¨</div><div class="admonitionContent_S0QG"><p>æ³¨æ„ï¼šè¿™äº›æ–¹æ³•åªé€‚ç”¨äºç”¨æˆ·ä½“éªŒK8s-gateeperï¼Œå¹¶ä¸å®‰å…¨ã€‚ å¦‚æœæ‚¨æƒ³åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œè¯·åŠ¡å¿…é˜…è¯»  <a href="#5-advanced-settings">ç¬¬äº”ç« ã€‚ é«˜çº§è®¾ç½®</a> å¹¶åœ¨å®‰è£…å‰æ ¹æ®éœ€è¦åšç›¸åº”ä¿®æ”¹</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-å†…éƒ¨webhook">2.1 å†…éƒ¨webhook<a class="hash-link" href="#21-å†…éƒ¨webhook" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="211-ç¬¬1æ­¥æ„å»ºå›¾åƒ">2.1.1 ç¬¬1æ­¥ï¼šæ„å»ºå›¾åƒ<a class="hash-link" href="#211-ç¬¬1æ­¥æ„å»ºå›¾åƒ" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>Internal webhook æ„å‘³ç€webhook æœ¬èº«å°†ä¼šä½œä¸º k8 så†…çš„æœåŠ¡è¿è¡Œã€‚ åˆ›å»ºæœåŠ¡å’Œéƒ¨ç½²éœ€è¦K8s-gatekeeperçš„å›¾åƒã€‚ æ‚¨å¯ä»¥å»ºç«‹è‡ªå·±çš„å›¾åƒã€‚</p><p>è¿è¡Œ</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build --target webhook -t k8s-gatekeeper </span><span class="token builtin class-name">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ç„¶åå°†ä¼šæœ‰ä¸€ä¸ªæœ¬åœ°å›¾åƒå«åšâ€œk8s-gateper:latestâ€ã€‚</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>å¤‡æ³¨</div><div class="admonitionContent_S0QG"><p>æ³¨æ„ï¼šå¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ minikubeï¼Œè¯·åœ¨è¿è¡Œ docker æ„å»ºä¹‹å‰æ‰§è¡Œ <code>val $(minikube -p minikube docker-env)</code></p></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="212-ç¬¬2æ­¥ä¸ºk8s-gatekeeperè®¾ç½®æœåŠ¡å’Œéƒ¨ç½²">2.1.2 ç¬¬2æ­¥ï¼šä¸ºK8s-gatekeeperè®¾ç½®æœåŠ¡å’Œéƒ¨ç½²<a class="hash-link" href="#212-ç¬¬2æ­¥ä¸ºk8s-gatekeeperè®¾ç½®æœåŠ¡å’Œéƒ¨ç½²" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f config/rbac.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f config/webhook_deployment.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f config/webhook_internal.yaml </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>å³å°†è¿è¡Œ K8s-gatekeeperï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>kubectl è·å–</code> æ¥ç¡®è®¤ã€‚</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="213-ç¬¬ä¸‰æ­¥-ä¸ºk8s-gatekeeper-å®‰è£…crd-èµ„æº">2.1.3 ç¬¬ä¸‰æ­¥: ä¸ºK8s-gatekeeper å®‰è£…Crd èµ„æº<a class="hash-link" href="#213-ç¬¬ä¸‰æ­¥-ä¸ºk8s-gatekeeper-å®‰è£…crd-èµ„æº" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f config/auth.casbin.org_casbinmodels.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f config/auth.casbin.org_casbinpolicies.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-å†…éƒ¨webhook">2.2 å†…éƒ¨webhook<a class="hash-link" href="#22-å†…éƒ¨webhook" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>å¤–éƒ¨Webhook æ„å‘³ç€K8s-gatekeeper å°†åœ¨ K8 sä¹‹å¤–è¿è¡Œï¼ŒK8s å°†è®¿é—® K8s-gatekeeper ï¼Œåƒè®¿é—®æ™®é€šç½‘ç«™ä¸€æ ·ã€‚ K8sè¦æ±‚webhookå¿…é¡»æ˜¯HTTPSã€‚ ä¸ºäº†è®©æ‚¨ä½“éªŒK8s-gatekeeperï¼Œæˆ‘ä»¬å·²ç»ä¸ºæ‚¨æä¾›äº†ä¸€å¥—è¯ä¹¦ä»¥åŠç§é’¥(å°½ç®¡å®ƒå®‰å…¨ç³»æ•°ä¸é«˜)ã€‚ å¦‚æœæ‚¨æƒ³ç”¨è‡ªå·±çš„è¯ä¹¦ï¼Œè¯·å‚é˜… <a href="#5-advanced-settings">ç¬¬äº”ç« ã€‚ é«˜çº§è®¾ç½®</a> ä»¥è°ƒæ•´è¯ä¹¦å’Œç§é’¥ã€‚</p><p>æˆ‘ä»¬æä¾›çš„è¯ä¹¦æ˜¯ä¸º &#x27;webhook.domain.local&#x27; é¢å‘çš„ï¼Œæ‰€ä»¥è¯·ä¿®æ”¹ä¸»æœº (ä¾‹å¦‚/etc/hosts)ï¼Œpoint webhookã€‚ K8sgatekeeper æ­£åœ¨è¿è¡Œçš„ omain.local åˆ° IP åœ°å€ã€‚</p><p>ç„¶åæ‰§è¡Œ</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go mod tidy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go mod vendor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go run cmd/webhook/main.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f config/auth.casbin.org_casbinmodels.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f config/auth.casbin.org_casbinpolicies.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f config/webhook_external.yaml </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-é€šè¿‡-helm-å®‰è£…-k8s-gatekeeper">2.3 é€šè¿‡ helm å®‰è£… K8s-gatekeeper<a class="hash-link" href="#23-é€šè¿‡-helm-å®‰è£…-k8s-gatekeeper" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="231-ç¬¬1æ­¥æ„å»ºå›¾åƒ">2.3.1 ç¬¬1æ­¥ï¼šæ„å»ºå›¾åƒ<a class="hash-link" href="#231-ç¬¬1æ­¥æ„å»ºå›¾åƒ" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>è¯·å‚é˜… <a href="#211-step-1-build-image">ç¬¬ 2.1.1 ç« </a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="232-helm-å®‰è£…">2.3.2 helm å®‰è£…<a class="hash-link" href="#232-helm-å®‰è£…" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>è¿è¡Œ <code>helm install k8sgatekeepeer ./k8sgatekeepeer</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-è¯•ç”¨k8s-gatekeeper">3. è¯•ç”¨K8s-gatekeeper<a class="hash-link" href="#3-è¯•ç”¨k8s-gatekeeper" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-åˆ›å»ºcassbin-æ¨¡å‹å’Œç­–ç•¥">3.1 åˆ›å»ºCassbin æ¨¡å‹å’Œç­–ç•¥<a class="hash-link" href="#31-åˆ›å»ºcassbin-æ¨¡å‹å’Œç­–ç•¥" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>æ‚¨æœ‰ä¸¤ç§æ–¹æ³•æ¥åˆ›å»ºæ¨¡å‹å’Œç­–ç•¥ï¼šé€šè¿‡æˆ‘ä»¬æä¾›çš„kubectl æˆ–go-client ã€‚</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="311-é€šè¿‡-kubectl-åˆ›å»ºæ›´æ–°casbin-æ¨¡å‹å’Œç­–ç•¥">3.1.1 é€šè¿‡ kubectl åˆ›å»º/æ›´æ–°Casbin æ¨¡å‹å’Œç­–ç•¥<a class="hash-link" href="#311-é€šè¿‡-kubectl-åˆ›å»ºæ›´æ–°casbin-æ¨¡å‹å’Œç­–ç•¥" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>åœ¨K8s-gatekeperï¼ŒCassbinæ¨¡å‹å‚¨å­˜åœ¨â€œCassbinModelâ€çš„CRDèµ„æºä¸­ã€‚ å…¶å®šä¹‰å¯å‚è§<code>config/auth.casbin.org_cassbinmodels.yaml</code></p><p><code>example/allowed_repo/model.yaml</code> ä¸­æœ‰ç¤ºä¾‹ã€‚ æ‚¨åº”è¯¥æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>metadata.name: æ¨¡å‹åç§° è¯¥åç§°ä¸æ­¤æ¨¡å‹ç›¸å…³çš„CassbinPolicy objectivesåç§°ç›¸åŒï¼Œè¿™æ ·K8s-gatekeeper å°±å¯ä»¥å°†å®ƒä»¬è¿›è¡ŒåŒ¹é…å¹¶åˆ›å»ºä¸€ä¸ªæ‰§è¡Œç¨‹åºã€‚</li><li>å¯ç”¨ï¼šå¦‚æœæ­¤å­—æ®µè®¾ç½®ä¸ºâ€œfalseâ€ï¼Œå°†å¿½ç•¥æ­¤æ¨¡å‹(ä»¥åŠä¸æ­¤æ¨¡å‹ç›¸å…³çš„ CasbinPolicy å¯¹è±¡)ã€‚</li><li>æ ·å¼æ–‡æœ¬ï¼šä¸€ä¸ªåŒ…å«containsæ¨¡å‹æ–‡æœ¬çš„å­—ç¬¦ä¸²ã€‚</li></ul><p>Casbin ç­–ç•¥å­˜å‚¨åœ¨å¦ä¸€ç§&#x27;CasbinPolicy&#x27; çš„CRD èµ„æºä¸­ï¼Œå…¶å®šä¹‰å¯å‚è§<code>config/auth.casbin.org_casbinpolicies.yaml</code> ã€‚</p><p><code>example/allowed_repo/policy.yaml</code> ä¸­æœ‰ç¤ºä¾‹ã€‚ æ‚¨åº”è¯¥æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>metadata.name: ç­–ç•¥åç§° è¿™ä¸ªåç§°ä¸è¯¥æ”¿ç­–ç›¸å…³çš„Cassbinæ¨¡å‹å¯¹è±¡çš„åç§°ç›¸åŒï¼Œè¿™æ ·K8s-gatekeeper å¯ä»¥å°†å®ƒä»¬é…å¯¹å¹¶åˆ›å»ºä¸€ä¸ªæ‰§è¡Œè€…ã€‚</li><li>spec.policyitemï¼šä¸€ä¸ªåŒ…å«casbinæ¨¡å‹ç­–ç•¥æ–‡æœ¬çš„å­—ç¬¦ä¸²ã€‚</li></ul><p>åˆ›å»ºæ‚¨è‡ªå·±çš„ Cassbinæ¨¡å‹å’Œ æ”¿ç­–æ–‡ä»¶åï¼Œä½¿ç”¨</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">filename</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ä½¿å…¶ç”Ÿæ•ˆã€‚</p><p>Cassbinæ¨¡å‹å’Œç­–ç•¥ä¸€æ—¦åˆ›å»ºï¼Œæœ€å¤š5ç§’é’Ÿå†…K8s-gatekeeperä¾¿èƒ½æ£€æµ‹åˆ°ã€‚</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="312-é€šè¿‡æˆ‘ä»¬æä¾›çš„-go-client-åˆ›å»ºæ›´æ–°-cassbin-æ¨¡å‹å’Œç­–ç•¥">3.1.2 é€šè¿‡æˆ‘ä»¬æä¾›çš„ go-client åˆ›å»º/æ›´æ–° Cassbin æ¨¡å‹å’Œç­–ç•¥<a class="hash-link" href="#312-é€šè¿‡æˆ‘ä»¬æä¾›çš„-go-client-åˆ›å»ºæ›´æ–°-cassbin-æ¨¡å‹å’Œç­–ç•¥" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>æˆ‘ä»¬è€ƒè™‘åˆ°å¯èƒ½æœ‰è¿™æ ·çš„æƒ…å†µï¼Œç”¨ shellç›´æ¥åœ¨ K8 sç¾¤ç»„çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤å¹¶ä¸æ–¹ä¾¿ã€‚ ä¾‹å¦‚ï¼Œå½“æ‚¨æ­£åœ¨ä¸ºå…¬å¸å»ºç«‹è‡ªåŠ¨äº‘å¹³å°æ—¶ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¼€å‘äº†go-clientæ¥åˆ›å»ºCassbinæ¨¡å‹å’Œç­–ç•¥ã€‚</p><p>go-client åº“å¯å‚è§pkg/clientã€‚</p><p>åœ¨ client.go ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†åˆ›å»ºå®¢æˆ·ç«¯çš„åŠŸèƒ½ã€‚</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewK8sGateKeeperClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">externalClient </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">K8sGateKeeperClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>å¤–éƒ¨å®¢æˆ·ç«¯å‚æ•°å†³å®šK8s-gatekeeper æ˜¯å¦åœ¨ K8s é›†ç¾¤ä¸­è¿è¡Œã€‚</p><p>åœ¨ model.go ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†å„ç§åŠŸèƒ½ä»¥åˆ›å»º/åˆ é™¤/ä¿®æ”¹Casbinæ¨¡å‹ã€‚ æ‚¨å¯ä»¥åœ¨model_test.goä¸­æ‰¾åˆ°æ¥å£çš„ä½¿ç”¨æ–¹å¼ã€‚</p><p>åœ¨ policy.go ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†å„ç§åŠŸèƒ½ä»¥åˆ›å»º/åˆ é™¤/ä¿®æ”¹Casbinæ¨¡å‹ã€‚ æ‚¨å¯ä»¥åœ¨policy_test.goä¸­æ‰¾åˆ°è¿™äº›æ¥å£çš„ä½¿ç”¨æ–¹å¼ã€‚</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="312-è¯•ç”¨k8s-gatekeeperæ˜¯å¦è¿ä½œ">3.1.2 è¯•ç”¨K8s-gatekeeperæ˜¯å¦è¿ä½œ<a class="hash-link" href="#312-è¯•ç”¨k8s-gatekeeperæ˜¯å¦è¿ä½œ" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>å‡å®šæ‚¨å·²ç»åœ¨example/allowed_repoä¸­åˆ›å»ºäº†å®Œæ•´çš„æ¨¡å‹å’Œç­–ç•¥ï¼Œä¾¿å¯è¾“å…¥ï¼š</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f example/allowed_repo/testcase/reject_1.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ä½ ä¼šå‘ç°k8sä¼šæ‹’ç»è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶æåˆ°webhookæ˜¯æ‹’ç»æ­¤è¯·æ±‚çš„åŸå› ã€‚ ç„¶è€Œï¼Œå½“æ‚¨å°è¯•è¾“å…¥example/allowed_repo/testcase/approve_2.yamlæ—¶ï¼Œk8så°†ä¼šæ¥å—è¯¥è¯·æ±‚ã€‚</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-å¦‚ä½•å†™k8s-gatekeeperæ¨¡å‹å’Œç­–ç•¥">4. å¦‚ä½•å†™K8s-gatekeeperæ¨¡å‹å’Œç­–ç•¥<a class="hash-link" href="#4-å¦‚ä½•å†™k8s-gatekeeperæ¨¡å‹å’Œç­–ç•¥" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h2><p>é¦–å…ˆï¼Œæ‚¨åº”è¯¥çŸ¥é“Casbinæ¨¡å‹å’Œç­–ç•¥çš„åŸºæœ¬è¯­æ³•ã€‚ å¦‚æœæ‚¨è¿˜æœªæ›¾äº†è§£ï¼Œè¯·å…ˆé˜…è¯» <a href="/zh/docs/get-started">å¼€å§‹</a>ã€‚ åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å‡å®šæ‚¨å·²çŸ¥Casbinæ¨¡å‹å’Œç­–ç•¥ã€‚</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-æ¨¡å‹çš„è¯·æ±‚å®šä¹‰">4.1 æ¨¡å‹çš„è¯·æ±‚å®šä¹‰<a class="hash-link" href="#41-æ¨¡å‹çš„è¯·æ±‚å®šä¹‰" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>å½“K8s-gatekeeper æˆæƒè¯·æ±‚æ—¶ï¼Œæ€»æ˜¯è¾“å…¥ï¼šthe go object of the Admission Requestã€‚ è¿™æ„å‘³ç€æ‰§è¡Œç¨‹åºæ€»æ˜¯è¿™æ ·è¿ä½œã€‚</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  ok</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> enforcer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Enforce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admission</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>admissionæ˜¯ä¸€ä¸ªç”±K8så®˜æ–¹go apiâ€œK8s .io/api/admission/v1â€å®šä¹‰çš„AdmissionReviewå¯¹è±¡ã€‚ æ‚¨å¯ä»¥åœ¨è¿™ä¸ªèµ„æºåº“çœ‹åˆ°è¿™ä¸ªç»“æ„çš„å®šä¹‰ï¼š<a href="https://github.com/kubernetes/api/blob/master/admission/v1/types.go" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/api/blob/master/admission/v1/types.go</a>ã€‚ æˆ–æŸ¥çœ‹ <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/reference/access-authz/extensible-admission-controllers/#webhook-request-and-response</a> è·å–æ›´å¤šä¿¡æ¯</p><p>å› æ­¤ï¼Œå¯¹äºK8s-gatekeeperä½¿ç”¨çš„ä»»ä½•æ¨¡å‹ï¼Œè¯·æ±‚çš„å®šä¹‰åº”è¯¥å§‹ç»ˆæ˜¯è¿™æ ·çš„ï¼š</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">request_definition</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key attr-name" style="color:#00a4db">r</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain">  </span><span class="token value attr-value" style="color:#e3116c">obj</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>åç§°â€œobjâ€ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œåªè¦åç§°ä¸ <code>[matchers]</code> ä¸­ä½¿ç”¨çš„åç§°ä¸€è‡´å³å¯ã€‚</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-æ¨¡å‹åŒ¹é…å™¨">4.2 æ¨¡å‹åŒ¹é…å™¨<a class="hash-link" href="#42-æ¨¡å‹åŒ¹é…å™¨" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>æ‚¨åº”è¯¥ä½¿ç”¨ Cassbin çš„ ABAC ç‰¹æ€§å†™ä¸‹æ‚¨çš„è§„åˆ™ã€‚ ç„¶è€Œï¼ŒCasbiné›†æˆçš„è¡¨è¾¾å¼è¯„ä¼°å·¥å…·æ—¢ä¸æ”¯æŒåœ¨åœ°å›¾æˆ–é˜µåˆ—ä¸­è¿›è¡Œç´¢å¼•ï¼Œä¹Ÿä¸æ”¯æŒæ‰©å¤§é˜µåˆ—ã€‚ å› æ­¤ï¼ŒK8s-gatekeeper æä¾›äº†å„ç§çš„ â€œCasbin åŠŸèƒ½â€ä½œä¸ºè¿™äº›ç‰¹æ€§çš„å»¶ä¼¸å…ƒç´ ã€‚ å¦‚æœæ‚¨å‘ç°è¿™äº›æ‰©å±•ä»æ— æ³•æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œæ¬¢è¿æ‚¨æå‡ºæ‚¨çš„é—®é¢˜ï¼Œæˆ–è€…ç›´æ¥åˆ›å»ºprã€‚</p><p>å¦‚æœæ‚¨ä¸çŸ¥é“ä»€ä¹ˆæ˜¯casbinåŠŸèƒ½ï¼Œè¯·å‚é˜… <a href="/zh/docs/function">Function</a> ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚</p><p>ä»¥ä¸‹æ˜¯æ‰©å±•åŠŸèƒ½ã€‚</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="421-å¤–éƒ¨åŠŸèƒ½">4.2.1 å¤–éƒ¨åŠŸèƒ½<a class="hash-link" href="#421-å¤–éƒ¨åŠŸèƒ½" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4211-è®¿é—®">4.2.1.1 è®¿é—®<a class="hash-link" href="#4211-è®¿é—®" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>è®¿é—®ä¸»è¦æ˜¯ç”¨æ¥è§£å†³Casbinä¸æ”¯æŒåœ¨åœ°å›¾æˆ–æ•°ç»„ä¸­ç´¢å¼•çš„é—®é¢˜ã€‚ <code>example/allowed_repo/model.yaml</code>æ˜¯è¯¥åŠŸèƒ½çš„ä¾‹å­ã€‚</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">matchers</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">m</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token value attr-value" style="color:#e3116c">r.obj.Request.Namespace == &quot;default&quot; &amp;&amp; r.obj.Request.Resource.Resource ==&quot;deployments&quot; &amp;&amp; \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, &quot;Image&quot;)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token value attr-value" style="color:#e3116c">= p.obj</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>åœ¨è¿™ä¸ªåŒ¹é…å™¨ä¸­ï¼Œaccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, &quot;Image&quot;) ç›¸å½“äº <code>r.obj.Request.Object.Object.Template.Spec.Containers[0].Image</code>, å…¶ä¸­ <code>r.obj.Request.Object.Object.Object.Spec.Template.Containers</code> æ˜¾ç„¶æ˜¯ä¸€ç§sliceã€‚</p><p>è®¿é—®è¿˜å¯ä»¥è°ƒç”¨æ²¡æœ‰å‚æ•°å’Œå•ä¸ªè¿”å›å€¼çš„ç®€å•åŠŸèƒ½ã€‚ å¯å‚è§ä¾‹å­ï¼š<code>example/container_resource_limit/model.yaml</code></p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">matchers</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key attr-name" style="color:#00a4db">m</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token value attr-value" style="color:#e3116c">r.obj.Request.Namespace == &quot;default&quot; &amp;&amp; r.obj.Request.Resource.Resource ==&quot;deployments&quot; &amp;&amp; \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key attr-name" style="color:#00a4db">parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, &quot;Resources&quot;,&quot;Limits&quot;,&quot;cpu&quot;,&quot;Value&quot;)) &gt;</span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token value attr-value" style="color:#e3116c">parseFloat(p.cpu) &amp;&amp; \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key attr-name" style="color:#00a4db">parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, &quot;Resources&quot;,&quot;Limits&quot;,&quot;memory&quot;,&quot;Value&quot;)) &gt;</span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token value attr-value" style="color:#e3116c">parseFloat(p.memory)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>åœ¨è¿™ä¸ªåŒ¹é…å™¨ä¸­ï¼Œ <code>access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, &quot;Resources&quot;,&quot;Limits&quot;,&quot;cpu&quot;,&quot;value&quot;)</code> ç›¸å½“äº<code>r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits[&quot;cpu&quot;]ã€‚ alue()</code>, å…¶ä¸­ <code>r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resourcesã€‚ imits</code> æ˜¯ä¸€ä¸ªåœ°å›¾ï¼Œ <code>Value()</code> æ˜¯ä¸€ä¸ªæ²¡æœ‰å‚æ•°å’Œè¿”å›å€¼çš„ç®€å•åŠŸèƒ½ã€‚</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4212-è®¿é—®withildcard">4.2.1.2 è®¿é—®Withildcard<a class="hash-link" href="#4212-è®¿é—®withildcard" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>æœ‰æ—¶æˆ‘ä»¬ç»å¸¸æœ‰åƒè¿™æ ·çš„éœ€æ±‚ï¼šæ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½å¿…é¡»æœ‰å‰ç¼€â€œaaaâ€ã€‚ ç„¶è€Œï¼ŒCasbin ä¸æ”¯æŒã€‚ ä½†ä½¿ç”¨ <code>accessWithildcard</code> å’Œâ€œmap/slice extensionâ€ åŠŸèƒ½ï¼Œè¿™æ ·çš„éœ€æ±‚å¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°ã€‚</p><p>ä¾‹å¦‚ï¼Œå‡å®š <code>a.b.</code> æ˜¯ä¸€ä¸ªæ•°ç»„ <code>[aaa,bbbb,cccddd,eeee]</code>, ç„¶å<code>accessWithwildcard(a, ) b&quot;,&quot;c&quot;,&quot;*&quot;)</code> å°†æˆä¸ºsliice <code>[aa,bbb,ccc,dd,ee]</code> æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ ä½¿ç”¨é€šé…ç¬¦ <code>*</code> è¿™ä¸ªåˆ‡ç‰‡ä¾¿æ‰©å¤§äº†ã€‚</p><p>åŒæ ·ï¼Œé€šé…ç¬¦å¯ä»¥å¤šæ¬¡ä½¿ç”¨ã€‚ ä¾‹å¦‚ï¼Œ <code>ç”¨Withildcardè¾“å…¥(a,&quot;b&quot;,&quot;c&quot;,&quot;*&quot;,&quot;*&quot;)</code> å°†ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœ <code>[a.b.[0][0], a.b.c[0][1]... a.b.c[1][0], a.b.c[1][1]...]</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4213-æ”¯æŒå¯å˜é•¿åº¦å‚æ•°çš„åŠŸèƒ½">4.2.1.3 æ”¯æŒå¯å˜é•¿åº¦å‚æ•°çš„åŠŸèƒ½<a class="hash-link" href="#4213-æ”¯æŒå¯å˜é•¿åº¦å‚æ•°çš„åŠŸèƒ½" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>åœ¨Cassbinçš„è¡¨è¾¾å¼è¯„ä¼°å™¨ä¸­ï¼Œå½“å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„æ—¶ï¼Œå®ƒå°†è‡ªåŠ¨æ‰©å±•ä¸ºå˜é‡é•¿åº¦å‚æ•°ã€‚ åˆ©ç”¨æ­¤åŠŸèƒ½æ”¯æŒæ•°ç»„/åˆ‡ç‰‡/åœ°å›¾æ‰©å±•ï¼Œæˆ‘ä»¬è¿˜æ•´åˆäº†æœåŠ¡å™¨åŠŸèƒ½ï¼Œæ¥å—æ•°ç»„/åˆ‡ç‰‡ä½œä¸ºå‚æ•°ã€‚</p><ul><li>åŒ…å«()ï¼Œæ¥å—å¤šä¸ªå‚æ•°ï¼Œå¹¶è¿”å›é™¤äº†æœ€åä¸€ä¸ªå‚æ•°ä¹‹å¤–æ˜¯è¿˜æœ‰å‚æ•°ç­‰äºæœ€åä¸€ä¸ªå‚æ•°ã€‚</li><li>split(a,b,c...,sep,index) it returns a slice which contains<code>[splits(a,sep)[index], splits(b,sep)[index], splits(a,sep)[index]...]</code></li><li>len() return the length of the variable-length argument</li><li>matchRegex(a,b,c...regex) return whether a,b,c... all of them matches the given regex</li></ul><p>Here is an example in <code>example/disallowed_tag/model.yaml</code></p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">matchers</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key attr-name" style="color:#00a4db">m</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">=</span><span class="token plain"> </span><span class="token value attr-value" style="color:#e3116c">r.obj.Request.Namespace == &quot;default&quot; &amp;&amp; r.obj.Request.Resource.Resource ==&quot;deployments&quot; &amp;&amp; \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , &quot;*&quot;, &quot;Image&quot;),&quot;:&quot;,1) , p.obj)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Assume <code>accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , &quot;*&quot;, &quot;Image&quot;)</code>returns <code>[&quot;a:b&quot;, &quot;c:d&quot;, &quot;e:f&quot;, &quot;g:h&quot;]</code> then because splits supports variable-length argument, and splits operation is applied on each element, and eventualy element whose index is 1 will be selected and return, so <code>split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , &quot;*&quot;, &quot;Image&quot;),&quot;:&quot;,1)</code> returns <code>[&quot;b&quot;,&quot;d&quot;,&quot;f&quot;,&quot;h&quot;]</code>. And <code>contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , &quot;*&quot;, &quot;Image&quot;),&quot;:&quot;,1) , p.obj)</code> returns whether<code>p.obj</code> is contained in <code>[&quot;b&quot;,&quot;d&quot;,&quot;f&quot;,&quot;h&quot;]</code></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4212-type-conversion-functions">4.2.1.2 Type conversion functions<a class="hash-link" href="#4212-type-conversion-functions" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><ul><li>ParseFloat(): parse an integer to a float. (It is because that any number in comparsion must be converted into float).</li><li>ToString(): convert an object to string. This object must have a basic type of string. (for example, an object of type <code>XXX</code> when there is a statement <code>type XXX string</code>)</li><li>IsNil(): return whether the parameter is nil</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-advanced-settings">5. Advanced Settings<a class="hash-link" href="#5-advanced-settings" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-about-certificates">5.1 About Certificates<a class="hash-link" href="#51-about-certificates" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h3><p>In k8s, it is mandatory that a webhook should use HTTPS. There are two approaches to achieve that:</p><ul><li>Use self-signed certificates(examples in this repo use this method )</li><li>Use a normal certificate</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="511-self-signed-certificates">5.1.1 Self-signed certificates<a class="hash-link" href="#511-self-signed-certificates" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>Using a self-signed certificate means that the CA issuing the certificate is not one of the well-known CAs, therefore you must let k8s know this CA.</p><p>Current the example in this repo uses a self-made CA, whose private key and certificate is stored in <code>config/certificate/ca.crt</code> and <code>config/certificate/ca.key</code>. Certificate for the webhook is <code>config/certificate/server.crt</code>, issued by the self-made CA. The domains of this certificate is &quot;webhook.domain.local&quot;(for external webhook) and &quot;casbin-webhook-svc.default.svc&quot;(for internal webhook)</p><p>Information about CA is passed to k8s via webhook configuration files. Both <code>config/webhook_external.yaml</code> and <code>config/webhook_internal.yaml</code> have a field called &quot;CABundle&quot;, whose content is base64 encoded string of the certificate of the CA.</p><p>In case that you need to change the certificate/domain (for example, maybe you want to put this webhook into another namespace of k8s while using internal webhook; or maybe you want to change a domain while using external webhook), the following procedures should be taken:</p><ol><li>Generate a new CA</li></ol><p>Generate the private key for the fake CA</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openssl genrsa -des3 -out ca.key </span><span class="token number" style="color:#36acaa">2048</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Remove the password protection of the private key.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openssl rsa -in ca.key -out ca.key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Generate a private key for webhook server</li></ol><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openssl genrsa -des3 -out server.key </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl rsa -in server.key  -out server.key </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>Use the self-generate CA to sign the certificate for webhook</li></ol><p>Copy your system&#x27;s openssl config file for temporary use. You can use <code>openssl version -a</code> to find out the location of the config file, ususally called  <code>openssl.cnf</code>.</p><p>Find the <!-- -->[<!-- -->req<!-- -->]<!-- --> paragraph and add the following line: <code>req_extensions = v3_req</code></p><p>Find the <!-- -->[<!-- -->v3_req<!-- -->]<!-- --> paragraph and add the following line: <code>subjectAltName = @alt_names</code></p><p>Append following lines to the file:</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token section punctuation" style="color:#393A34">[</span><span class="token section section-name selector" style="color:#00009f">alt_names</span><span class="token section punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key attr-name" style="color:#00a4db">DNS.2</span><span class="token punctuation" style="color:#393A34">=</span><span class="token value attr-value" style="color:#e3116c">&lt;The domain you want&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The &#x27;casbin-webhook-svc.default.svc&#x27; should be replaced with the real service name of your own service (if you decide to modify the service name)</p><p>Use the modified config file to generate a certificate request file</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openssl req -new -nodes -keyout server.key -out server.csr -config openssl.cnf </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Use the self-made CA to respond the request and sign the certificate</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openssl x509 -req -days </span><span class="token number" style="color:#36acaa">3650</span><span class="token plain"> -in server.csr -out server.crt -CA ca.crt  -CAkey ca.key -CAcreateserial -extensions v3_req -extensions SAN  -extfile openssl.cnf </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>Replace the &#x27;CABundle&#x27; field</li></ol><p>Both <code>config/webhook_external.yaml</code> and <code>config/webhook_internal.yaml</code> have a field called &quot;CABundle&quot;, whose content is base64 encoded string of the  certificate of the CA.</p><ol start="4"><li>If you are using helm, similar changes need to be applied to helm charts.</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="512-legal-certificates">5.1.2 Legal certificates<a class="hash-link" href="#512-legal-certificates" title="ç›´æ¥é“¾æ¥åˆ°æ ‡å¤´">â€‹</a></h4><p>If you uses legal certificates, you just don&#x27;t need all these procedures. Remove &quot;CABundle&quot; field in <code>config/webhook_external.yaml</code> and <code>config/webhook_internal.yaml</code>, and change the domain in these files to the domain you own.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://crowdin.com/project/casbin-website/zh-CN" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>ç¼–è¾‘æ­¤é¡µ</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="æ–‡æ¡£é¡µé¢å¯¼èˆª"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/docs/k8s"><div class="pagination-nav__sublabel">å¾€å‰</div><div class="pagination-nav__label">Kubernetesçš„æˆæƒ</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/docs/envoy"><div class="pagination-nav__sublabel">å¾€å</div><div class="pagination-nav__label">ä½¿ç”¨ Envoy å®ç° Service Mesh æƒé™ç®¡ç†</div></a></nav><br></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-æ¦‚è¿°-casbin-k8s-gatekeeper" class="table-of-contents__link toc-highlight">1. æ¦‚è¿° Casbin K8s-Gatekeeper</a><ul><li><a href="#01-ç®€å•çš„ä¾‹å­" class="table-of-contents__link toc-highlight">0.1 ç®€å•çš„ä¾‹å­</a></li><li><a href="#11-casbin-k8s-gatekeepeæ˜¯å¦‚ä½•è¿ä½œçš„" class="table-of-contents__link toc-highlight">1.1 Casbin K8s-gatekeepeæ˜¯å¦‚ä½•è¿ä½œçš„ï¼Ÿ</a></li><li><a href="#12-è¯´æ˜å…¶è¿ä½œæ–¹å¼çš„ä¸€ä¸ªä¾‹å­" class="table-of-contents__link toc-highlight">1.2 è¯´æ˜å…¶è¿ä½œæ–¹å¼çš„ä¸€ä¸ªä¾‹å­ã€‚</a></li></ul></li><li><a href="#2-å®‰è£…-k8s-gatekeeper" class="table-of-contents__link toc-highlight">2 å®‰è£… K8s-gatekeeper</a><ul><li><a href="#21-å†…éƒ¨webhook" class="table-of-contents__link toc-highlight">2.1 å†…éƒ¨webhook</a></li><li><a href="#22-å†…éƒ¨webhook" class="table-of-contents__link toc-highlight">2.2 å†…éƒ¨webhook</a></li><li><a href="#23-é€šè¿‡-helm-å®‰è£…-k8s-gatekeeper" class="table-of-contents__link toc-highlight">2.3 é€šè¿‡ helm å®‰è£… K8s-gatekeeper</a></li></ul></li><li><a href="#3-è¯•ç”¨k8s-gatekeeper" class="table-of-contents__link toc-highlight">3. è¯•ç”¨K8s-gatekeeper</a><ul><li><a href="#31-åˆ›å»ºcassbin-æ¨¡å‹å’Œç­–ç•¥" class="table-of-contents__link toc-highlight">3.1 åˆ›å»ºCassbin æ¨¡å‹å’Œç­–ç•¥</a></li><li><a href="#312-è¯•ç”¨k8s-gatekeeperæ˜¯å¦è¿ä½œ" class="table-of-contents__link toc-highlight">3.1.2 è¯•ç”¨K8s-gatekeeperæ˜¯å¦è¿ä½œ</a></li></ul></li><li><a href="#4-å¦‚ä½•å†™k8s-gatekeeperæ¨¡å‹å’Œç­–ç•¥" class="table-of-contents__link toc-highlight">4. å¦‚ä½•å†™K8s-gatekeeperæ¨¡å‹å’Œç­–ç•¥</a><ul><li><a href="#41-æ¨¡å‹çš„è¯·æ±‚å®šä¹‰" class="table-of-contents__link toc-highlight">4.1 æ¨¡å‹çš„è¯·æ±‚å®šä¹‰</a></li><li><a href="#42-æ¨¡å‹åŒ¹é…å™¨" class="table-of-contents__link toc-highlight">4.2 æ¨¡å‹åŒ¹é…å™¨</a></li><li><a href="#421-å¤–éƒ¨åŠŸèƒ½" class="table-of-contents__link toc-highlight">4.2.1 å¤–éƒ¨åŠŸèƒ½</a></li><li><a href="#4213-æ”¯æŒå¯å˜é•¿åº¦å‚æ•°çš„åŠŸèƒ½" class="table-of-contents__link toc-highlight">4.2.1.3 æ”¯æŒå¯å˜é•¿åº¦å‚æ•°çš„åŠŸèƒ½</a></li></ul></li><li><a href="#5-advanced-settings" class="table-of-contents__link toc-highlight">5. Advanced Settings</a><ul><li><a href="#51-about-certificates" class="table-of-contents__link toc-highlight">5.1 About Certificates</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">æ–‡æ¡£</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/get-started">å¼€å§‹ä½¿ç”¨</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/management-api">Management API</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/rbac-api">RBAC API</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/middlewares">Middlewares</a></li></ul></div><div class="col footer__col"><div class="footer__title">ç¤¾åŒº</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://forum.casbin.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">è®ºå›<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://stackoverflow.com/search?q=casbin" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitter.im/casbin/Lobby" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://shang.qq.com/wpa/qunwpa?idkey=8ac8b91fc97ace3d383d0035f7aa06f7d670fd8e8d4837347354a31c18fac885" target="_blank" rel="noopener noreferrer" class="footer__link-item">QQ ç¾¤<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">æ›´å¤š</div><ul class="footer__items clean-list"><li class="footer__item">
                <a href="https://github.com/casbin/casbin" target="_blank">
                  <img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/casbin/casbin?label=Casbin&style=social">
                </a>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <a href="https://github.com/casbin/jcasbin" target="_blank">
                  <img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/casbin/jcasbin?label=jCasbin&style=social">
                </a>
              </li><li class="footer__item">
                <a href="https://github.com/casbin/node-casbin" target="_blank">
                  <img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/casbin/node-casbin?label=Node-Casbin&style=social">
                </a>
                &nbsp;&nbsp;
                <a href="https://github.com/php-casbin/php-casbin" target="_blank">
                  <img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/php-casbin/php-casbin?label=PHP-Casbin&style=social">
                </a>
              </li><li class="footer__item">
                <a href="https://github.com/casbin/pycasbin" target="_blank">
                  <img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/casbin/pycasbin?label=PyCasbin&style=social">
                </a>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <a href="https://github.com/casbin/Casbin.NET" target="_blank">
                  <img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/casbin/Casbin.NET?label=Casbin.NET&style=social">
                </a>
              </li><li class="footer__item">
                <a href="https://github.com/casbin/casbin-cpp" target="_blank">
                  <img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/casbin/casbin-cpp?label=Casbin-CPP&style=social">
                </a>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <a href="https://github.com/casbin/casbin-rs" target="_blank">
                  <img alt="GitHub Repo stars" src="https://img.shields.io/github/stars/casbin/casbin-rs?label=Casbin-RS&style=social">
                </a>
              </li><li class="footer__item">
                <img alt="Twitter Follow" src="https://img.shields.io/twitter/follow/casbinHQ?style=social">
              </li><li class="footer__item">
<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?2c0ffc6f8d49e98d964d59d7aa4cbf34";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
</li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_BH7S" href="/zh/"><img src="/zh/img/casbin_min.svg" alt="Casbin Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/zh/img/casbin_min.svg" alt="Casbin Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">ç‰ˆæƒ Â© 2022 Casbin ç»„ç»‡</div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.40e10046.js"></script>
<script src="/zh/assets/js/main.6c9b915f.js"></script>
</body>
</html>