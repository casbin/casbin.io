"use strict";(globalThis.webpackChunkcasbin_website_v2=globalThis.webpackChunkcasbin_website_v2||[]).push([[4545],{3493(e){e.exports=JSON.parse('{"permalink":"/zh/blog/2021/08/19/apisix-casbin-authorization","editUrl":"https://github.com/casbin/casbin-website-v2/edit/master/i18n/zh/docusaurus-plugin-content-blog/2021-08-19-apisix-casbin-authorization.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2021-08-19-apisix-casbin-authorization.md","title":"Authorization in APISIX Using Casbin","description":"\u7b80\u4ecb","date":"2021-08-19T00:00:00.000Z","tags":[],"readingTime":3.9,"hasTruncateMarker":true,"authors":[{"name":"Rushikesh Tote","title":"Member of Casbin","url":"https://github.com/rushitote","imageURL":"https://avatars.githubusercontent.com/rushitote","key":"rushitote","page":null}],"frontMatter":{"title":"Authorization in APISIX Using Casbin","authors":["rushitote"]},"unlisted":false,"prevItem":{"title":"Understanding How Casbin Matching Works in Detail","permalink":"/zh/blog/2023/12/08/understanding-casbin-matching-in-detail"},"nextItem":{"title":"Yang Luo \u2014 Google Open Source Peer Bonus Winner","permalink":"/zh/blog/2020/04/21/google-award"}}')},5131(e,n,i){i.d(n,{A:()=>s});const s=i.p+"assets/images/model-1c0c2441dd19f8b957744635985283eb.png"},7588(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var s=i(3493),t=i(4848),a=i(8453);const o={title:"Authorization in APISIX Using Casbin",authors:["rushitote"]},r=void 0,c={authorsImageUrls:[void 0]},l=[{value:"\u7b80\u4ecb",id:"\u7b80\u4ecb",level:2},{value:"\u521b\u5efa\u6a21\u578b",id:"\u521b\u5efa\u6a21\u578b",level:2},{value:"\u521b\u5efa\u7b56\u7565",id:"\u521b\u5efa\u7b56\u7565",level:2},{value:"Enabling the plugin on a route",id:"enabling-the-plugin-on-a-route",level:2},{value:"Using a global model and policy",id:"using-a-global-model-and-policy",level:2},{value:"Use cases",id:"use-cases",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"\u7b80\u4ecb",children:"\u7b80\u4ecb"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://apisix.apache.org/",children:"APISIX"})," is a high-performance, scalable, cloud-native API gateway built on Nginx and etcd, and an Apache Software Foundation project. It ships with many plugins for authentication, monitoring, routing, and more. Plugins are hot-reloaded without restarts, so you can change behavior on the fly."]}),"\n",(0,t.jsxs)(n.p,{children:["When you need ",(0,t.jsx)(n.strong,{children:"authorization"})," beyond simple checks, the ",(0,t.jsx)(n.strong,{children:"authz-casbin"})," plugin can help. It is an APISIX plugin built on ",(0,t.jsx)(n.a,{href:"https://github.com/casbin/lua-casbin/",children:"Lua Casbin"})," that enforces flexible authorization using models such as ACL, RBAC, and ABAC. ",(0,t.jsx)(n.a,{href:"/",children:"Casbin"})," is an authorization library (originally in Go, now ported to many languages); Lua Casbin is the Lua port. We proposed the plugin in the APISIX repo (",(0,t.jsx)(n.a,{href:"https://github.com/apache/apisix/issues/4674",children:"#4674"}),"); after review and improvements, it was merged (",(0,t.jsx)(n.a,{href:"https://github.com/apache/apisix/pull/4710",children:"#4710"}),")."]}),"\n",(0,t.jsxs)(n.p,{children:["This post shows how to implement ",(0,t.jsx)(n.strong,{children:"Role-Based Access Control (RBAC)"})," in APISIX using authz-casbin."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note:"})," Casbin handles ",(0,t.jsx)(n.strong,{children:"authorization"})," only. Use another plugin or your own logic for ",(0,t.jsx)(n.strong,{children:"authentication"})," (identifying the user)."]}),"\n",(0,t.jsx)(n.h2,{id:"\u521b\u5efa\u6a21\u578b",children:"\u521b\u5efa\u6a21\u578b"}),"\n",(0,t.jsxs)(n.p,{children:["The plugin authorizes each request using three parameters: ",(0,t.jsx)(n.strong,{children:"subject"}),", ",(0,t.jsx)(n.strong,{children:"object"}),", and ",(0,t.jsx)(n.strong,{children:"action"}),". The subject comes from a header (e.g. ",(0,t.jsx)(n.code,{children:"username: alice"}),"), the object is the URL path, and the action is the HTTP method."]}),"\n",(0,t.jsxs)(n.p,{children:["Suppose we have three paths: ",(0,t.jsx)(n.code,{children:"/"}),", ",(0,t.jsx)(n.code,{children:"/res1"}),", and ",(0,t.jsx)(n.code,{children:"/res2"}),". We want a model like this:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"\u56fe\u50cf",src:i(5131).A+"",width:"4520",height:"1720"})}),"\n",(0,t.jsxs)(n.p,{children:["So: any user (e.g. ",(0,t.jsx)(n.code,{children:"jack"}),") can access ",(0,t.jsx)(n.code,{children:"/"}),"; users with the ",(0,t.jsx)(n.code,{children:"admin"})," role (e.g. ",(0,t.jsx)(n.code,{children:"alice"}),", ",(0,t.jsx)(n.code,{children:"bob"}),") can access everything; and non-admin users are limited to ",(0,t.jsx)(n.code,{children:"GET"}),". Here is a model that does that:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ini",children:"[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = (g(r.sub, p.sub) || keyMatch(r.sub, p.sub)) && keyMatch(r.obj, p.obj) && keyMatch(r.act, p.act)\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u521b\u5efa\u7b56\u7565",children:"\u521b\u5efa\u7b56\u7565"}),"\n",(0,t.jsx)(n.p,{children:"For the scenario above, the policy could be:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csv",children:"p, *, /, GET\np, admin, *, *\ng, alice, admin\ng, bob, admin\n"})}),"\n",(0,t.jsx)(n.p,{children:"The matcher means:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"(g(r.sub, p.sub) || keyMatch(r.sub, p.sub))"})})," \u2014 The request subject either has the policy subject as a role or matches it via ",(0,t.jsx)(n.code,{children:"keyMatch"}),". For ",(0,t.jsx)(n.code,{children:"keyMatch"})," and other built-ins, see ",(0,t.jsx)(n.a,{href:"https://github.com/casbin/lua-casbin/blob/master/src/util/BuiltInFunctions.lua",children:"Lua Casbin BuiltInFunctions"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"keyMatch(r.obj, p.obj)"})})," \u2014 The request path matches the policy object."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"keyMatch(r.act, p.act)"})})," \u2014 The request method matches the policy action."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"enabling-the-plugin-on-a-route",children:"Enabling the plugin on a route"}),"\n",(0,t.jsxs)(n.p,{children:["After creating the model and policy, enable the plugin on a route via the APISIX Admin API. Using ",(0,t.jsx)(n.strong,{children:"file paths"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:'curl http://127.0.0.1:9080/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "plugins": {\n        "authz-casbin": {\n            "model_path": "/path/to/model.conf",\n            "policy_path": "/path/to/policy.csv",\n            "username": "username"\n        }\n    },\n    "upstream": {\n        "nodes": {\n            "127.0.0.1:1980": 1\n        },\n        "type": "roundrobin"\n    },\n    "uri": "/*"\n}\'\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"username"})," field is the ",(0,t.jsx)(n.strong,{children:"header name"})," that carries the subject (e.g. if the header is ",(0,t.jsx)(n.code,{children:"user: alice"}),", set ",(0,t.jsx)(n.code,{children:'"username": "user"'}),")."]}),"\n",(0,t.jsxs)(n.p,{children:["To use ",(0,t.jsx)(n.strong,{children:"inline"})," model and policy text instead of files, use the ",(0,t.jsx)(n.code,{children:"model"})," and ",(0,t.jsx)(n.code,{children:"policy"})," fields:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:'curl http://127.0.0.1:9080/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "plugins": {\n        "authz-casbin": {\n            "model": "[request_definition]\n            r = sub, obj, act\n\n            [policy_definition]\n            p = sub, obj, act\n\n            [role_definition]\n            g = _, _\n\n            [policy_effect]\n            e = some(where (p.eft == allow))\n\n            [matchers]\n            m = (g(r.sub, p.sub) || keyMatch(r.sub, p.sub)) && keyMatch(r.obj, p.obj) && keyMatch(r.act, p.act)",\n\n            "policy": "p, *, /, GET\n            p, admin, *, *\n            g, alice, admin\n            g, bob, admin",\n\n            "username": "username"\n        }\n    },\n    "upstream": {\n        "nodes": {\n            "127.0.0.1:1980": 1\n        },\n        "type": "roundrobin"\n    },\n    "uri": "/*"\n}\'\n'})}),"\n",(0,t.jsx)(n.h2,{id:"using-a-global-model-and-policy",children:"Using a global model and policy"}),"\n",(0,t.jsxs)(n.p,{children:["To use one model and policy for ",(0,t.jsx)(n.strong,{children:"all"})," routes, store them in the plugin\u2019s metadata. Send a ",(0,t.jsx)(n.code,{children:"PUT"})," request:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:'curl http://127.0.0.1:9080/apisix/admin/plugin_metadata/authz-casbin -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -i -X PUT -d \'\n{\n"model": "[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = (g(r.sub, p.sub) || keyMatch(r.sub, p.sub)) && keyMatch(r.obj, p.obj) && keyMatch(r.act, p.act)",\n\n"policy": "p, *, /, GET\np, admin, *, *\ng, alice, admin\ng, bob, admin"\n}\'\n'})}),"\n",(0,t.jsx)(n.p,{children:"Then enable the plugin on a route (it will use the metadata). Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sh",children:'curl http://127.0.0.1:9080/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "plugins": {\n        "authz-casbin": {\n            "username": "username"\n        }\n    },\n    "upstream": {\n        "nodes": {\n            "127.0.0.1:1980": 1\n        },\n        "type": "roundrobin"\n    },\n    "uri": "/route1/*"\n}\'\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The route then uses the shared model and policy from metadata. To change them, send another ",(0,t.jsx)(n.code,{children:"PUT"})," to the plugin metadata; all routes using it will pick up the update."]}),"\n",(0,t.jsx)(n.h2,{id:"use-cases",children:"Use cases"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Per-route authorization"})," \u2014 Attach the plugin to any route with your model and policy. Good when different routes need different permissions or when policies are large (each route only loads what it needs)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Global model/policy"})," \u2014 Store one model and policy in plugin metadata and reference it from many routes. Updating policy in one place (e.g. etcd) updates all those routes."]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453(e,n,i){i.d(n,{R:()=>o,x:()=>r});var s=i(6540);const t={},a=s.createContext(t);function o(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);