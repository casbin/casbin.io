"use strict";(self.webpackChunkcasbin_website_v2=self.webpackChunkcasbin_website_v2||[]).push([[8006],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,s=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=u(n),m=i,k=d["".concat(l,".").concat(m)]||d[m]||c[m]||s;return n?a.createElement(k,r(r({ref:t},p),{},{components:n})):a.createElement(k,r({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var s=n.length,r=new Array(s);r[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:i,r[1]=o;for(var u=2;u<s;u++)r[u]=n[u];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1093:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>s,metadata:()=>o,toc:()=>u});var a=n(7462),i=(n(7294),n(3905));const s={id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC & ABAC Middleware d'autorisation bas\xe9 sur Casbin",keywords:["k8s-gatekeeper","Kubernetes","K8s"],authors:["ComradeProgrammer"]},r=void 0,o={unversionedId:"k8s-gatekeeper",id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC & ABAC Middleware d'autorisation bas\xe9 sur Casbin",source:"@site/i18n/fr/docusaurus-plugin-content-docs/current/K8sGateKeeper.mdx",sourceDirName:".",slug:"/k8s-gatekeeper",permalink:"/fr/docs/k8s-gatekeeper",draft:!1,editUrl:"https://github.com/casbin/casbin-website-v2/edit/master/docs/K8sGateKeeper.mdx",tags:[],version:"current",frontMatter:{id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC & ABAC Middleware d'autorisation bas\xe9 sur Casbin",keywords:["k8s-gatekeeper","Kubernetes","K8s"],authors:["ComradeProgrammer"]},sidebar:"docs",previous:{title:"Authorization of Kubernetes",permalink:"/fr/docs/k8s"},next:{title:"Authorization of Service Mesh through Envoy",permalink:"/fr/docs/envoy"}},l={},u=[{value:"1. Aper\xe7u &amp; Documents pour Casbin K8s-Gatekeeper",id:"1-aper\xe7u--documents-pour-casbin-k8s-gatekeeper",level:2},{value:"0.1 Un exemple simple",id:"01-un-exemple-simple",level:3},{value:"1.1 Comment fonctionne Casbin K8s-Gatekeeper ?",id:"11-comment-fonctionne-casbin-k8s-gatekeeper-",level:3},{value:"1.2 Un exemple illustrant comment cela fonctionne",id:"12-un-exemple-illustrant-comment-cela-fonctionne",level:3},{value:"2 Installer K8s-gatekeeper",id:"2-installer-k8s-gatekeeper",level:2},{value:"2.1 Webhook interne",id:"21-webhook-interne",level:3},{value:"2.1.1 \xc9tape 1 : Construire l&#39;image",id:"211-\xe9tape-1--construire-limage",level:4},{value:"2.1.2 \xc9tape 2 : Configurer les services et les d\xe9ploiements pour K8s-gatekeeper",id:"212-\xe9tape-2--configurer-les-services-et-les-d\xe9ploiements-pour-k8s-gatekeeper",level:4},{value:"2.1.3 \xc9tape 3 : Installer les ressources CRD pour K8s-gatekeeper",id:"213-\xe9tape-3--installer-les-ressources-crd-pour-k8s-gatekeeper",level:4},{value:"2.2 Webhook externe",id:"22-webhook-externe",level:3},{value:"2.3 Installer K8s-gatekeeper via Helm",id:"23-installer-k8s-gatekeeper-via-helm",level:3},{value:"2.3.1 \xc9tape 1 : Construire l&#39;image",id:"231-\xe9tape-1--construire-limage",level:4},{value:"2.3.2 Installation Helm",id:"232-installation-helm",level:4},{value:"3. Essayez K8s-gatekeeper",id:"3-essayez-k8s-gatekeeper",level:2},{value:"3.1 Cr\xe9er un mod\xe8le et une politique Casbin",id:"31-cr\xe9er-un-mod\xe8le-et-une-politique-casbin",level:3},{value:"3.1.1 Cr\xe9er/Mettre \xe0 jour le mod\xe8le et la politique Casbin via kubectl",id:"311-cr\xe9ermettre-\xe0-jour-le-mod\xe8le-et-la-politique-casbin-via-kubectl",level:4},{value:"3.1.2 Create/Update Casbin Model and Policy via the go-client we provide",id:"312-createupdate-casbin-model-and-policy-via-the-go-client-we-provide",level:4},{value:"3.1.2 Try Whether K8s-gatekeeper Works",id:"312-try-whether-k8s-gatekeeper-works",level:3},{value:"4. How to Write Model and Policy with K8s-gatekeeper",id:"4-how-to-write-model-and-policy-with-k8s-gatekeeper",level:2},{value:"4.1 Request Definition of Model",id:"41-request-definition-of-model",level:3},{value:"4.2 Correspondances du mod\xe8le",id:"42-correspondances-du-mod\xe8le",level:3},{value:"4.2.1 Fonctions d&#39;extension",id:"421-fonctions-dextension",level:3},{value:"4.2.1.1 acc\xe8s",id:"4211-acc\xe8s",level:4},{value:"4.2.1.2 accessWithWildcard",id:"4212-accesswithwildcard",level:4},{value:"4.2.1.3 Fonctions prenant en charge les arguments de longueur variable",id:"4213-fonctions-prenant-en-charge-les-arguments-de-longueur-variable",level:3},{value:"4.2.1.2 Fonctions de conversion de type",id:"4212-fonctions-de-conversion-de-type",level:4},{value:"5. Param\xe8tres avanc\xe9s",id:"5-param\xe8tres-avanc\xe9s",level:2},{value:"5.1 \xc0 propos des certificats",id:"51-\xe0-propos-des-certificats",level:3},{value:"5.1.1 Certificats auto-sign\xe9s",id:"511-certificats-auto-sign\xe9s",level:4},{value:"5.1.2 Certificats l\xe9gaux",id:"512-certificats-l\xe9gaux",level:4}],p={toc:u};function c(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"1-aper\xe7u--documents-pour-casbin-k8s-gatekeeper"},"1. Aper\xe7u & Documents pour Casbin K8s-Gatekeeper"),(0,i.kt)("p",null,"Casbin K8s-GateKeeper est un webhook d'admission Kubernetes qui int\xe8gre Casbin comme outil de contr\xf4le d'acc\xe8s. En utilisant Casbin K8s-GateKeeper, vous pouvez \xe9tablir des r\xe8gles flexibles pour autoriser ou intercepter toute op\xe9ration sur les ressources K8s, SANS \xe9crire un seul morceau de code, mais seulement quelques lignes de configurations d\xe9claratives de mod\xe8les et de politiques Casbin, qui font partie du langage ACL (Access Control List) de Casbin."),(0,i.kt)("p",null,"Casbin K8s-GateKeeper est d\xe9velopp\xe9 et maintenu par la communaut\xe9 Casbin. Le d\xe9p\xf4t de ce projet est disponible ici : ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/casbin/k8s-gatekeeper"},"https://github.com/casbin/k8s-gatekeeper")),(0,i.kt)("h3",{id:"01-un-exemple-simple"},"0.1 Un exemple simple"),(0,i.kt)("p",null,"Par exemple, vous n'avez pas besoin d'\xe9crire de code, mais utilisez les lignes de configuration suivantes pour r\xe9aliser cette fonction : \"Interdire l'utilisation d'images avec certains tags sp\xe9cifi\xe9s dans tous les d\xe9ploiements\" :"),(0,i.kt)("p",null,"Model:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini"},'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\ncontain(split(accessWithWildcard(${OBJECT}.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n')),(0,i.kt)("p",null,"And Policy:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csv"},'p, "1.14.1",deny\n')),(0,i.kt)("p",null,"Ceux-ci sont en langage ACL ordinaire de Casbin. Supposons que vous ayez d\xe9j\xe0 lu des chapitres \xe0 leur sujet, il sera tr\xe8s facile de comprendre."),(0,i.kt)("p",null,"Casbin K8s-Gatekeeper a les avantages suivants :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Facile \xe0 utiliser. \xc9crire plusieurs lignes d'ACL est bien mieux que d'\xe9crire beaucoup de code."),(0,i.kt)("li",{parentName:"ul"},"Il permet des mises \xe0 jour \xe0 chaud des configurations. Vous n'avez pas besoin de fermer l'ensemble du plugin pour modifier les configurations."),(0,i.kt)("li",{parentName:"ul"},"Il est flexible. Des r\xe8gles arbitraires peuvent \xeatre faites sur n'importe quelle ressource K8s, qui peuvent \xeatre explor\xe9es avec ",(0,i.kt)("inlineCode",{parentName:"li"},"kubectl gatekeeper"),"."),(0,i.kt)("li",{parentName:"ul"},"Il simplifie la mise en \u0153uvre du webhook d'admission K8s, qui est tr\xe8s compliqu\xe9. Vous n'avez pas besoin de savoir ce qu'est un webhook d'admission K8s ou comment \xe9crire du code pour cela. Tout ce que vous avez \xe0 faire est de conna\xeetre la ressource sur laquelle vous voulez mettre des contraintes et ensuite \xe9crire l'ACL de Casbin. Tout le monde sait que K8s est complexe, mais en utilisant Casbin K8s-Gatekeeper, votre temps peut \xeatre \xe9conomis\xe9."),(0,i.kt)("li",{parentName:"ul"},"Il est maintenu par la communaut\xe9 Casbin. N'h\xe9sitez pas \xe0 nous contacter si quelque chose \xe0 propos de ce plugin vous confond ou si vous rencontrez des probl\xe8mes lors de son essai.")),(0,i.kt)("h3",{id:"11-comment-fonctionne-casbin-k8s-gatekeeper-"},"1.1 Comment fonctionne Casbin K8s-Gatekeeper ?"),(0,i.kt)("p",null,"K8s-Gatekeeper est un webhook d'admission pour K8s qui utilise ",(0,i.kt)("a",{parentName:"p",href:"/docs/overview"},"Casbin")," pour appliquer des r\xe8gles de contr\xf4le d'acc\xe8s d\xe9finies par l'utilisateur pour aider \xe0 pr\xe9venir toute op\xe9ration sur K8s que l'administrateur ne souhaite pas."),(0,i.kt)("p",null,"Casbin est une biblioth\xe8que de contr\xf4le d'acc\xe8s open-source puissante et efficace. Il fournit un support pour l'application de l'autorisation bas\xe9e sur divers mod\xe8les de contr\xf4le d'acc\xe8s. Pour plus de d\xe9tails sur Casbin, voir ",(0,i.kt)("a",{parentName:"p",href:"/docs/overview"},"Aper\xe7u"),"."),(0,i.kt)("p",null,"Les webhooks d'admission dans K8s sont des callbacks HTTP qui re\xe7oivent des 'demandes d'admission' et font quelque chose avec elles. En particulier, K8s-Gatekeeper est un type sp\xe9cial de webhook d'admission : 'ValidatingAdmissionWebhook', qui peut d\xe9cider d'accepter ou de rejeter cette demande d'admission ou non. Quant aux demandes d'admission, ce sont des requ\xeates HTTP d\xe9crivant une op\xe9ration sur des ressources sp\xe9cifi\xe9es de K8s (par exemple, la cr\xe9ation/suppression d'un d\xe9ploiement). Pour en savoir plus sur les webhooks d'admission, consultez la ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#what-are-admission-webhooks"},"documentation officielle de K8s"),"."),(0,i.kt)("h3",{id:"12-un-exemple-illustrant-comment-cela-fonctionne"},"1.2 Un exemple illustrant comment cela fonctionne"),(0,i.kt)("p",null,"Par exemple, lorsque quelqu'un veut cr\xe9er un d\xe9ploiement contenant un pod ex\xe9cutant nginx (en utilisant kubectl ou les clients K8s), K8s g\xe9n\xe9rera une demande d'admission, qui (si elle est traduite en format YAML) peut ressembler \xe0 ceci :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-deployment\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.14.1\n        ports:\n        - containerPort: 80\n")),(0,i.kt)("p",null,"Cette demande passera par le processus de tous les intergiciels montr\xe9s dans l'image, y compris notre K8s-Gatekeeper. K8s-Gatekeeper peut d\xe9tecter tous les ex\xe9cuteurs Casbin stock\xe9s dans l'etcd de K8s, qui est cr\xe9\xe9 et maintenu par l'utilisateur (via ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl")," ou le client Go que nous fournissons). Chaque ex\xe9cuteur contient un mod\xe8le Casbin et une politique Casbin. La demande d'admission sera trait\xe9e par chaque ex\xe9cuteur, un par un, et seule une demande passant tous les ex\xe9cuteurs peut \xeatre accept\xe9e par ce K8s-Gatekeeper."),(0,i.kt)("p",null,"(Si vous ne comprenez pas ce qu'est un ex\xe9cuteur, un mod\xe8le ou une politique Casbin, consultez ce document : ",(0,i.kt)("a",{parentName:"p",href:"/docs/get-started"},"Commencer"),")."),(0,i.kt)("p",null,"Par exemple, pour une raison quelconque, l'administrateur veut interdire l'apparition de l'image 'nginx:1.14.1' tout en autorisant 'nginx:1.3.1'. Un ex\xe9cuteur contenant la r\xe8gle et la politique suivantes peut \xeatre cr\xe9\xe9 (Nous expliquerons comment cr\xe9er un ex\xe9cuteur, ce que sont ces mod\xe8les et politiques, et comment les \xe9crire dans les chapitres suivants)."),(0,i.kt)("p",null,"Model:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini"},'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n\n')),(0,i.kt)("p",null,"Policy:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csv"},'p, "nginx:1.13.1",allow\np, "nginx:1.14.1",deny\n')),(0,i.kt)("p",null,"En cr\xe9ant un ex\xe9cuteur contenant le mod\xe8le et la politique ci-dessus, la demande d'admission pr\xe9c\xe9dente sera rejet\xe9e par cet ex\xe9cuteur, ce qui signifie que K8s ne cr\xe9era pas ce d\xe9ploiement."),(0,i.kt)("h2",{id:"2-installer-k8s-gatekeeper"},"2 Installer K8s-gatekeeper"),(0,i.kt)("p",null,"Il existe trois m\xe9thodes disponibles pour installer K8s-gatekeeper : External webhook, Internal webhook, et Helm."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"Note : Ces m\xe9thodes sont uniquement destin\xe9es aux utilisateurs qui souhaitent essayer K8s-gatekeeper et ne sont pas s\xe9curis\xe9es. Si vous souhaitez l'utiliser dans un environnement productif, veuillez vous assurer que vous lisez ",(0,i.kt)("a",{parentName:"p",href:"#5-advanced-settings"},"Chapitre 5. Param\xe8tres avanc\xe9s")," et effectuez les modifications n\xe9cessaires avant l'installation.")),(0,i.kt)("h3",{id:"21-webhook-interne"},"2.1 Webhook interne"),(0,i.kt)("h4",{id:"211-\xe9tape-1--construire-limage"},"2.1.1 \xc9tape 1 : Construire l'image"),(0,i.kt)("p",null,"Pour la m\xe9thode de webhook interne, le webhook lui-m\xeame sera mis en \u0153uvre en tant que service au sein de Kubernetes. Pour cr\xe9er le service et le d\xe9ploiement n\xe9cessaires, vous devez construire une image de K8s-gatekeeper. Vous pouvez construire votre propre image en ex\xe9cutant la commande suivante :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"docker build --target webhook -t k8s-gatekeeper .\n")),(0,i.kt)("p",null,"Cette commande cr\xe9era une image locale appel\xe9e 'k8s-gatekeeper:latest'."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"Note : Si vous utilisez minikube, veuillez ex\xe9cuter ",(0,i.kt)("inlineCode",{parentName:"p"},"eval $(minikube -p minikube docker-env)")," avant d'ex\xe9cuter 'docker build'.")),(0,i.kt)("h4",{id:"212-\xe9tape-2--configurer-les-services-et-les-d\xe9ploiements-pour-k8s-gatekeeper"},"2.1.2 \xc9tape 2 : Configurer les services et les d\xe9ploiements pour K8s-gatekeeper"),(0,i.kt)("p",null,"Ex\xe9cutez les commandes suivantes :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f config/rbac.yaml\nkubectl apply -f config/webhook_deployment.yaml \nkubectl apply -f config/webhook_internal.yaml \n")),(0,i.kt)("p",null,"Cela commencera \xe0 ex\xe9cuter K8s-gatekeeper, et vous pouvez le confirmer en ex\xe9cutant ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl get pods"),"."),(0,i.kt)("h4",{id:"213-\xe9tape-3--installer-les-ressources-crd-pour-k8s-gatekeeper"},"2.1.3 \xc9tape 3 : Installer les ressources CRD pour K8s-gatekeeper"),(0,i.kt)("p",null,"Ex\xe9cutez les commandes suivantes :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\n")),(0,i.kt)("h3",{id:"22-webhook-externe"},"2.2 Webhook externe"),(0,i.kt)("p",null,"Pour la m\xe9thode de webhook externe, K8s-gatekeeper sera ex\xe9cut\xe9 en dehors de Kubernetes, et Kubernetes acc\xe9dera \xe0 K8s-gatekeeper comme il acc\xe9derait \xe0 un site web ordinaire. Kubernetes a une exigence obligatoire que le webhook d'admission doit \xeatre HTTPS. Dans le but d'essayer K8s-gatekeeper, nous avons fourni un ensemble de certificats et une cl\xe9 priv\xe9e (bien que cela ne soit pas s\xe9curis\xe9). Si vous pr\xe9f\xe9rez utiliser votre propre certificat, veuillez vous r\xe9f\xe9rer au ",(0,i.kt)("a",{parentName:"p",href:"#5-param%C3%A8tres-avanc%C3%A9s"},"Chapitre 5. Param\xe8tres avanc\xe9s")," pour des instructions sur l'ajustement du certificat et de la cl\xe9 priv\xe9e."),(0,i.kt)("p",null,"Le certificat que nous fournissons est \xe9mis pour 'webhook.domain.local'. Donc, modifiez l'h\xf4te (par exemple, /etc/hosts) et pointez 'webhook.domain.local' vers l'adresse IP sur laquelle K8s-gatekeeper est en cours d'ex\xe9cution."),(0,i.kt)("p",null,"Puis ex\xe9cutez la commande suivante :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"go mod tidy\ngo mod vendor\ngo run cmd/webhook/main.go\nkubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\nkubectl apply -f config/webhook_external.yaml \n")),(0,i.kt)("h3",{id:"23-installer-k8s-gatekeeper-via-helm"},"2.3 Installer K8s-gatekeeper via Helm"),(0,i.kt)("h4",{id:"231-\xe9tape-1--construire-limage"},"2.3.1 \xc9tape 1 : Construire l'image"),(0,i.kt)("p",null,"Veuillez vous r\xe9f\xe9rer au ",(0,i.kt)("a",{parentName:"p",href:"#211-%C3%A9tape-1-construire-l'image"},"Chapitre 2.1.1"),"."),(0,i.kt)("h4",{id:"232-installation-helm"},"2.3.2 Installation Helm"),(0,i.kt)("p",null,"Ex\xe9cutez la commande ",(0,i.kt)("inlineCode",{parentName:"p"},"helm install k8sgatekeeper ./k8sgatekeeper"),"."),(0,i.kt)("h2",{id:"3-essayez-k8s-gatekeeper"},"3. Essayez K8s-gatekeeper"),(0,i.kt)("h3",{id:"31-cr\xe9er-un-mod\xe8le-et-une-politique-casbin"},"3.1 Cr\xe9er un mod\xe8le et une politique Casbin"),(0,i.kt)("p",null,"Vous avez deux m\xe9thodes pour cr\xe9er un mod\xe8le et une politique : via kubectl ou via le client-go que nous fournissons."),(0,i.kt)("h4",{id:"311-cr\xe9ermettre-\xe0-jour-le-mod\xe8le-et-la-politique-casbin-via-kubectl"},"3.1.1 Cr\xe9er/Mettre \xe0 jour le mod\xe8le et la politique Casbin via kubectl"),(0,i.kt)("p",null,"Dans K8s-gatekeeper, le mod\xe8le Casbin est stock\xe9 dans une ressource CRD appel\xe9e 'CasbinModel'. Sa d\xe9finition se trouve dans ",(0,i.kt)("inlineCode",{parentName:"p"},"config/auth.casbin.org_casbinmodels.yaml"),"."),(0,i.kt)("p",null,"Il y a des exemples dans ",(0,i.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/model.yaml"),". Faites attention aux champs suivants :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"metadata.name: le nom du mod\xe8le. Ce nom DOIT \xeatre le m\xeame que le nom de l'objet CasbinPolicy li\xe9 \xe0 ce mod\xe8le, afin que K8s-gatekeeper puisse les associer et cr\xe9er un ex\xe9cuteur."),(0,i.kt)("li",{parentName:"ul"},'spec.enable: si ce champ est d\xe9fini sur "false", ce mod\xe8le (ainsi que l\'objet CasbinPolicy li\xe9 \xe0 ce mod\xe8le) sera ignor\xe9.'),(0,i.kt)("li",{parentName:"ul"},"spec.modelText: une cha\xeene qui contient le texte du mod\xe8le d'un mod\xe8le Casbin.")),(0,i.kt)("p",null,"La politique Casbin est stock\xe9e dans une autre ressource CRD appel\xe9e 'CasbinPolicy', dont la d\xe9finition peut \xeatre trouv\xe9e dans ",(0,i.kt)("inlineCode",{parentName:"p"},"config/auth.casbin.org_casbinpolicies.yaml"),"."),(0,i.kt)("p",null,"Il y a des exemples dans ",(0,i.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/policy.yaml"),". Faites attention aux champs suivants :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"metadata.name: the name of the policy. This name MUST be the same as the name of the CasbinModel object related to this policy, so that K8s-gatekeeper can pair them and create an enforcer."),(0,i.kt)("li",{parentName:"ul"},"spec.policyItem: a string that contains the policy text of a Casbin model.")),(0,i.kt)("p",null,"After creating your own CasbinModel and CasbinPolicy files, use the following command to apply them:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f <filename>\n")),(0,i.kt)("p",null,"Once a pair of CasbinModel and CasbinPolicy is created, K8s-gatekeeper will be able to detect it within 5 seconds."),(0,i.kt)("h4",{id:"312-createupdate-casbin-model-and-policy-via-the-go-client-we-provide"},"3.1.2 Create/Update Casbin Model and Policy via the go-client we provide"),(0,i.kt)("p",null,"We understand that there may be situations where it is not convenient to use the shell to execute commands directly on a node of the K8s cluster, such as when you are building an automatic cloud platform for your corporation. Therefore, we have developed a go-client to create and maintain CasbinModel and CasbinPolicy."),(0,i.kt)("p",null,"The go-client library is located in ",(0,i.kt)("inlineCode",{parentName:"p"},"pkg/client"),"."),(0,i.kt)("p",null,"In ",(0,i.kt)("inlineCode",{parentName:"p"},"client.go"),", we provide a function to create a client."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"func NewK8sGateKeeperClient(externalClient bool) (*K8sGateKeeperClient, error) \n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"externalClient")," parameter determines whether K8s-gatekeeper is running inside the K8s cluster or not."),(0,i.kt)("p",null,"In ",(0,i.kt)("inlineCode",{parentName:"p"},"model.go"),", we provide various functions to create, delete, and modify CasbinModel. You can find out how to use these interfaces in ",(0,i.kt)("inlineCode",{parentName:"p"},"model_test.go"),"."),(0,i.kt)("p",null,"In ",(0,i.kt)("inlineCode",{parentName:"p"},"policy.go"),", we provide various functions to create, delete, and modify CasbiPolicy. You can find out how to use these interfaces in ",(0,i.kt)("inlineCode",{parentName:"p"},"policy_test.go"),"."),(0,i.kt)("h3",{id:"312-try-whether-k8s-gatekeeper-works"},"3.1.2 Try Whether K8s-gatekeeper Works"),(0,i.kt)("p",null,"Suppose you have already created the exact model and policy in ",(0,i.kt)("inlineCode",{parentName:"p"},"example/allowed_repo"),". Now, try the following command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f example/allowed_repo/testcase/reject_1.yaml\n")),(0,i.kt)("p",null,"You should find that K8s will reject this request and mention that the webhook was the reason why this request is rejected. However, when you try to apply ",(0,i.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/testcase/approve_2.yaml"),", it will be accepted."),(0,i.kt)("h2",{id:"4-how-to-write-model-and-policy-with-k8s-gatekeeper"},"4. How to Write Model and Policy with K8s-gatekeeper"),(0,i.kt)("p",null,"First of all, make sure you are familiar with the basic grammar of Casbin Models and Policies. If you are not, please read the ",(0,i.kt)("a",{parentName:"p",href:"/docs/get-started"},"Get Started")," section first. In this chapter, we assume that you already understand what Casbin Models and Policies are."),(0,i.kt)("h3",{id:"41-request-definition-of-model"},"4.1 Request Definition of Model"),(0,i.kt)("p",null,"When K8s-gatekeeper is authorizing a request, the input is always an object: the Go object of the Admission Request. This means that the enforcer will always be used like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"ok, err := enforcer.Enforce(admission)\n")),(0,i.kt)("p",null,"where ",(0,i.kt)("inlineCode",{parentName:"p"},"admission")," is an ",(0,i.kt)("inlineCode",{parentName:"p"},"AdmissionReview")," object defined by K8s's official go api ",(0,i.kt)("inlineCode",{parentName:"p"},'"k8s.io/api/admission/v1"'),". You can find the definition of this struct in this repository: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/api/blob/master/admission/v1/types.go"},"https://github.com/kubernetes/api/blob/master/admission/v1/types.go"),". Pour plus d'informations, vous pouvez \xe9galement vous r\xe9f\xe9rer \xe0 ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response"},"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response"),"."),(0,i.kt)("p",null,"Par cons\xe9quent, pour tout mod\xe8le utilis\xe9 par K8s-gatekeeper, la d\xe9finition de ",(0,i.kt)("inlineCode",{parentName:"p"},"request_definition")," devrait toujours \xeatre comme ceci :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini"},"    [request_definition]\n    r =  obj\n")),(0,i.kt)("p",null,"Le nom 'obj' n'est pas obligatoire, tant que le nom est coh\xe9rent avec le nom utilis\xe9 dans la partie ",(0,i.kt)("inlineCode",{parentName:"p"},"[matchers]"),"."),(0,i.kt)("h3",{id:"42-correspondances-du-mod\xe8le"},"4.2 Correspondances du mod\xe8le"),(0,i.kt)("p",null,"Vous \xeates cens\xe9 utiliser la fonctionnalit\xe9 ABAC de Casbin pour \xe9crire vos r\xe8gles. Cependant, l'\xe9valuateur d'expression int\xe9gr\xe9 dans Casbin ne prend pas en charge l'indexation dans les cartes ou les tableaux (tranches), ni l'expansion des tableaux. Par cons\xe9quent, K8s-gatekeeper fournit diverses 'fonctions Casbin' en tant qu'extensions pour impl\xe9menter ces fonctionnalit\xe9s. Si vous constatez toujours que votre demande ne peut \xeatre satisfaite par ces extensions, n'h\xe9sitez pas \xe0 ouvrir un probl\xe8me, ou \xe0 cr\xe9er une demande de tirage."),(0,i.kt)("p",null,"Si vous n'\xeates pas familier avec les fonctions Casbin, vous pouvez vous r\xe9f\xe9rer \xe0 ",(0,i.kt)("a",{parentName:"p",href:"/docs/function"},"Function")," pour plus d'informations."),(0,i.kt)("p",null,"Voici les fonctions d'extension :"),(0,i.kt)("h3",{id:"421-fonctions-dextension"},"4.2.1 Fonctions d'extension"),(0,i.kt)("h4",{id:"4211-acc\xe8s"},"4.2.1.1 acc\xe8s"),(0,i.kt)("p",null,"L'acc\xe8s est utilis\xe9 pour r\xe9soudre le probl\xe8me que Casbin ne prend pas en charge l'indexation dans les cartes ou les tableaux. L'exemple ",(0,i.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/model.yaml")," d\xe9montre l'utilisation de cette fonction :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini"},'[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n')),(0,i.kt)("p",null,"Dans ce comparateur, ",(0,i.kt)("inlineCode",{parentName:"p"},'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image")')," est \xe9quivalent \xe0 ",(0,i.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Image"),", o\xf9 ",(0,i.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers")," est une tranche."),(0,i.kt)("p",null,"Access peut \xe9galement appeler des fonctions simples qui n'ont pas de param\xe8tres et renvoient une seule valeur. L'exemple ",(0,i.kt)("inlineCode",{parentName:"p"},"example/container_resource_limit/model.yaml")," d\xe9montre cela :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini"},'[matchers]\n  m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")) >= parseFloat(p.cpu) && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","memory","Value")) >= parseFloat(p.memory)\n')),(0,i.kt)("p",null,"Dans ce comparateur, ",(0,i.kt)("inlineCode",{parentName:"p"},'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")')," est \xe9quivalent \xe0 ",(0,i.kt)("inlineCode",{parentName:"p"},'r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits["cpu"].Value()'),", o\xf9 ",(0,i.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits")," est une carte, et ",(0,i.kt)("inlineCode",{parentName:"p"},"Value()")," est une fonction simple qui n'a pas de param\xe8tres et renvoie une seule valeur."),(0,i.kt)("h4",{id:"4212-accesswithwildcard"},"4.2.1.2 accessWithWildcard"),(0,i.kt)("p",null,'Parfois, vous pouvez avoir une demande comme celle-ci : tous les \xe9l\xe9ments d\'un tableau doivent avoir un pr\xe9fixe "aaa". Cependant, Casbin ne prend pas en charge les boucles ',(0,i.kt)("inlineCode",{parentName:"p"},"for"),". Avec ",(0,i.kt)("inlineCode",{parentName:"p"},"accessWithWildcard"),' et la fonctionnalit\xe9 "expansion de carte/tranche", vous pouvez facilement mettre en \u0153uvre une telle demande.'),(0,i.kt)("p",null,"Par exemple, supposons que ",(0,i.kt)("inlineCode",{parentName:"p"},"a.b.c")," soit un tableau ",(0,i.kt)("inlineCode",{parentName:"p"},"[aaa,bbb,ccc,ddd,eee]"),", alors le r\xe9sultat de ",(0,i.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(a,"b","c","*")')," sera une tranche ",(0,i.kt)("inlineCode",{parentName:"p"},"[aaa,bbb,ccc,ddd,eee]"),". En utilisant le joker ",(0,i.kt)("inlineCode",{parentName:"p"},"*"),", la tranche est \xe9tendue."),(0,i.kt)("p",null,"De m\xeame, le joker peut \xeatre utilis\xe9 plus d'une fois. Par exemple, le r\xe9sultat de ",(0,i.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(a,"b","c","*","*")')," sera ",(0,i.kt)("inlineCode",{parentName:"p"},"[a.b.c[0][0], a.b.c[0][1], ..., a.b.c[1][0], a.b.c[1][1], ...]"),"."),(0,i.kt)("h3",{id:"4213-fonctions-prenant-en-charge-les-arguments-de-longueur-variable"},"4.2.1.3 Fonctions prenant en charge les arguments de longueur variable"),(0,i.kt)("p",null,"Dans l'\xe9valuateur d'expression de Casbin, lorsqu'un param\xe8tre est un tableau, il sera automatiquement \xe9tendu en tant qu'argument de longueur variable. En utilisant cette fonctionnalit\xe9 pour prendre en charge l'expansion de tableau/tranche/carte, nous avons \xe9galement int\xe9gr\xe9 plusieurs fonctions qui acceptent un tableau/tranche en tant que param\xe8tre :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"contain() : accepte plusieurs param\xe8tres et renvoie si un param\xe8tre (\xe0 l'exception du dernier param\xe8tre) est \xe9gal au dernier param\xe8tre."),(0,i.kt)("li",{parentName:"ul"},"split(a,b,c...,sep,index): renvoie une tranche qui contient ",(0,i.kt)("inlineCode",{parentName:"li"},"[splits(a,sep)[index], splits(b,sep)[index], splits(a,sep)[index], ...]"),"."),(0,i.kt)("li",{parentName:"ul"},"len(): renvoie la longueur de l'argument de longueur variable."),(0,i.kt)("li",{parentName:"ul"},"matchRegex(a,b,c...,regex): renvoie si tous les param\xe8tres donn\xe9s (",(0,i.kt)("inlineCode",{parentName:"li"},"a"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"b"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"c"),", ...) correspondent au regex donn\xe9.")),(0,i.kt)("p",null,"Voici un exemple dans ",(0,i.kt)("inlineCode",{parentName:"p"},"example/disallowed_tag/model.yaml"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini"},'    [matchers]\n    m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n    contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n')),(0,i.kt)("p",null,"En supposant que ",(0,i.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image")')," renvoie ",(0,i.kt)("inlineCode",{parentName:"p"},'["a:b", "c:d", "e:f", "g:h"]'),", car splits supporte les arguments de longueur variable et effectue l'op\xe9ration de splits sur chaque \xe9l\xe9ment, l'\xe9l\xe9ment \xe0 l'index 1 sera s\xe9lectionn\xe9 et renvoy\xe9. Par cons\xe9quent, ",(0,i.kt)("inlineCode",{parentName:"p"},'split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1)')," renvoie ",(0,i.kt)("inlineCode",{parentName:"p"},'["b","d","f","h"]'),". Et ",(0,i.kt)("inlineCode",{parentName:"p"},'contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)')," renvoie si ",(0,i.kt)("inlineCode",{parentName:"p"},"p.obj")," est contenu dans ",(0,i.kt)("inlineCode",{parentName:"p"},'["b","d","f","h"]'),"."),(0,i.kt)("h4",{id:"4212-fonctions-de-conversion-de-type"},"4.2.1.2 Fonctions de conversion de type"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"ParseFloat(): Convertit un entier en flottant (c'est n\xe9cessaire car tout nombre utilis\xe9 dans une comparaison doit \xeatre converti en flottant)."),(0,i.kt)("li",{parentName:"ul"},"ToString(): Convertit un objet en cha\xeene de caract\xe8res. Cet objet doit avoir un type de base de cha\xeene (par exemple, un objet de type ",(0,i.kt)("inlineCode",{parentName:"li"},"XXX")," lorsqu'il y a une d\xe9claration ",(0,i.kt)("inlineCode",{parentName:"li"},"type XXX string"),")."),(0,i.kt)("li",{parentName:"ul"},"IsNil(): Renvoie si le param\xe8tre est nil.")),(0,i.kt)("h2",{id:"5-param\xe8tres-avanc\xe9s"},"5. Param\xe8tres avanc\xe9s"),(0,i.kt)("h3",{id:"51-\xe0-propos-des-certificats"},"5.1 \xc0 propos des certificats"),(0,i.kt)("p",null,"Dans Kubernetes (k8s), il est obligatoire qu'un webhook utilise HTTPS. Il existe deux approches pour y parvenir:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Utiliser des certificats auto-sign\xe9s (les exemples dans ce d\xe9p\xf4t utilisent cette m\xe9thode)"),(0,i.kt)("li",{parentName:"ul"},"Utiliser un certificat normal")),(0,i.kt)("h4",{id:"511-certificats-auto-sign\xe9s"},"5.1.1 Certificats auto-sign\xe9s"),(0,i.kt)("p",null,"Utiliser un certificat auto-sign\xe9 signifie que l'Autorit\xe9 de Certification (CA) qui d\xe9livre le certificat n'est pas l'une des CA bien connues. Par cons\xe9quent, vous devez faire conna\xeetre cette CA \xe0 k8s."),(0,i.kt)("p",null,"Actuellement, l'exemple dans ce d\xe9p\xf4t utilise une CA auto-faite, dont la cl\xe9 priv\xe9e et le certificat sont stock\xe9s dans ",(0,i.kt)("inlineCode",{parentName:"p"},"config/certificate/ca.crt")," et ",(0,i.kt)("inlineCode",{parentName:"p"},"config/certificate/ca.key")," respectivement. Le certificat pour le webhook est ",(0,i.kt)("inlineCode",{parentName:"p"},"config/certificate/server.crt"),', qui est d\xe9livr\xe9 par la CA auto-faite. Les domaines de ce certificat sont "webhook.domain.local" (pour le webhook externe) et "casbin-webhook-svc.default.svc" (pour le webhook interne).'),(0,i.kt)("p",null,"Les informations sur la CA sont transmises \xe0 k8s via les fichiers de configuration du webhook. Les deux ",(0,i.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," et ",(0,i.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml"),' ont un champ appel\xe9 "CABundle", qui contient une cha\xeene encod\xe9e en base64 du certificat de la CA.'),(0,i.kt)("p",null,"Au cas o\xf9 vous auriez besoin de changer le certificat/domaine (par exemple, si vous voulez mettre ce webhook dans un autre espace de noms de k8s tout en utilisant un webhook interne, ou si vous voulez changer le domaine tout en utilisant un webhook externe), les proc\xe9dures suivantes doivent \xeatre suivies:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"G\xe9n\xe9rer une nouvelle CA:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"G\xe9n\xe9rez la cl\xe9 priv\xe9e pour le faux CA :"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"openssl genrsa -des3 -out ca.key 2048\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Supprimez la protection par mot de passe de la cl\xe9 priv\xe9e :"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"openssl rsa -in ca.key -out ca.key\n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"G\xe9n\xe9rez une cl\xe9 priv\xe9e pour le serveur webhook :"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"openssl genrsa -des3 -out server.key 2048\nopenssl rsa -in server.key -out server.key\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Utilisez le CA auto-g\xe9n\xe9r\xe9 pour signer le certificat pour le webhook :"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Copiez le fichier de configuration openssl de votre syst\xe8me pour une utilisation temporaire. Vous pouvez trouver l'emplacement du fichier de configuration en ex\xe9cutant ",(0,i.kt)("inlineCode",{parentName:"p"},"openssl version -a"),", g\xe9n\xe9ralement appel\xe9 ",(0,i.kt)("inlineCode",{parentName:"p"},"openssl.cnf"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Dans le fichier de configuration :"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Trouvez le paragraphe ",(0,i.kt)("inlineCode",{parentName:"p"},"[req]")," et ajoutez la ligne suivante : ",(0,i.kt)("inlineCode",{parentName:"p"},"req_extensions = v3_req"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Trouvez le paragraphe ",(0,i.kt)("inlineCode",{parentName:"p"},"[v3_req]")," et ajoutez la ligne suivante : ",(0,i.kt)("inlineCode",{parentName:"p"},"subjectAltName = @alt_names"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Ajoutez les lignes suivantes au fichier :"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini"},"[alt_names]\nDNS.2=<The domain you want>\n")),(0,i.kt)("p",{parentName:"li"},"Note : Remplacez 'casbin-webhook-svc.default.svc' par le vrai nom de service de votre propre service si vous d\xe9cidez de modifier le nom du service.")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Utilisez le fichier de configuration modifi\xe9 pour g\xe9n\xe9rer un fichier de demande de certificat :"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"openssl req -new -nodes -keyout server.key -out server.csr -config openssl.cnf\n"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Utilisez le CA auto-fait pour r\xe9pondre \xe0 la demande et signer le certificat :"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"openssl x509 -req -days 3650 -in server.csr -out server.crt -CA ca.crt -CAkey ca.key -CAcreateserial -extensions v3_req -extensions SAN -extfile openssl.cnf\n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Remplacez le champ 'CABundle' : Les deux ",(0,i.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," et ",(0,i.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml"),' ont un champ appel\xe9 "CABundle", qui contient une cha\xeene encod\xe9e en base64 du certificat du CA. Mettez \xe0 jour ce champ avec le nouveau certificat.')),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Si vous utilisez helm, des modifications similaires doivent \xeatre appliqu\xe9es aux graphiques de helm."))),(0,i.kt)("h4",{id:"512-certificats-l\xe9gaux"},"5.1.2 Certificats l\xe9gaux"),(0,i.kt)("p",null,'Si vous utilisez des certificats l\xe9gaux, vous n\'avez pas besoin de passer par toutes ces proc\xe9dures. Supprimez le champ "CABundle" dans ',(0,i.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," et ",(0,i.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml"),", et changez le domaine dans ces fichiers pour le domaine que vous poss\xe9dez."))}c.isMDXComponent=!0}}]);