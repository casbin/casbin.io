"use strict";(globalThis.webpackChunkcasbin_website_v2=globalThis.webpackChunkcasbin_website_v2||[]).push([[3275],{7492(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"k8s-gatekeeper","title":"Admission Webhook for K8s","description":"Kubernetes (K8s) RBAC \u0438 ABAC \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u043e\u043d\u043d\u043e\u0435 \u043f\u0440\u043e\u043c\u0435\u0436\u0443\u0442\u043e\u0447\u043d\u043e\u0435 \u041f\u041e \u043d\u0430 \u043e\u0441\u043d\u043e\u0432\u0435 Casbin","source":"@site/i18n/ru/docusaurus-plugin-content-docs/current/K8sGateKeeper.mdx","sourceDirName":".","slug":"/k8s-gatekeeper","permalink":"/ru/docs/k8s-gatekeeper","draft":false,"unlisted":false,"editUrl":"https://github.com/casbin/casbin-website-v2/edit/master/docs/K8sGateKeeper.mdx","tags":[],"version":"current","frontMatter":{"id":"k8s-gatekeeper","title":"Admission Webhook for K8s","description":"Kubernetes (K8s) RBAC \u0438 ABAC \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u043e\u043d\u043d\u043e\u0435 \u043f\u0440\u043e\u043c\u0435\u0436\u0443\u0442\u043e\u0447\u043d\u043e\u0435 \u041f\u041e \u043d\u0430 \u043e\u0441\u043d\u043e\u0432\u0435 Casbin","keywords":["k8s-gatekeeper","Kubernetes","K8s"],"authors":["ComradeProgrammer"]},"sidebar":"docs","previous":{"title":"Performance Optimization","permalink":"/ru/docs/performance"},"next":{"title":"Authorization of Service Mesh through Envoy","permalink":"/ru/docs/envoy"}}');var a=s(4848),r=s(8453);const t={id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC \u0438 ABAC \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u043e\u043d\u043d\u043e\u0435 \u043f\u0440\u043e\u043c\u0435\u0436\u0443\u0442\u043e\u0447\u043d\u043e\u0435 \u041f\u041e \u043d\u0430 \u043e\u0441\u043d\u043e\u0432\u0435 Casbin",keywords:["k8s-gatekeeper","Kubernetes","K8s"],authors:["ComradeProgrammer"]},l=void 0,c={},o=[{value:"1. Overview &amp; Documentation for Casbin K8s-Gatekeeper",id:"1-overview--documentation-for-casbin-k8s-gatekeeper",level:2},{value:"0.1 A Basic Example",id:"01-a-basic-example",level:3},{value:"1.1 How Casbin K8s-Gatekeeper Works",id:"11-how-casbin-k8s-gatekeeper-works",level:3},{value:"1.2 Example Workflow",id:"12-example-workflow",level:3},{value:"2. Installing K8s-gatekeeper",id:"2-installing-k8s-gatekeeper",level:2},{value:"2.1 Internal Webhook",id:"21-internal-webhook",level:3},{value:"2.1.1 Step 1: Build the Image",id:"211-step-1-build-the-image",level:4},{value:"2.1.2 Step 2: Deploy Services and Resources",id:"212-step-2-deploy-services-and-resources",level:4},{value:"2.1.3 Step 3: Install CRD Resources",id:"213-step-3-install-crd-resources",level:4},{value:"2.2 External Webhook",id:"22-external-webhook",level:3},{value:"2.3 Installing via Helm",id:"23-installing-via-helm",level:3},{value:"2.3.1 Step 1: Build the Image",id:"231-step-1-build-the-image",level:4},{value:"2.3.2 Helm Installation",id:"232-helm-installation",level:4},{value:"3. Using K8s-gatekeeper",id:"3-using-k8s-gatekeeper",level:2},{value:"3.1 Creating Casbin Models and Policies",id:"31-creating-casbin-models-and-policies",level:3},{value:"3.1.1 Create/Update via kubectl",id:"311-createupdate-via-kubectl",level:4},{value:"3.1.2 Create/Update via Go Client",id:"312-createupdate-via-go-client",level:4},{value:"3.1.2 Testing K8s-gatekeeper",id:"312-testing-k8s-gatekeeper",level:3},{value:"4. Writing Models and Policies for K8s-gatekeeper",id:"4-writing-models-and-policies-for-k8s-gatekeeper",level:2},{value:"4.1 Request Definition",id:"41-request-definition",level:3},{value:"4.2 Model Matchers",id:"42-model-matchers",level:3},{value:"4.2.1 Extension Functions",id:"421-extension-functions",level:3},{value:"4.2.1.1 \u0434\u043e\u0441\u0442\u0443\u043f",id:"4211-\u0434\u043e\u0441\u0442\u0443\u043f",level:4},{value:"4.2.1.2 accessWithWildcard",id:"4212-accesswithwildcard",level:4},{value:"4.2.1.3 Variable-Length Argument Functions",id:"4213-variable-length-argument-functions",level:3},{value:"4.2.1.2 \u0424\u0443\u043d\u043a\u0446\u0438\u0438 \u043f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u043e\u0432\u0430\u043d\u0438\u044f \u0442\u0438\u043f\u043e\u0432",id:"4212-\u0444\u0443\u043d\u043a\u0446\u0438\u0438-\u043f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u043e\u0432\u0430\u043d\u0438\u044f-\u0442\u0438\u043f\u043e\u0432",level:4},{value:"5. \u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u043d\u044b\u0435 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438",id:"5-\u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u043d\u044b\u0435-\u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438",level:2},{value:"5.1 Certificate Configuration",id:"51-certificate-configuration",level:3},{value:"5.1.1 Self-Signed Certificates",id:"511-self-signed-certificates",level:4},{value:"5.1.2 Publicly Trusted Certificates",id:"512-publicly-trusted-certificates",level:4}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"1-overview--documentation-for-casbin-k8s-gatekeeper",children:"1. Overview & Documentation for Casbin K8s-Gatekeeper"}),"\n",(0,a.jsx)(n.p,{children:"Casbin K8s-GateKeeper is a Kubernetes admission webhook that integrates Casbin for access control. Using Casbin K8s-GateKeeper, you can define flexible authorization rules for any Kubernetes resource operation through declarative Casbin model and policy configurations\u2014no code required."}),"\n",(0,a.jsxs)(n.p,{children:["Casbin K8s-GateKeeper \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u0430\u043d \u0438 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u0441\u0442\u0432\u043e\u043c Casbin. Repository: ",(0,a.jsx)(n.a,{href:"https://github.com/casbin/k8s-gatekeeper",children:"https://github.com/casbin/k8s-gatekeeper"})]}),"\n",(0,a.jsx)(n.h3,{id:"01-a-basic-example",children:"0.1 A Basic Example"}),"\n",(0,a.jsx)(n.p,{children:"Here's an example that blocks deployments using images with specific tags, using only configuration:"}),"\n",(0,a.jsx)(n.p,{children:"Model:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ini",children:'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\ncontain(split(accessWithWildcard(${OBJECT}.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n'})}),"\n",(0,a.jsx)(n.p,{children:"Policy:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csv",children:'p, "1.14.1",deny\n'})}),"\n",(0,a.jsx)(n.p,{children:"This uses standard Casbin ACL language, which should be straightforward if you've read the introductory chapters."}),"\n",(0,a.jsx)(n.p,{children:"Casbin K8s-Gatekeeper offers several advantages:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Simple to use\u2014write ACL configurations instead of extensive code"}),"\n",(0,a.jsx)(n.li,{children:"Supports live configuration updates without plugin restarts"}),"\n",(0,a.jsxs)(n.li,{children:["Flexible\u2014apply arbitrary rules to any Kubernetes resource using ",(0,a.jsx)(n.code,{children:"kubectl gatekeeper"})]}),"\n",(0,a.jsx)(n.li,{children:"Simplifies Kubernetes admission webhook implementation\u2014no need to understand webhook internals or write webhook code. Just define constraints and write Casbin ACL."}),"\n",(0,a.jsx)(n.li,{children:"Community-maintained\u2014contact us with questions or issues"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"11-how-casbin-k8s-gatekeeper-works",children:"1.1 How Casbin K8s-Gatekeeper Works"}),"\n",(0,a.jsxs)(n.p,{children:["K8s-Gatekeeper is an admission webhook for Kubernetes that uses ",(0,a.jsx)(n.a,{href:"/docs/overview",children:"Casbin"})," to enforce custom access control rules, preventing unwanted operations on Kubernetes resources."]}),"\n",(0,a.jsxs)(n.p,{children:["Casbin is an efficient open-source access control library supporting various authorization models. For details, see the ",(0,a.jsx)(n.a,{href:"/docs/overview",children:"Overview"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Admission webhooks in Kubernetes are HTTP callbacks that receive and process admission requests. K8s-Gatekeeper is a ValidatingAdmissionWebhook that accepts or rejects admission requests. Admission requests are HTTP requests describing operations on Kubernetes resources (e.g., creating or deleting a deployment). For more information, see the ",(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#what-are-admission-webhooks",children:"Kubernetes documentation"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"12-example-workflow",children:"1.2 Example Workflow"}),"\n",(0,a.jsx)(n.p,{children:"When someone creates a deployment with an nginx pod (via kubectl or Kubernetes clients), Kubernetes generates an admission request like this (in YAML format):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-deployment\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.14.1\n        ports:\n        - containerPort: 80\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This request passes through middleware layers, including K8s-Gatekeeper. K8s-Gatekeeper detects all Casbin enforcers stored in Kubernetes etcd (created and maintained by users via ",(0,a.jsx)(n.code,{children:"kubectl"})," or the provided Go client). Each enforcer contains a Casbin model and policy. The admission request is evaluated by each enforcer sequentially, and must pass all enforcers to be accepted."]}),"\n",(0,a.jsxs)(n.p,{children:["(If you're unfamiliar with Casbin enforcers, models, or policies, see ",(0,a.jsx)(n.a,{href:"/docs/get-started",children:"Get Started"}),")."]}),"\n",(0,a.jsx)(n.p,{children:"For instance, if an administrator wants to block the 'nginx:1.14.1' image while allowing 'nginx:1.3.1', they can create an enforcer with this model and policy (creation and configuration details follow in subsequent sections):"}),"\n",(0,a.jsx)(n.p,{children:"Model:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ini",children:'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"Policy:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csv",children:'p, "nginx:1.13.1",allow\np, "nginx:1.14.1",deny\n'})}),"\n",(0,a.jsx)(n.p,{children:"Creating an enforcer with this model and policy will reject the admission request, preventing Kubernetes from creating the deployment."}),"\n",(0,a.jsx)(n.h2,{id:"2-installing-k8s-gatekeeper",children:"2. Installing K8s-gatekeeper"}),"\n",(0,a.jsx)(n.p,{children:"Three installation methods are available: External webhook, Internal webhook, and Helm."}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["These installation methods are for evaluation purposes only. For production deployments, review ",(0,a.jsx)(n.a,{href:"#5-advanced-settings",children:"Chapter 5. Advanced settings"})," and apply necessary security modifications before installation."]})}),"\n",(0,a.jsx)(n.h3,{id:"21-internal-webhook",children:"2.1 Internal Webhook"}),"\n",(0,a.jsx)(n.h4,{id:"211-step-1-build-the-image",children:"2.1.1 Step 1: Build the Image"}),"\n",(0,a.jsx)(n.p,{children:"For internal webhook deployment, K8s-gatekeeper runs as a Kubernetes service. Build the image:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"docker build --target webhook -t k8s-gatekeeper .\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This creates a local image named 'k8s-gatekeeper",":latest","'."]}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["For minikube users, run ",(0,a.jsx)(n.code,{children:"eval $(minikube -p minikube docker-env)"})," before 'docker build'."]})}),"\n",(0,a.jsx)(n.h4,{id:"212-step-2-deploy-services-and-resources",children:"2.1.2 Step 2: Deploy Services and Resources"}),"\n",(0,a.jsx)(n.p,{children:"Run these commands:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f config/rbac.yaml\nkubectl apply -f config/webhook_deployment.yaml \nkubectl apply -f config/webhook_internal.yaml \n"})}),"\n",(0,a.jsxs)(n.p,{children:["Verify deployment with ",(0,a.jsx)(n.code,{children:"kubectl get pods"}),"."]}),"\n",(0,a.jsx)(n.h4,{id:"213-step-3-install-crd-resources",children:"2.1.3 Step 3: Install CRD Resources"}),"\n",(0,a.jsx)(n.p,{children:"Install custom resource definitions:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\n"})}),"\n",(0,a.jsx)(n.h3,{id:"22-external-webhook",children:"2.2 External Webhook"}),"\n",(0,a.jsxs)(n.p,{children:["For external webhook deployment, K8s-gatekeeper runs outside Kubernetes. Kubernetes requires HTTPS for admission webhooks. We provide test certificates and a private key (not production-secure). For custom certificates, see ",(0,a.jsx)(n.a,{href:"#5-advanced-settings",children:"Chapter 5. Advanced settings"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"The provided certificate is issued for 'webhook.domain.local'. Update your hosts file (e.g., /etc/hosts) to point 'webhook.domain.local' to the IP address where K8s-gatekeeper runs."}),"\n",(0,a.jsx)(n.p,{children:"Execute:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"go mod tidy\ngo mod vendor\ngo run cmd/webhook/main.go\nkubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\nkubectl apply -f config/webhook_external.yaml \n"})}),"\n",(0,a.jsx)(n.h3,{id:"23-installing-via-helm",children:"2.3 Installing via Helm"}),"\n",(0,a.jsx)(n.h4,{id:"231-step-1-build-the-image",children:"2.3.1 Step 1: Build the Image"}),"\n",(0,a.jsxs)(n.p,{children:["See ",(0,a.jsx)(n.a,{href:"#211-step-1-build-the-image",children:"Chapter 2.1.1"}),"."]}),"\n",(0,a.jsx)(n.h4,{id:"232-helm-installation",children:"2.3.2 Helm Installation"}),"\n",(0,a.jsxs)(n.p,{children:["Run: ",(0,a.jsx)(n.code,{children:"helm install k8sgatekeeper ./k8sgatekeeper"})]}),"\n",(0,a.jsx)(n.h2,{id:"3-using-k8s-gatekeeper",children:"3. Using K8s-gatekeeper"}),"\n",(0,a.jsx)(n.h3,{id:"31-creating-casbin-models-and-policies",children:"3.1 Creating Casbin Models and Policies"}),"\n",(0,a.jsx)(n.p,{children:"Create models and policies using either kubectl or the provided Go client."}),"\n",(0,a.jsx)(n.h4,{id:"311-createupdate-via-kubectl",children:"3.1.1 Create/Update via kubectl"}),"\n",(0,a.jsxs)(n.p,{children:["In K8s-gatekeeper, Casbin models are stored as 'CasbinModel' CRD resources. The definition is in ",(0,a.jsx)(n.code,{children:"config/auth.casbin.org_casbinmodels.yaml"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["See examples in ",(0,a.jsx)(n.code,{children:"example/allowed_repo/model.yaml"}),". Important fields:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"metadata.name: Model name. Must match the associated CasbinPolicy object name for K8s-gatekeeper to pair them correctly."}),"\n",(0,a.jsx)(n.li,{children:'spec.enable: Set to "false" to disable this model and its associated policy.'}),"\n",(0,a.jsx)(n.li,{children:"spec.modelText: String containing the Casbin model definition."}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Casbin policies are stored as 'CasbinPolicy' CRD resources, defined in ",(0,a.jsx)(n.code,{children:"config/auth.casbin.org_casbinpolicies.yaml"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["See examples in ",(0,a.jsx)(n.code,{children:"example/allowed_repo/policy.yaml"}),". Important fields:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"metadata.name: Policy name. Must match the associated CasbinModel object name."}),"\n",(0,a.jsx)(n.li,{children:"spec.policyItem: String containing the Casbin policy definition."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Apply your CasbinModel and CasbinPolicy files:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f <filename>\n"})}),"\n",(0,a.jsx)(n.p,{children:"K8s-gatekeeper detects new CasbinModel/CasbinPolicy pairs within 5 seconds."}),"\n",(0,a.jsx)(n.h4,{id:"312-createupdate-via-go-client",children:"3.1.2 Create/Update via Go Client"}),"\n",(0,a.jsx)(n.p,{children:"For scenarios where direct shell access to cluster nodes is impractical (e.g., when building automated cloud platforms), we provide a Go client for managing CasbinModel and CasbinPolicy resources."}),"\n",(0,a.jsxs)(n.p,{children:["The Go client library is in ",(0,a.jsx)(n.code,{children:"pkg/client"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["In ",(0,a.jsx)(n.code,{children:"client.go"}),", use this function to create a client:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"func NewK8sGateKeeperClient(externalClient bool) (*K8sGateKeeperClient, error) \n"})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"externalClient"})," parameter indicates whether K8s-gatekeeper runs inside or outside the Kubernetes cluster."]}),"\n",(0,a.jsxs)(n.p,{children:["In ",(0,a.jsx)(n.code,{children:"model.go"}),", functions are provided for creating, deleting, and modifying CasbinModel. See ",(0,a.jsx)(n.code,{children:"model_test.go"})," for usage examples."]}),"\n",(0,a.jsxs)(n.p,{children:["In ",(0,a.jsx)(n.code,{children:"policy.go"}),", functions are provided for creating, deleting, and modifying CasbinPolicy. See ",(0,a.jsx)(n.code,{children:"policy_test.go"})," for usage examples."]}),"\n",(0,a.jsx)(n.h3,{id:"312-testing-k8s-gatekeeper",children:"3.1.2 Testing K8s-gatekeeper"}),"\n",(0,a.jsxs)(n.p,{children:["After creating the model and policy from ",(0,a.jsx)(n.code,{children:"example/allowed_repo"}),", test with:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f example/allowed_repo/testcase/reject_1.yaml\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Kubernetes should reject this request, citing the webhook as the rejection reason. However, applying ",(0,a.jsx)(n.code,{children:"example/allowed_repo/testcase/approve_2.yaml"})," should succeed."]}),"\n",(0,a.jsx)(n.h2,{id:"4-writing-models-and-policies-for-k8s-gatekeeper",children:"4. Writing Models and Policies for K8s-gatekeeper"}),"\n",(0,a.jsxs)(n.p,{children:["Ensure you understand Casbin model and policy syntax before proceeding. If not, read the ",(0,a.jsx)(n.a,{href:"/docs/get-started",children:"Get Started"})," section first. This chapter assumes familiarity with Casbin models and policies."]}),"\n",(0,a.jsx)(n.h3,{id:"41-request-definition",children:"4.1 Request Definition"}),"\n",(0,a.jsx)(n.p,{children:"When K8s-gatekeeper evaluates a request, the input is always an AdmissionReview Go object. The enforcer is used as follows:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"ok, err := enforcer.Enforce(admission)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["where ",(0,a.jsx)(n.code,{children:"admission"})," is an ",(0,a.jsx)(n.code,{children:"AdmissionReview"})," object from Kubernetes' official Go API ",(0,a.jsx)(n.code,{children:'"k8s.io/api/admission/v1"'}),". The struct definition is available at: ",(0,a.jsx)(n.a,{href:"https://github.com/kubernetes/api/blob/master/admission/v1/types.go",children:"https://github.com/kubernetes/api/blob/master/admission/v1/types.go"}),". Additional documentation: ",(0,a.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response",children:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["For K8s-gatekeeper models, the ",(0,a.jsx)(n.code,{children:"request_definition"})," should always follow this format:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ini",children:"    [request_definition]\n    r =  obj\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The name 'obj' can be changed as long as it's used consistently in the ",(0,a.jsx)(n.code,{children:"[matchers]"})," section."]}),"\n",(0,a.jsx)(n.h3,{id:"42-model-matchers",children:"4.2 Model Matchers"}),"\n",(0,a.jsx)(n.p,{children:"Use Casbin's ABAC feature to write rules. However, Casbin's expression evaluator doesn't natively support map/array indexing or array expansion. K8s-gatekeeper provides extension functions to address this. If you need additional functionality, please open an issue or submit a pull request."}),"\n",(0,a.jsxs)(n.p,{children:["For background on Casbin functions, see ",(0,a.jsx)(n.a,{href:"/docs/function",children:"Function"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Extension functions:"}),"\n",(0,a.jsx)(n.h3,{id:"421-extension-functions",children:"4.2.1 Extension Functions"}),"\n",(0,a.jsx)(n.h4,{id:"4211-\u0434\u043e\u0441\u0442\u0443\u043f",children:"4.2.1.1 \u0434\u043e\u0441\u0442\u0443\u043f"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"access"})," function enables map and array indexing. See ",(0,a.jsx)(n.code,{children:"example/allowed_repo/model.yaml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ini",children:'[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Here, ",(0,a.jsx)(n.code,{children:'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image")'})," is equivalent to ",(0,a.jsx)(n.code,{children:"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Image"}),", where ",(0,a.jsx)(n.code,{children:"r.obj.Request.Object.Object.Spec.Template.Spec.Containers"})," is a slice."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"access"})," can also call parameterless functions that return a single value. See ",(0,a.jsx)(n.code,{children:"example/container_resource_limit/model.yaml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ini",children:'[matchers]\n  m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")) >= parseFloat(p.cpu) && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","memory","Value")) >= parseFloat(p.memory)\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Here, ",(0,a.jsx)(n.code,{children:'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")'})," equals ",(0,a.jsx)(n.code,{children:'r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits["cpu"].Value()'}),", where ",(0,a.jsx)(n.code,{children:"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits"})," is a map and ",(0,a.jsx)(n.code,{children:"Value()"})," is a parameterless function returning a single value."]}),"\n",(0,a.jsx)(n.h4,{id:"4212-accesswithwildcard",children:"4.2.1.2 accessWithWildcard"}),"\n",(0,a.jsxs)(n.p,{children:["To check conditions across all array elements (e.g., \"all elements must start with 'aaa'\") without ",(0,a.jsx)(n.code,{children:"for"})," loops, use ",(0,a.jsx)(n.code,{children:"accessWithWildcard"})," with map/slice expansion."]}),"\n",(0,a.jsxs)(n.p,{children:["If ",(0,a.jsx)(n.code,{children:"a.b.c"})," is the array ",(0,a.jsx)(n.code,{children:"[aaa,bbb,ccc,ddd,eee]"}),", then ",(0,a.jsx)(n.code,{children:'accessWithWildcard(a,"b","c","*")'})," returns the slice ",(0,a.jsx)(n.code,{children:"[aaa,bbb,ccc,ddd,eee]"}),". The wildcard ",(0,a.jsx)(n.code,{children:"*"})," expands the slice."]}),"\n",(0,a.jsxs)(n.p,{children:["Multiple wildcards are supported. For example, ",(0,a.jsx)(n.code,{children:'accessWithWildcard(a,"b","c","*","*")'})," returns ",(0,a.jsx)(n.code,{children:"[a.b.c[0][0], a.b.c[0][1], ..., a.b.c[1][0], a.b.c[1][1], ...]"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"4213-variable-length-argument-functions",children:"4.2.1.3 Variable-Length Argument Functions"}),"\n",(0,a.jsx)(n.p,{children:"Casbin's expression evaluator automatically expands arrays as variable-length arguments. Leveraging this for array/slice/map expansion, several functions accept arrays/slices:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"contain(): Accepts multiple parameters and returns whether any parameter (except the last) equals the last parameter."}),"\n",(0,a.jsxs)(n.li,{children:["split(a,b,c...,sep,index): Returns ",(0,a.jsx)(n.code,{children:"[splits(a,sep)[index], splits(b,sep)[index], splits(c,sep)[index], ...]"}),"."]}),"\n",(0,a.jsx)(n.li,{children:"len(): Returns the variable-length argument count."}),"\n",(0,a.jsxs)(n.li,{children:["matchRegex(a,b,c...,regex): Returns whether all parameters (",(0,a.jsx)(n.code,{children:"a"}),", ",(0,a.jsx)(n.code,{children:"b"}),", ",(0,a.jsx)(n.code,{children:"c"}),", ...) match the regex."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Example from ",(0,a.jsx)(n.code,{children:"example/disallowed_tag/model.yaml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ini",children:'    [matchers]\n    m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n    contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n'})}),"\n",(0,a.jsxs)(n.p,{children:["If ",(0,a.jsx)(n.code,{children:'accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image")'})," returns ",(0,a.jsx)(n.code,{children:'["a:b", "c:d", "e:f", "g:h"]'}),", the split operation processes each element with variable-length argument support, selecting index 1 from each. Thus, ",(0,a.jsx)(n.code,{children:'split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1)'})," returns ",(0,a.jsx)(n.code,{children:'["b","d","f","h"]'}),". Finally, ",(0,a.jsx)(n.code,{children:'contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)'})," checks if ",(0,a.jsx)(n.code,{children:"p.obj"})," exists in ",(0,a.jsx)(n.code,{children:'["b","d","f","h"]'}),"."]}),"\n",(0,a.jsx)(n.h4,{id:"4212-\u0444\u0443\u043d\u043a\u0446\u0438\u0438-\u043f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u043e\u0432\u0430\u043d\u0438\u044f-\u0442\u0438\u043f\u043e\u0432",children:"4.2.1.2 \u0424\u0443\u043d\u043a\u0446\u0438\u0438 \u043f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u043e\u0432\u0430\u043d\u0438\u044f \u0442\u0438\u043f\u043e\u0432"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"ParseFloat(): Converts integers to floats (required because comparisons need float type)."}),"\n",(0,a.jsxs)(n.li,{children:["ToString(): Converts objects to strings. The object must have an underlying string type (e.g., ",(0,a.jsx)(n.code,{children:"type XXX string"}),")."]}),"\n",(0,a.jsx)(n.li,{children:"IsNil(): \u0412\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442, \u044f\u0432\u043b\u044f\u0435\u0442\u0441\u044f \u043b\u0438 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440 nil."}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"5-\u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u043d\u044b\u0435-\u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438",children:"5. \u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u043d\u044b\u0435 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438"}),"\n",(0,a.jsx)(n.h3,{id:"51-certificate-configuration",children:"5.1 Certificate Configuration"}),"\n",(0,a.jsx)(n.p,{children:"Kubernetes requires webhooks to use HTTPS. Two options are available:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Self-signed certificates (used in this repository's examples)"}),"\n",(0,a.jsx)(n.li,{children:"Publicly trusted certificates"}),"\n"]}),"\n",(0,a.jsx)(n.h4,{id:"511-self-signed-certificates",children:"5.1.1 Self-Signed Certificates"}),"\n",(0,a.jsx)(n.p,{children:"Self-signed certificates use a Certificate Authority (CA) that isn't publicly recognized. You must configure Kubernetes to trust this CA."}),"\n",(0,a.jsxs)(n.p,{children:["The repository examples use a custom CA with private key and certificate stored in ",(0,a.jsx)(n.code,{children:"config/certificate/ca.key"})," and ",(0,a.jsx)(n.code,{children:"config/certificate/ca.crt"}),". The webhook certificate ",(0,a.jsx)(n.code,{children:"config/certificate/server.crt"}),' is issued by this CA for domains "webhook.domain.local" (external webhook) and "casbin-webhook-svc.default.svc" (internal webhook).']}),"\n",(0,a.jsxs)(n.p,{children:["CA information is passed to Kubernetes via webhook configuration files. Both ",(0,a.jsx)(n.code,{children:"config/webhook_external.yaml"})," and ",(0,a.jsx)(n.code,{children:"config/webhook_internal.yaml"}),' contain a "CABundle" field with the base64-encoded CA certificate.']}),"\n",(0,a.jsx)(n.p,{children:"To change the certificate/domain (e.g., moving the webhook to another namespace or changing domains):"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"\u0421\u043e\u0437\u0434\u0430\u0442\u044c \u043d\u043e\u0432\u044b\u0439 CA:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Generate the CA private key:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"openssl genrsa -des3 -out ca.key 2048\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Remove password protection:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"openssl rsa -in ca.key -out ca.key\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Generate a webhook server private key:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"openssl genrsa -des3 -out server.key 2048\nopenssl rsa -in server.key -out server.key\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Sign the webhook certificate with the CA:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Copy your system's OpenSSL config file (find it with ",(0,a.jsx)(n.code,{children:"openssl version -a"}),", typically ",(0,a.jsx)(n.code,{children:"openssl.cnf"}),")."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Modify the config file:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["In the ",(0,a.jsx)(n.code,{children:"[req]"})," section, add: ",(0,a.jsx)(n.code,{children:"req_extensions = v3_req"})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["In the ",(0,a.jsx)(n.code,{children:"[v3_req]"})," section, add: ",(0,a.jsx)(n.code,{children:"subjectAltName = @alt_names"})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Append:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ini",children:"[alt_names]\nDNS.2=<Your desired domain>\n"})}),"\n",(0,a.jsx)(n.p,{children:"Note: Replace 'casbin-webhook-svc.default.svc' with your actual service name if modified."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Generate a certificate request:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"openssl req -new -nodes -keyout server.key -out server.csr -config openssl.cnf\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Sign the certificate with the CA:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"openssl x509 -req -days 3650 -in server.csr -out server.crt -CA ca.crt -CAkey ca.key -CAcreateserial -extensions v3_req -extensions SAN -extfile openssl.cnf\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Update the 'CABundle' field in both ",(0,a.jsx)(n.code,{children:"config/webhook_external.yaml"})," and ",(0,a.jsx)(n.code,{children:"config/webhook_internal.yaml"})," with the base64-encoded new CA certificate."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"For Helm deployments, apply equivalent changes to the Helm charts."}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h4,{id:"512-publicly-trusted-certificates",children:"5.1.2 Publicly Trusted Certificates"}),"\n",(0,a.jsxs)(n.p,{children:['With publicly trusted certificates, skip the above procedures. Remove the "CABundle" field from ',(0,a.jsx)(n.code,{children:"config/webhook_external.yaml"})," and ",(0,a.jsx)(n.code,{children:"config/webhook_internal.yaml"}),", and set the domain to your registered domain."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>t,x:()=>l});var i=s(6540);const a={},r=i.createContext(a);function t(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);