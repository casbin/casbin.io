"use strict";(self.webpackChunkcasbin_website_v2=self.webpackChunkcasbin_website_v2||[]).push([[4713],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>k});var i=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=i.createContext({}),d=function(e){var n=i.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},u=function(e){var n=d(e.components);return i.createElement(o.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},c=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,o=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=d(t),k=r,m=c["".concat(o,".").concat(k)]||c[k]||p[k]||a;return t?i.createElement(m,s(s({ref:n},u),{},{components:t})):i.createElement(m,s({ref:n},u))}));function k(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,s=new Array(a);s[0]=c;var l={};for(var o in n)hasOwnProperty.call(n,o)&&(l[o]=n[o]);l.originalType=e,l.mdxType="string"==typeof e?e:r,s[1]=l;for(var d=2;d<a;d++)s[d]=t[d];return i.createElement.apply(null,s)}return i.createElement.apply(null,t)}c.displayName="MDXCreateElement"},3877:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>l,toc:()=>d});var i=t(7462),r=(t(7294),t(3905));const a={id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC & ABAC Autorisierungs-Middleware basierend auf Casbin",keywords:["k8s-gatekeeper","Kubernetes","K8s"],authors:["ComradeProgrammer"]},s=void 0,l={unversionedId:"k8s-gatekeeper",id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC & ABAC Autorisierungs-Middleware basierend auf Casbin",source:"@site/i18n/de/docusaurus-plugin-content-docs/current/K8sGateKeeper.mdx",sourceDirName:".",slug:"/k8s-gatekeeper",permalink:"/de/docs/k8s-gatekeeper",draft:!1,editUrl:"https://github.com/casbin/casbin-website-v2/edit/master/docs/K8sGateKeeper.mdx",tags:[],version:"current",frontMatter:{id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC & ABAC Autorisierungs-Middleware basierend auf Casbin",keywords:["k8s-gatekeeper","Kubernetes","K8s"],authors:["ComradeProgrammer"]},sidebar:"docs",previous:{title:"Authorization of Kubernetes",permalink:"/de/docs/k8s"},next:{title:"Authorization of Service Mesh through Envoy",permalink:"/de/docs/envoy"}},o={},d=[{value:"1. \xdcbersicht &amp; Dokumente f\xfcr Casbin K8s-Gatekeeper",id:"1-\xfcbersicht--dokumente-f\xfcr-casbin-k8s-gatekeeper",level:2},{value:"0.1 Ein einfaches Beispiel",id:"01-ein-einfaches-beispiel",level:3},{value:"1.1 Wie funktioniert Casbin K8s-Gatekeeper?",id:"11-wie-funktioniert-casbin-k8s-gatekeeper",level:3},{value:"1.2 Ein Beispiel zur Veranschaulichung der Funktionsweise",id:"12-ein-beispiel-zur-veranschaulichung-der-funktionsweise",level:3},{value:"2 Installieren Sie K8s-Gatekeeper",id:"2-installieren-sie-k8s-gatekeeper",level:2},{value:"2.1 Interner Webhook",id:"21-interner-webhook",level:3},{value:"2.1.1 Schritt 1: Erstellen Sie das Image",id:"211-schritt-1-erstellen-sie-das-image",level:4},{value:"2.1.2 Schritt 2: Richten Sie Dienste und Bereitstellungen f\xfcr K8s-Gatekeeper ein",id:"212-schritt-2-richten-sie-dienste-und-bereitstellungen-f\xfcr-k8s-gatekeeper-ein",level:4},{value:"2.1.3 Schritt 3: Installieren Sie CRD-Ressourcen f\xfcr K8s-Gatekeeper",id:"213-schritt-3-installieren-sie-crd-ressourcen-f\xfcr-k8s-gatekeeper",level:4},{value:"2.2 Externer Webhook",id:"22-externer-webhook",level:3},{value:"2.3 Installieren Sie K8s-Gatekeeper \xfcber Helm",id:"23-installieren-sie-k8s-gatekeeper-\xfcber-helm",level:3},{value:"2.3.1 Schritt 1: Erstellen Sie das Image",id:"231-schritt-1-erstellen-sie-das-image",level:4},{value:"2.3.2 Helm-Installation",id:"232-helm-installation",level:4},{value:"3. Probieren Sie K8s-Gatekeeper aus",id:"3-probieren-sie-k8s-gatekeeper-aus",level:2},{value:"3.1 Erstellen Sie Casbin-Modell und -Richtlinie",id:"31-erstellen-sie-casbin-modell-und--richtlinie",level:3},{value:"3.1.1 Erstellen/Aktualisieren Sie Casbin-Modell und -Richtlinie \xfcber kubectl",id:"311-erstellenaktualisieren-sie-casbin-modell-und--richtlinie-\xfcber-kubectl",level:4},{value:"3.1.2 Create/Update Casbin Model and Policy via the go-client we provide",id:"312-createupdate-casbin-model-and-policy-via-the-go-client-we-provide",level:4},{value:"3.1.2 Try Whether K8s-gatekeeper Works",id:"312-try-whether-k8s-gatekeeper-works",level:3},{value:"4. How to Write Model and Policy with K8s-gatekeeper",id:"4-how-to-write-model-and-policy-with-k8s-gatekeeper",level:2},{value:"4.1 Request Definition of Model",id:"41-request-definition-of-model",level:3},{value:"4.2 Matcher des Modells",id:"42-matcher-des-modells",level:3},{value:"4.2.1 Erweiterungsfunktionen",id:"421-erweiterungsfunktionen",level:3},{value:"4.2.1.1 Zugriff",id:"4211-zugriff",level:4},{value:"4.2.1.2 accessWithWildcard",id:"4212-accesswithwildcard",level:4},{value:"4.2.1.3 Funktionen, die variable Argumentl\xe4ngen unterst\xfctzen",id:"4213-funktionen-die-variable-argumentl\xe4ngen-unterst\xfctzen",level:3},{value:"4.2.1.2 Typumwandlungsfunktionen",id:"4212-typumwandlungsfunktionen",level:4},{value:"5. Erweiterte Einstellungen",id:"5-erweiterte-einstellungen",level:2},{value:"5.1 \xdcber Zertifikate",id:"51-\xfcber-zertifikate",level:3},{value:"5.1.1 Selbstsignierte Zertifikate",id:"511-selbstsignierte-zertifikate",level:4},{value:"5.1.2 Rechtsg\xfcltige Zertifikate",id:"512-rechtsg\xfcltige-zertifikate",level:4}],u={toc:d};function p(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,i.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"1-\xfcbersicht--dokumente-f\xfcr-casbin-k8s-gatekeeper"},"1. \xdcbersicht & Dokumente f\xfcr Casbin K8s-Gatekeeper"),(0,r.kt)("p",null,"Casbin K8s-GateKeeper ist ein Kubernetes-Zulassungs-Webhook, der Casbin als Zugriffskontrollwerkzeug integriert. Mit Casbin K8s-GateKeeper k\xf6nnen Sie flexible Regeln erstellen, um jede Operation auf K8s-Ressourcen zu autorisieren oder abzufangen, OHNE einen einzigen Code zu schreiben, sondern nur einige Zeilen von deklarativen Konfigurationen von Casbin-Modellen und -Richtlinien, die Teil der Casbin ACL (Access Control List) Sprache sind."),(0,r.kt)("p",null,"Casbin K8s-GateKeeper wird von der Casbin-Community entwickelt und gewartet. Das Repository dieses Projekts ist hier verf\xfcgbar: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/casbin/k8s-gatekeeper"},"https://github.com/casbin/k8s-gatekeeper")),(0,r.kt)("h3",{id:"01-ein-einfaches-beispiel"},"0.1 Ein einfaches Beispiel"),(0,r.kt)("p",null,'Zum Beispiel m\xfcssen Sie keinen Code schreiben, sondern die folgenden Konfigurationszeilen verwenden, um diese Funktion zu erreichen: "Verbieten Sie, dass Bilder mit einigen spezifizierten Tags in beliebigen Bereitstellungen verwendet werden":'),(0,r.kt)("p",null,"Model:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\ncontain(split(accessWithWildcard(${OBJECT}.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n')),(0,r.kt)("p",null,"And Policy:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csv"},'p, "1.14.1",deny\n')),(0,r.kt)("p",null,"Diese sind in gew\xf6hnlicher Casbin ACL Sprache. Angenommen, Sie haben bereits Kapitel dar\xfcber gelesen, dann wird es sehr einfach zu verstehen sein."),(0,r.kt)("p",null,"Casbin K8s-Gatekeeper hat die folgenden Vorteile:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Einfach zu bedienen. Einige Zeilen ACL zu schreiben ist viel besser als viel Code zu schreiben."),(0,r.kt)("li",{parentName:"ul"},"Es erm\xf6glicht hei\xdfe Updates von Konfigurationen. Sie m\xfcssen das gesamte Plugin nicht herunterfahren, um Konfigurationen zu \xe4ndern."),(0,r.kt)("li",{parentName:"ul"},"Es ist flexibel. Beliebige Regeln k\xf6nnen auf jede K8s-Ressource angewendet werden, die mit ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl gatekeeper")," erkundet werden kann."),(0,r.kt)("li",{parentName:"ul"},"Es vereinfacht die Implementierung des K8s-Zulassungs-Webhooks, der sehr kompliziert ist. Sie m\xfcssen nicht wissen, was ein K8s-Zulassungs-Webhook ist oder wie man Code daf\xfcr schreibt. Alles, was Sie tun m\xfcssen, ist zu wissen, auf welche Ressource Sie Einschr\xe4nkungen setzen m\xf6chten und dann Casbin ACL zu schreiben. Jeder wei\xdf, dass K8s komplex ist, aber mit Casbin K8s-Gatekeeper k\xf6nnen Sie Zeit sparen."),(0,r.kt)("li",{parentName:"ul"},"Es wird von der Casbin-Community gewartet. Z\xf6gern Sie nicht, uns zu kontaktieren, wenn Sie etwas \xfcber dieses Plugin verwirrt oder wenn Sie auf Probleme sto\xdfen, wenn Sie es ausprobieren.")),(0,r.kt)("h3",{id:"11-wie-funktioniert-casbin-k8s-gatekeeper"},"1.1 Wie funktioniert Casbin K8s-Gatekeeper?"),(0,r.kt)("p",null,"K8s-Gatekeeper ist ein Zulassungs-Webhook f\xfcr K8s, der ",(0,r.kt)("a",{parentName:"p",href:"/docs/overview"},"Casbin")," verwendet, um willk\xfcrliche benutzerdefinierte Zugriffskontrollregeln anzuwenden, um jede Operation auf K8s zu verhindern, die der Administrator nicht m\xf6chte."),(0,r.kt)("p",null,"Casbin ist eine leistungsstarke und effiziente Open-Source-Zugriffskontrollbibliothek. Es bietet Unterst\xfctzung f\xfcr die Durchsetzung von Autorisierungen basierend auf verschiedenen Zugriffskontrollmodellen. Weitere Details zu Casbin finden Sie unter ",(0,r.kt)("a",{parentName:"p",href:"/docs/overview"},"\xdcbersicht"),"."),(0,r.kt)("p",null,"Zulassungs-Webhooks in K8s sind HTTP-Callbacks, die 'Zulassungsanfragen' erhalten und etwas mit ihnen machen. Insbesondere ist K8s-Gatekeeper eine spezielle Art von Zulassungs-Webhook: 'ValidatingAdmissionWebhook', der entscheiden kann, ob diese Zulassungsanfrage akzeptiert oder abgelehnt wird oder nicht. Bei Zulassungsanfragen handelt es sich um HTTP-Anfragen, die eine Operation an bestimmten Ressourcen von K8s beschreiben (zum Beispiel das Erstellen/L\xf6schen einer Bereitstellung). Weitere Informationen zu Zulassungs-Webhooks finden Sie in der ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#what-are-admission-webhooks"},"offiziellen K8s-Dokumentation"),"."),(0,r.kt)("h3",{id:"12-ein-beispiel-zur-veranschaulichung-der-funktionsweise"},"1.2 Ein Beispiel zur Veranschaulichung der Funktionsweise"),(0,r.kt)("p",null,"Wenn beispielsweise jemand eine Bereitstellung erstellen m\xf6chte, die einen Pod enth\xe4lt, der nginx ausf\xfchrt (mit kubectl oder K8s-Clients), generiert K8s eine Zulassungsanfrage, die (wenn sie in YAML-Format \xfcbersetzt wird) so aussehen k\xf6nnte:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-deployment\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.14.1\n        ports:\n        - containerPort: 80\n")),(0,r.kt)("p",null,"Diese Anfrage durchl\xe4uft den Prozess aller in der Abbildung gezeigten Middleware, einschlie\xdflich unseres K8s-Gatekeepers. K8s-Gatekeeper kann alle Casbin-Durchsetzer erkennen, die in K8s's etcd gespeichert sind, die vom Benutzer erstellt und gewartet werden (\xfcber ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl")," oder den von uns bereitgestellten Go-Client). Jeder Durchsetzer enth\xe4lt ein Casbin-Modell und eine Casbin-Richtlinie. Die Zulassungsanfrage wird von jedem Durchsetzer einzeln bearbeitet, und nur durch das Bestehen aller Durchsetzer kann eine Anfrage von diesem K8s-Gatekeeper akzeptiert werden."),(0,r.kt)("p",null,"(Wenn Sie nicht verstehen, was ein Casbin-Durchsetzer, Modell oder Richtlinie ist, sehen Sie dieses Dokument: ",(0,r.kt)("a",{parentName:"p",href:"/docs/get-started"},"Erste Schritte"),")."),(0,r.kt)("p",null,"Zum Beispiel m\xf6chte der Administrator aus irgendeinem Grund das Auftreten des Bildes 'nginx:1.14.1' verbieten, w\xe4hrend 'nginx:1.3.1' erlaubt ist. Es kann ein Durchsetzer erstellt werden, der die folgende Regel und Richtlinie enth\xe4lt (Wir werden erkl\xe4ren, wie man einen Durchsetzer erstellt, was diese Modelle und Richtlinien sind und wie man sie in den folgenden Kapiteln schreibt)."),(0,r.kt)("p",null,"Model:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n\n')),(0,r.kt)("p",null,"Policy:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csv"},'p, "nginx:1.13.1",allow\np, "nginx:1.14.1",deny\n')),(0,r.kt)("p",null,"Durch das Erstellen eines Durchsetzers, der das oben genannte Modell und die Richtlinie enth\xe4lt, wird die vorherige Zulassungsanfrage von diesem Durchsetzer abgelehnt, was bedeutet, dass K8s diese Bereitstellung nicht erstellen wird."),(0,r.kt)("h2",{id:"2-installieren-sie-k8s-gatekeeper"},"2 Installieren Sie K8s-Gatekeeper"),(0,r.kt)("p",null,"Es stehen drei Methoden zur Verf\xfcgung, um K8s-Gatekeeper zu installieren: Externer Webhook, Interner Webhook und Helm."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Hinweis: Diese Methoden sind nur dazu gedacht, dass Benutzer K8s-Gatekeeper ausprobieren k\xf6nnen und sind nicht sicher. Wenn Sie es in einer produktiven Umgebung verwenden m\xf6chten, stellen Sie bitte sicher, dass Sie ",(0,r.kt)("a",{parentName:"p",href:"#5-advanced-settings"},"Kapitel 5. Erweiterte Einstellungen")," lesen und vor der Installation alle notwendigen \xc4nderungen vornehmen.")),(0,r.kt)("h3",{id:"21-interner-webhook"},"2.1 Interner Webhook"),(0,r.kt)("h4",{id:"211-schritt-1-erstellen-sie-das-image"},"2.1.1 Schritt 1: Erstellen Sie das Image"),(0,r.kt)("p",null,"Bei der internen Webhook-Methode wird der Webhook selbst als Dienst innerhalb von Kubernetes implementiert. Um den notwendigen Dienst und die Bereitstellung zu erstellen, m\xfcssen Sie ein Image von K8s-Gatekeeper erstellen. Sie k\xf6nnen Ihr eigenes Image erstellen, indem Sie den folgenden Befehl ausf\xfchren:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"docker build --target webhook -t k8s-gatekeeper .\n")),(0,r.kt)("p",null,"Dieser Befehl erstellt ein lokales Image namens 'k8s-gatekeeper:latest'."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Hinweis: Wenn Sie minikube verwenden, f\xfchren Sie bitte ",(0,r.kt)("inlineCode",{parentName:"p"},"eval $(minikube -p minikube docker-env)")," aus, bevor Sie 'docker build' ausf\xfchren.")),(0,r.kt)("h4",{id:"212-schritt-2-richten-sie-dienste-und-bereitstellungen-f\xfcr-k8s-gatekeeper-ein"},"2.1.2 Schritt 2: Richten Sie Dienste und Bereitstellungen f\xfcr K8s-Gatekeeper ein"),(0,r.kt)("p",null,"F\xfchren Sie die folgenden Befehle aus:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f config/rbac.yaml\nkubectl apply -f config/webhook_deployment.yaml \nkubectl apply -f config/webhook_internal.yaml \n")),(0,r.kt)("p",null,"Dies startet K8s-Gatekeeper, und Sie k\xf6nnen dies best\xe4tigen, indem Sie ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl get pods")," ausf\xfchren."),(0,r.kt)("h4",{id:"213-schritt-3-installieren-sie-crd-ressourcen-f\xfcr-k8s-gatekeeper"},"2.1.3 Schritt 3: Installieren Sie CRD-Ressourcen f\xfcr K8s-Gatekeeper"),(0,r.kt)("p",null,"F\xfchren Sie die folgenden Befehle aus:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\n")),(0,r.kt)("h3",{id:"22-externer-webhook"},"2.2 Externer Webhook"),(0,r.kt)("p",null,"F\xfcr die Methode des externen Webhooks wird K8s-Gatekeeper au\xdferhalb von Kubernetes laufen, und Kubernetes wird auf K8s-Gatekeeper zugreifen, wie es auf eine regul\xe4re Website zugreifen w\xfcrde. Kubernetes hat eine obligatorische Anforderung, dass der Zulassungs-Webhook HTTPS sein muss. Zum Ausprobieren von K8s-Gatekeeper haben wir ein Set von Zertifikaten und einen privaten Schl\xfcssel bereitgestellt (obwohl dies nicht sicher ist). Wenn Sie lieber Ihr eigenes Zertifikat verwenden m\xf6chten, verweisen Sie bitte auf ",(0,r.kt)("a",{parentName:"p",href:"#5-advanced-settings"},"Kapitel 5. Erweiterte Einstellungen")," f\xfcr Anweisungen zur Anpassung des Zertifikats und des privaten Schl\xfcssels."),(0,r.kt)("p",null,"Das von uns bereitgestellte Zertifikat ist f\xfcr 'webhook.domain.local' ausgestellt. \xc4ndern Sie also den Host (z.B. /etc/hosts) und leiten Sie 'webhook.domain.local' an die IP-Adresse weiter, auf der K8s-Gatekeeper l\xe4uft."),(0,r.kt)("p",null,"F\xfchren Sie dann den folgenden Befehl aus:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"go mod tidy\ngo mod vendor\ngo run cmd/webhook/main.go\nkubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\nkubectl apply -f config/webhook_external.yaml \n")),(0,r.kt)("h3",{id:"23-installieren-sie-k8s-gatekeeper-\xfcber-helm"},"2.3 Installieren Sie K8s-Gatekeeper \xfcber Helm"),(0,r.kt)("h4",{id:"231-schritt-1-erstellen-sie-das-image"},"2.3.1 Schritt 1: Erstellen Sie das Image"),(0,r.kt)("p",null,"Bitte verweisen Sie auf ",(0,r.kt)("a",{parentName:"p",href:"#211-step-1-build-the-image"},"Kapitel 2.1.1"),"."),(0,r.kt)("h4",{id:"232-helm-installation"},"2.3.2 Helm-Installation"),(0,r.kt)("p",null,"F\xfchren Sie den Befehl ",(0,r.kt)("inlineCode",{parentName:"p"},"helm install k8sgatekeeper ./k8sgatekeeper")," aus."),(0,r.kt)("h2",{id:"3-probieren-sie-k8s-gatekeeper-aus"},"3. Probieren Sie K8s-Gatekeeper aus"),(0,r.kt)("h3",{id:"31-erstellen-sie-casbin-modell-und--richtlinie"},"3.1 Erstellen Sie Casbin-Modell und -Richtlinie"),(0,r.kt)("p",null,"Sie haben zwei Methoden, um ein Modell und eine Richtlinie zu erstellen: \xfcber kubectl oder \xfcber den von uns bereitgestellten go-client."),(0,r.kt)("h4",{id:"311-erstellenaktualisieren-sie-casbin-modell-und--richtlinie-\xfcber-kubectl"},"3.1.1 Erstellen/Aktualisieren Sie Casbin-Modell und -Richtlinie \xfcber kubectl"),(0,r.kt)("p",null,"In K8s-Gatekeeper wird das Casbin-Modell in einer CRD-Ressource namens 'CasbinModel' gespeichert. Seine Definition befindet sich in ",(0,r.kt)("inlineCode",{parentName:"p"},"config/auth.casbin.org_casbinmodels.yaml"),"."),(0,r.kt)("p",null,"Es gibt Beispiele in ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/model.yaml"),". Achten Sie auf die folgenden Felder:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"metadata.name: der Name des Modells. Dieser Name MUSS der gleiche sein wie der Name des CasbinPolicy-Objekts, das mit diesem Modell in Verbindung steht, damit K8s-Gatekeeper sie zuordnen und einen Durchsetzer erstellen kann."),(0,r.kt)("li",{parentName:"ul"},'spec.enable: Wenn dieses Feld auf "false" gesetzt ist, wird dieses Modell (sowie das CasbinPolicy-Objekt, das mit diesem Modell in Verbindung steht) ignoriert.'),(0,r.kt)("li",{parentName:"ul"},"spec.modelText: eine Zeichenkette, die den Modelltext eines Casbin-Modells enth\xe4lt.")),(0,r.kt)("p",null,"Die Casbin-Richtlinie wird in einer anderen CRD-Ressource namens 'CasbinPolicy' gespeichert, deren Definition in ",(0,r.kt)("inlineCode",{parentName:"p"},"config/auth.casbin.org_casbinpolicies.yaml")," gefunden werden kann."),(0,r.kt)("p",null,"Es gibt Beispiele in ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/policy.yaml"),". Achten Sie auf die folgenden Felder:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"metadata.name: the name of the policy. This name MUST be the same as the name of the CasbinModel object related to this policy, so that K8s-gatekeeper can pair them and create an enforcer."),(0,r.kt)("li",{parentName:"ul"},"spec.policyItem: a string that contains the policy text of a Casbin model.")),(0,r.kt)("p",null,"After creating your own CasbinModel and CasbinPolicy files, use the following command to apply them:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f <filename>\n")),(0,r.kt)("p",null,"Once a pair of CasbinModel and CasbinPolicy is created, K8s-gatekeeper will be able to detect it within 5 seconds."),(0,r.kt)("h4",{id:"312-createupdate-casbin-model-and-policy-via-the-go-client-we-provide"},"3.1.2 Create/Update Casbin Model and Policy via the go-client we provide"),(0,r.kt)("p",null,"We understand that there may be situations where it is not convenient to use the shell to execute commands directly on a node of the K8s cluster, such as when you are building an automatic cloud platform for your corporation. Therefore, we have developed a go-client to create and maintain CasbinModel and CasbinPolicy."),(0,r.kt)("p",null,"The go-client library is located in ",(0,r.kt)("inlineCode",{parentName:"p"},"pkg/client"),"."),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"client.go"),", we provide a function to create a client."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func NewK8sGateKeeperClient(externalClient bool) (*K8sGateKeeperClient, error) \n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"externalClient")," parameter determines whether K8s-gatekeeper is running inside the K8s cluster or not."),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"model.go"),", we provide various functions to create, delete, and modify CasbinModel. You can find out how to use these interfaces in ",(0,r.kt)("inlineCode",{parentName:"p"},"model_test.go"),"."),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"policy.go"),", we provide various functions to create, delete, and modify CasbiPolicy. You can find out how to use these interfaces in ",(0,r.kt)("inlineCode",{parentName:"p"},"policy_test.go"),"."),(0,r.kt)("h3",{id:"312-try-whether-k8s-gatekeeper-works"},"3.1.2 Try Whether K8s-gatekeeper Works"),(0,r.kt)("p",null,"Suppose you have already created the exact model and policy in ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo"),". Now, try the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f example/allowed_repo/testcase/reject_1.yaml\n")),(0,r.kt)("p",null,"You should find that K8s will reject this request and mention that the webhook was the reason why this request is rejected. However, when you try to apply ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/testcase/approve_2.yaml"),", it will be accepted."),(0,r.kt)("h2",{id:"4-how-to-write-model-and-policy-with-k8s-gatekeeper"},"4. How to Write Model and Policy with K8s-gatekeeper"),(0,r.kt)("p",null,"First of all, make sure you are familiar with the basic grammar of Casbin Models and Policies. If you are not, please read the ",(0,r.kt)("a",{parentName:"p",href:"/docs/get-started"},"Get Started")," section first. In this chapter, we assume that you already understand what Casbin Models and Policies are."),(0,r.kt)("h3",{id:"41-request-definition-of-model"},"4.1 Request Definition of Model"),(0,r.kt)("p",null,"When K8s-gatekeeper is authorizing a request, the input is always an object: the Go object of the Admission Request. This means that the enforcer will always be used like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"ok, err := enforcer.Enforce(admission)\n")),(0,r.kt)("p",null,"where ",(0,r.kt)("inlineCode",{parentName:"p"},"admission")," is an ",(0,r.kt)("inlineCode",{parentName:"p"},"AdmissionReview")," object defined by K8s's official go api ",(0,r.kt)("inlineCode",{parentName:"p"},'"k8s.io/api/admission/v1"'),". You can find the definition of this struct in this repository: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/api/blob/master/admission/v1/types.go"},"https://github.com/kubernetes/api/blob/master/admission/v1/types.go"),". F\xfcr weitere Informationen k\xf6nnen Sie auch auf ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response"},"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response")," verweisen."),(0,r.kt)("p",null,"Daher sollte f\xfcr jedes Modell, das von K8s-Gatekeeper verwendet wird, die Definition der ",(0,r.kt)("inlineCode",{parentName:"p"},"request_definition")," immer so aussehen:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},"    [request_definition]\n    r =  obj\n")),(0,r.kt)("p",null,"Der Name 'obj' ist nicht obligatorisch, solange der Name mit dem Namen in dem Teil ",(0,r.kt)("inlineCode",{parentName:"p"},"[matchers]")," \xfcbereinstimmt."),(0,r.kt)("h3",{id:"42-matcher-des-modells"},"4.2 Matcher des Modells"),(0,r.kt)("p",null,"Sie sollten die ABAC-Funktion von Casbin verwenden, um Ihre Regeln zu schreiben. Der in Casbin integrierte Ausdrucksauswerter unterst\xfctzt jedoch keine Indizierung in Karten oder Arrays (Slices) oder die Erweiterung von Arrays. Daher bietet K8s-Gatekeeper verschiedene 'Casbin-Funktionen' als Erweiterungen an, um diese Funktionen zu implementieren. Wenn Sie immer noch feststellen, dass Ihre Anforderungen nicht durch diese Erweiterungen erf\xfcllt werden k\xf6nnen, z\xf6gern Sie nicht, ein Problem zu starten oder einen Pull-Request zu erstellen."),(0,r.kt)("p",null,"Wenn Sie mit Casbin-Funktionen nicht vertraut sind, k\xf6nnen Sie sich f\xfcr weitere Informationen auf ",(0,r.kt)("a",{parentName:"p",href:"/docs/function"},"Function")," beziehen."),(0,r.kt)("p",null,"Hier sind die Erweiterungsfunktionen:"),(0,r.kt)("h3",{id:"421-erweiterungsfunktionen"},"4.2.1 Erweiterungsfunktionen"),(0,r.kt)("h4",{id:"4211-zugriff"},"4.2.1.1 Zugriff"),(0,r.kt)("p",null,"Access wird verwendet, um das Problem zu l\xf6sen, dass Casbin keine Indizierung in Karten oder Arrays unterst\xfctzt. Das Beispiel ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/model.yaml")," demonstriert die Verwendung dieser Funktion:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n')),(0,r.kt)("p",null,"In diesem Matcher ist ",(0,r.kt)("inlineCode",{parentName:"p"},'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image")')," gleichbedeutend mit ",(0,r.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Image"),", wobei ",(0,r.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers")," ein Slice ist."),(0,r.kt)("p",null,"Access kann auch einfache Funktionen aufrufen, die keine Parameter haben und einen einzelnen Wert zur\xfcckgeben. Das Beispiel ",(0,r.kt)("inlineCode",{parentName:"p"},"example/container_resource_limit/model.yaml")," demonstriert dies:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'[matchers]\n  m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")) >= parseFloat(p.cpu) && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","memory","Value")) >= parseFloat(p.memory)\n')),(0,r.kt)("p",null,"In diesem Matcher ist ",(0,r.kt)("inlineCode",{parentName:"p"},'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")')," gleichbedeutend mit ",(0,r.kt)("inlineCode",{parentName:"p"},'r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits["cpu"].Value()'),", wobei ",(0,r.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits")," eine Karte ist und ",(0,r.kt)("inlineCode",{parentName:"p"},"Value()")," eine einfache Funktion ist, die keine Parameter hat und einen einzelnen Wert zur\xfcckgibt."),(0,r.kt)("h4",{id:"4212-accesswithwildcard"},"4.2.1.2 accessWithWildcard"),(0,r.kt)("p",null,'Manchmal haben Sie vielleicht eine Anforderung wie diese: Alle Elemente in einem Array m\xfcssen ein Pr\xe4fix "aaa" haben. Casbin unterst\xfctzt jedoch keine ',(0,r.kt)("inlineCode",{parentName:"p"},"for"),"-Schleifen. Mit ",(0,r.kt)("inlineCode",{parentName:"p"},"accessWithWildcard"),' und der Funktion "Karten-/Slice-Erweiterung" k\xf6nnen Sie eine solche Anforderung leicht umsetzen.'),(0,r.kt)("p",null,"Zum Beispiel, angenommen ",(0,r.kt)("inlineCode",{parentName:"p"},"a.b.c")," ist ein Array ",(0,r.kt)("inlineCode",{parentName:"p"},"[aaa,bbb,ccc,ddd,eee]"),", dann wird das Ergebnis von ",(0,r.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(a,"b","c","*")')," ein Slice ",(0,r.kt)("inlineCode",{parentName:"p"},"[aaa,bbb,ccc,ddd,eee]")," sein. Durch die Verwendung des Wildcards ",(0,r.kt)("inlineCode",{parentName:"p"},"*")," wird das Slice erweitert."),(0,r.kt)("p",null,"Ebenso kann das Wildcard mehr als einmal verwendet werden. Zum Beispiel wird das Ergebnis von ",(0,r.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(a,"b","c","*","*")')," ",(0,r.kt)("inlineCode",{parentName:"p"},"[a.b.c[0][0], a.b.c[0][1], ..., a.b.c[1][0], a.b.c[1][1], ...]")," sein."),(0,r.kt)("h3",{id:"4213-funktionen-die-variable-argumentl\xe4ngen-unterst\xfctzen"},"4.2.1.3 Funktionen, die variable Argumentl\xe4ngen unterst\xfctzen"),(0,r.kt)("p",null,"Im Ausdrucksauswerter von Casbin wird ein Parameter, der ein Array ist, automatisch als Argument mit variabler L\xe4nge erweitert. Unter Ausnutzung dieser Funktion zur Unterst\xfctzung der Array-/Slice-/Karten-Erweiterung haben wir auch mehrere Funktionen integriert, die ein Array/Slice als Parameter akzeptieren:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"contain(): akzeptiert mehrere Parameter und gibt zur\xfcck, ob ein beliebiger Parameter (au\xdfer dem letzten Parameter) dem letzten Parameter entspricht."),(0,r.kt)("li",{parentName:"ul"},"split(a,b,c...,sep,index): gibt eine Scheibe zur\xfcck, die ",(0,r.kt)("inlineCode",{parentName:"li"},"[splits(a,sep)[index], splits(b,sep)[index], splits(a,sep)[index], ...]")," enth\xe4lt."),(0,r.kt)("li",{parentName:"ul"},"len(): gibt die L\xe4nge des variablen Arguments zur\xfcck."),(0,r.kt)("li",{parentName:"ul"},"matchRegex(a,b,c...,regex): gibt zur\xfcck, ob alle gegebenen Parameter (",(0,r.kt)("inlineCode",{parentName:"li"},"a"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"b"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"c"),", ...) dem gegebenen Regex entsprechen.")),(0,r.kt)("p",null,"Hier ist ein Beispiel in ",(0,r.kt)("inlineCode",{parentName:"p"},"example/disallowed_tag/model.yaml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'    [matchers]\n    m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n    contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n')),(0,r.kt)("p",null,"Angenommen, dass ",(0,r.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image")')," ",(0,r.kt)("inlineCode",{parentName:"p"},'["a:b", "c:d", "e:f", "g:h"]')," zur\xfcckgibt, weil splits variable Argumente unterst\xfctzt und die Split-Operation auf jedem Element durchf\xfchrt, wird das Element am Index 1 ausgew\xe4hlt und zur\xfcckgegeben. Daher gibt ",(0,r.kt)("inlineCode",{parentName:"p"},'split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1)')," ",(0,r.kt)("inlineCode",{parentName:"p"},'["b","d","f","h"]')," zur\xfcck. Und ",(0,r.kt)("inlineCode",{parentName:"p"},'contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)')," gibt zur\xfcck, ob ",(0,r.kt)("inlineCode",{parentName:"p"},"p.obj")," in ",(0,r.kt)("inlineCode",{parentName:"p"},'["b","d","f","h"]')," enthalten ist."),(0,r.kt)("h4",{id:"4212-typumwandlungsfunktionen"},"4.2.1.2 Typumwandlungsfunktionen"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"ParseFloat(): Parst eine Ganzzahl zu einer Gleitkommazahl (dies ist notwendig, weil jede in einem Vergleich verwendete Zahl in eine Gleitkommazahl umgewandelt werden muss)."),(0,r.kt)("li",{parentName:"ul"},"ToString(): Konvertiert ein Objekt zu einem String. Dieses Objekt muss einen Basistyp von String haben (zum Beispiel ein Objekt vom Typ ",(0,r.kt)("inlineCode",{parentName:"li"},"XXX"),", wenn es eine Aussage ",(0,r.kt)("inlineCode",{parentName:"li"},"type XXX string")," gibt)."),(0,r.kt)("li",{parentName:"ul"},"IsNil(): Gibt zur\xfcck, ob der Parameter nil ist.")),(0,r.kt)("h2",{id:"5-erweiterte-einstellungen"},"5. Erweiterte Einstellungen"),(0,r.kt)("h3",{id:"51-\xfcber-zertifikate"},"5.1 \xdcber Zertifikate"),(0,r.kt)("p",null,"In Kubernetes (k8s) ist es obligatorisch, dass ein Webhook HTTPS verwenden sollte. Es gibt zwei Ans\xe4tze, um dies zu erreichen:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verwendung von selbstsignierten Zertifikaten (Beispiele in diesem Repository verwenden diese Methode)"),(0,r.kt)("li",{parentName:"ul"},"Verwendung eines normalen Zertifikats")),(0,r.kt)("h4",{id:"511-selbstsignierte-zertifikate"},"5.1.1 Selbstsignierte Zertifikate"),(0,r.kt)("p",null,"Die Verwendung eines selbstsignierten Zertifikats bedeutet, dass die ausstellende Zertifizierungsstelle (CA) nicht eine der bekannten CAs ist. Daher m\xfcssen Sie k8s \xfcber diese CA informieren."),(0,r.kt)("p",null,"Derzeit verwendet das Beispiel in diesem Repository eine selbstgemachte CA, deren privater Schl\xfcssel und Zertifikat in ",(0,r.kt)("inlineCode",{parentName:"p"},"config/certificate/ca.crt")," und ",(0,r.kt)("inlineCode",{parentName:"p"},"config/certificate/ca.key")," gespeichert sind. Das Zertifikat f\xfcr den Webhook ist ",(0,r.kt)("inlineCode",{parentName:"p"},"config/certificate/server.crt"),', das von der selbstgemachten CA ausgestellt wird. Die Domains dieses Zertifikats sind "webhook.domain.local" (f\xfcr externen Webhook) und "casbin-webhook-svc.default.svc" (f\xfcr internen Webhook).'),(0,r.kt)("p",null,"Informationen \xfcber die CA werden \xfcber die Webhook-Konfigurationsdateien an k8s weitergegeben. Sowohl ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," als auch ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml"),' haben ein Feld namens "CABundle", das eine base64-kodierte Zeichenkette des Zertifikats der CA enth\xe4lt.'),(0,r.kt)("p",null,"Falls Sie das Zertifikat/die Domain \xe4ndern m\xfcssen (zum Beispiel, wenn Sie diesen Webhook in einen anderen Namespace von k8s verschieben m\xf6chten, w\xe4hrend Sie einen internen Webhook verwenden, oder wenn Sie die Domain \xe4ndern m\xf6chten, w\xe4hrend Sie einen externen Webhook verwenden), sollten die folgenden Verfahren befolgt werden:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Erzeugen Sie eine neue CA:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Generieren Sie den privaten Schl\xfcssel f\xfcr die gef\xe4lschte CA:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl genrsa -des3 -out ca.key 2048\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Entfernen Sie den Passwortschutz des privaten Schl\xfcssels:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl rsa -in ca.key -out ca.key\n"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Generieren Sie einen privaten Schl\xfcssel f\xfcr den Webhook-Server:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl genrsa -des3 -out server.key 2048\nopenssl rsa -in server.key -out server.key\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Verwenden Sie die selbst generierte CA, um das Zertifikat f\xfcr den Webhook zu signieren:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Kopieren Sie die OpenSSL-Konfigurationsdatei Ihres Systems f\xfcr den vor\xfcbergehenden Gebrauch. Sie k\xf6nnen den Speicherort der Konfigurationsdatei herausfinden, indem Sie ",(0,r.kt)("inlineCode",{parentName:"p"},"openssl version -a")," ausf\xfchren, normalerweise ",(0,r.kt)("inlineCode",{parentName:"p"},"openssl.cnf")," genannt.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"In der Konfigurationsdatei:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Finden Sie den Absatz ",(0,r.kt)("inlineCode",{parentName:"p"},"[req]")," und f\xfcgen Sie die folgende Zeile hinzu: ",(0,r.kt)("inlineCode",{parentName:"p"},"req_extensions = v3_req"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Finden Sie den Absatz ",(0,r.kt)("inlineCode",{parentName:"p"},"[v3_req]")," und f\xfcgen Sie die folgende Zeile hinzu: ",(0,r.kt)("inlineCode",{parentName:"p"},"subjectAltName = @alt_names"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"F\xfcgen Sie die folgenden Zeilen zur Datei hinzu:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ini"},"[alt_names]\nDNS.2=<The domain you want>\n")),(0,r.kt)("p",{parentName:"li"},"Hinweis: Ersetzen Sie 'casbin-webhook-svc.default.svc' durch den echten Dienstnamen Ihres eigenen Dienstes, wenn Sie den Dienstnamen \xe4ndern m\xf6chten.")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Verwenden Sie die modifizierte Konfigurationsdatei, um eine Zertifikatsanforderungsdatei zu generieren:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl req -new -nodes -keyout server.key -out server.csr -config openssl.cnf\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Verwenden Sie die selbstgemachte CA, um auf die Anfrage zu reagieren und das Zertifikat zu signieren:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl x509 -req -days 3650 -in server.csr -out server.crt -CA ca.crt -CAkey ca.key -CAcreateserial -extensions v3_req -extensions SAN -extfile openssl.cnf\n"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Ersetzen Sie das Feld 'CABundle': Sowohl ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," als auch ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml")," haben ein Feld namens 'CABundle', das eine base64-kodierte Zeichenkette des Zertifikats der CA enth\xe4lt. Aktualisieren Sie dieses Feld mit dem neuen Zertifikat.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Wenn Sie Helm verwenden, m\xfcssen \xe4hnliche \xc4nderungen an den Helm-Charts vorgenommen werden."))),(0,r.kt)("h4",{id:"512-rechtsg\xfcltige-zertifikate"},"5.1.2 Rechtsg\xfcltige Zertifikate"),(0,r.kt)("p",null,"Wenn Sie rechtsg\xfcltige Zertifikate verwenden, m\xfcssen Sie nicht alle diese Verfahren durchlaufen. Entfernen Sie das Feld 'CABundle' in ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," und ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml")," und \xe4ndern Sie die Domain in diesen Dateien in die Domain, die Sie besitzen."))}p.isMDXComponent=!0}}]);