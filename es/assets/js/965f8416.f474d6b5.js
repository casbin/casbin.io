"use strict";(self.webpackChunkcasbin_website_v2=self.webpackChunkcasbin_website_v2||[]).push([[9993],{3905:(e,a,n)=>{n.d(a,{Zo:()=>p,kt:()=>m});var o=n(7294);function t(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function i(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);a&&(o=o.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?i(Object(n),!0).forEach((function(a){t(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function s(e,a){if(null==e)return{};var n,o,t=function(e,a){if(null==e)return{};var n,o,t={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],a.indexOf(n)>=0||(t[n]=e[n]);return t}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(t[n]=e[n])}return t}var l=o.createContext({}),c=function(e){var a=o.useContext(l),n=a;return e&&(n="function"==typeof e?e(a):r(r({},a),e)),n},p=function(e){var a=c(e.components);return o.createElement(l.Provider,{value:a},e.children)},d={inlineCode:"code",wrapper:function(e){var a=e.children;return o.createElement(o.Fragment,{},a)}},u=o.forwardRef((function(e,a){var n=e.components,t=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),m=t,k=u["".concat(l,".").concat(m)]||u[m]||d[m]||i;return n?o.createElement(k,r(r({ref:a},p),{},{components:n})):o.createElement(k,r({ref:a},p))}));function m(e,a){var n=arguments,t=a&&a.mdxType;if("string"==typeof e||t){var i=n.length,r=new Array(i);r[0]=u;var s={};for(var l in a)hasOwnProperty.call(a,l)&&(s[l]=a[l]);s.originalType=e,s.mdxType="string"==typeof e?e:t,r[1]=s;for(var c=2;c<i;c++)r[c]=n[c];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},7061:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var o=n(7462),t=(n(7294),n(3905));const i={id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Middleware de Autorizaci\xf3n RBAC & ABAC de Kubernetes (K8s) basado en Casbin",keywords:["k8s-gatekeeper","Kubernetes","K8s"],authors:["ComradeProgrammer"]},r=void 0,s={unversionedId:"k8s-gatekeeper",id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Middleware de Autorizaci\xf3n RBAC & ABAC de Kubernetes (K8s) basado en Casbin",source:"@site/i18n/es/docusaurus-plugin-content-docs/current/K8sGateKeeper.mdx",sourceDirName:".",slug:"/k8s-gatekeeper",permalink:"/es/docs/k8s-gatekeeper",draft:!1,editUrl:"https://github.com/casbin/casbin-website-v2/edit/master/docs/K8sGateKeeper.mdx",tags:[],version:"current",frontMatter:{id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Middleware de Autorizaci\xf3n RBAC & ABAC de Kubernetes (K8s) basado en Casbin",keywords:["k8s-gatekeeper","Kubernetes","K8s"],authors:["ComradeProgrammer"]},sidebar:"docs",previous:{title:"Authorization of Kubernetes",permalink:"/es/docs/k8s"},next:{title:"Authorization of Service Mesh through Envoy",permalink:"/es/docs/envoy"}},l={},c=[{value:"1. Visi\xf3n general y Documentos para Casbin K8s-Gatekeeper",id:"1-visi\xf3n-general-y-documentos-para-casbin-k8s-gatekeeper",level:2},{value:"0.1 Un Ejemplo Simple",id:"01-un-ejemplo-simple",level:3},{value:"1.1 \xbfC\xf3mo Funciona Casbin K8s-Gatekeeper?",id:"11-c\xf3mo-funciona-casbin-k8s-gatekeeper",level:3},{value:"1.2 Un Ejemplo Ilustrativo de C\xf3mo Funciona",id:"12-un-ejemplo-ilustrativo-de-c\xf3mo-funciona",level:3},{value:"2 Instalar K8s-gatekeeper",id:"2-instalar-k8s-gatekeeper",level:2},{value:"2.1.1 Paso 1: Construir la imagen",id:"211-paso-1-construir-la-imagen",level:3},{value:"2.1.1 Paso 1: Construir la imagen",id:"211-paso-1-construir-la-imagen-1",level:4},{value:"2.1.2 Paso 2: Configurar servicios y despliegues para K8s-gatekeeper",id:"212-paso-2-configurar-servicios-y-despliegues-para-k8s-gatekeeper",level:4},{value:"2.1.3 Paso 3: Instalar Recursos CRD para K8s-gatekeeper",id:"213-paso-3-instalar-recursos-crd-para-k8s-gatekeeper",level:4},{value:"2.2 Webhook externo",id:"22-webhook-externo",level:3},{value:"2.3.1 Paso 1: Construir la imagen",id:"231-paso-1-construir-la-imagen",level:3},{value:"Por favor consulta el Cap\xedtulo 2.1.1.",id:"por-favor-consulta-el-cap\xedtulo-211",level:4},{value:"Ejecuta el comando <code>helm install k8sgatekeeper ./k8sgatekeeper</code>.",id:"ejecuta-el-comando-helm-install-k8sgatekeeper-k8sgatekeeper",level:4},{value:"Prueba K8s-gatekeeper 3.1 Crear Modelo y Pol\xedtica de Casbin",id:"prueba-k8s-gatekeeper-31-crear-modelo-y-pol\xedtica-de-casbin",level:2},{value:"Tienes dos m\xe9todos para crear un modelo y pol\xedtica: a trav\xe9s de kubectl o a trav\xe9s del cliente go que proporcionamos.",id:"tienes-dos-m\xe9todos-para-crear-un-modelo-y-pol\xedtica-a-trav\xe9s-de-kubectl-o-a-trav\xe9s-del-cliente-go-que-proporcionamos",level:3},{value:"En K8s-gatekeeper, el modelo de Casbin se almacena en un recurso CRD llamado &#39;CasbinModel&#39;.",id:"en-k8s-gatekeeper-el-modelo-de-casbin-se-almacena-en-un-recurso-crd-llamado-casbinmodel",level:4},{value:"Entendemos que puede haber situaciones en las que no sea conveniente usar la shell para ejecutar comandos directamente en un nodo del cl\xfaster de K8s, como cuando est\xe1s construyendo una plataforma en la nube autom\xe1tica para tu corporaci\xf3n.",id:"entendemos-que-puede-haber-situaciones-en-las-que-no-sea-conveniente-usar-la-shell-para-ejecutar-comandos-directamente-en-un-nodo-del-cl\xfaster-de-k8s-como-cuando-est\xe1s-construyendo-una-plataforma-en-la-nube-autom\xe1tica-para-tu-corporaci\xf3n",level:4},{value:"3.1.2 Prueba si K8s-gatekeeper funciona",id:"312-prueba-si-k8s-gatekeeper-funciona",level:3},{value:"4. C\xf3mo Escribir Modelo y Pol\xedtica con K8s-gatekeeper",id:"4-c\xf3mo-escribir-modelo-y-pol\xedtica-con-k8s-gatekeeper",level:2},{value:"4.1 Definici\xf3n de Solicitud de Modelo",id:"41-definici\xf3n-de-solicitud-de-modelo",level:3},{value:"4.2 Coincidencias de Modelo",id:"42-coincidencias-de-modelo",level:3},{value:"4.2.1 Funciones de extensi\xf3n",id:"421-funciones-de-extensi\xf3n",level:3},{value:"4.2.1.1 access",id:"4211-access",level:4},{value:"4.2.1.2 accessWithWildcard",id:"4212-accesswithwildcard",level:4},{value:"4.2.1.3 Funciones que admiten argumentos de longitud variable",id:"4213-funciones-que-admiten-argumentos-de-longitud-variable",level:3},{value:"4.2.1.2 Funciones de Conversi\xf3n de Tipos",id:"4212-funciones-de-conversi\xf3n-de-tipos",level:4},{value:"5. Configuraci\xf3n Avanzada",id:"5-configuraci\xf3n-avanzada",level:2},{value:"5.1 Acerca de los Certificados",id:"51-acerca-de-los-certificados",level:3},{value:"5.1.1 Certificados autofirmados",id:"511-certificados-autofirmados",level:4},{value:"Si est\xe1s usando helm, se deben aplicar cambios similares a los gr\xe1ficos de helm.",id:"si-est\xe1s-usando-helm-se-deben-aplicar-cambios-similares-a-los-gr\xe1ficos-de-helm",level:4}],p={toc:c};function d(e){let{components:a,...n}=e;return(0,t.kt)("wrapper",(0,o.Z)({},p,n,{components:a,mdxType:"MDXLayout"}),(0,t.kt)("h2",{id:"1-visi\xf3n-general-y-documentos-para-casbin-k8s-gatekeeper"},"1. Visi\xf3n general y Documentos para Casbin K8s-Gatekeeper"),(0,t.kt)("p",null,"Casbin K8s-GateKeeper es un webhook de admisi\xf3n de Kubernetes que integra Casbin como herramienta de Control de Acceso. Al usar Casbin K8s-GateKeeper, puedes establecer reglas flexibles para autorizar o interceptar cualquier operaci\xf3n en recursos de K8s, SIN escribir ninguna l\xednea de c\xf3digo, sino solo varias l\xedneas de configuraciones declarativas de modelos y pol\xedticas de Casbin, que son parte del lenguaje de Lista de Control de Acceso (ACL) de Casbin."),(0,t.kt)("p",null,"Casbin K8s-GateKeeper es desarrollado y mantenido por la comunidad de Casbin. El repositorio de este proyecto est\xe1 disponible aqu\xed: ",(0,t.kt)("a",{parentName:"p",href:"https://github.com/casbin/k8s-gatekeeper"},"https://github.com/casbin/k8s-gatekeeper")),(0,t.kt)("h3",{id:"01-un-ejemplo-simple"},"0.1 Un Ejemplo Simple"),(0,t.kt)("p",null,'Por ejemplo, no necesitas escribir ning\xfan c\xf3digo, sino usar las siguientes l\xedneas de configuraci\xf3n para lograr esta funci\xf3n: "Prohibir que se usen im\xe1genes con ciertas etiquetas especificadas en cualquier despliegue":'),(0,t.kt)("p",null,"Model:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-ini"},'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\ncontain(split(accessWithWildcard(${OBJECT}.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n')),(0,t.kt)("p",null,"And Policy:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-csv"},'p, "1.14.1",deny\n')),(0,t.kt)("p",null,"Estas est\xe1n en el lenguaje ordinario de ACL de Casbin. Suponiendo que ya has le\xeddo cap\xedtulos sobre ellos, ser\xe1 muy f\xe1cil de entender."),(0,t.kt)("p",null,"Casbin K8s-Gatekeeper tiene las siguientes ventajas:"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"F\xe1cil de usar. Escribir varias l\xedneas de ACL es mucho mejor que escribir montones de c\xf3digo."),(0,t.kt)("li",{parentName:"ul"},"Permite actualizaciones en caliente de configuraciones. No necesitas apagar todo el plugin para modificar configuraciones."),(0,t.kt)("li",{parentName:"ul"},"Es flexible. Se pueden hacer reglas arbitrarias en cualquier recurso de K8s, que se pueden explorar con ",(0,t.kt)("inlineCode",{parentName:"li"},"kubectl gatekeeper"),"."),(0,t.kt)("li",{parentName:"ul"},"Simplifica la implementaci\xf3n del webhook de admisi\xf3n de K8s, que es muy complicado. No necesitas saber qu\xe9 es un webhook de admisi\xf3n de K8s o c\xf3mo escribir c\xf3digo para \xe9l. Todo lo que necesitas hacer es conocer el recurso en el que quieres poner restricciones y luego escribir ACL de Casbin. Todos saben que K8s es complejo, pero al usar Casbin K8s-Gatekeeper, tu tiempo puede ser ahorrado."),(0,t.kt)("li",{parentName:"ul"},"Es mantenido por la comunidad de Casbin. No dudes en contactarnos si algo sobre este plugin te confunde o si encuentras alg\xfan problema al intentar esto.")),(0,t.kt)("h3",{id:"11-c\xf3mo-funciona-casbin-k8s-gatekeeper"},"1.1 \xbfC\xf3mo Funciona Casbin K8s-Gatekeeper?"),(0,t.kt)("p",null,"K8s-Gatekeeper es un webhook de admisi\xf3n para K8s que usa ",(0,t.kt)("a",{parentName:"p",href:"/docs/overview"},"Casbin")," para aplicar reglas de control de acceso definidas por el usuario de manera arbitraria para ayudar a prevenir cualquier operaci\xf3n en K8s que el administrador no desee."),(0,t.kt)("p",null,"Casbin es una biblioteca de control de acceso de c\xf3digo abierto poderosa y eficiente. Proporciona soporte para hacer cumplir la autorizaci\xf3n basada en varios modelos de control de acceso. Para m\xe1s detalles sobre Casbin, ver ",(0,t.kt)("a",{parentName:"p",href:"/docs/overview"},"Visi\xf3n general"),"."),(0,t.kt)("p",null,"Los webhooks de admisi\xf3n en K8s son callbacks HTTP que reciben 'solicitudes de admisi\xf3n' y hacen algo con ellas. En particular, K8s-Gatekeeper es un tipo especial de webhook de admisi\xf3n: 'ValidatingAdmissionWebhook', que puede decidir si aceptar o rechazar esta solicitud de admisi\xf3n o no. En cuanto a las solicitudes de admisi\xf3n, son peticiones HTTP que describen una operaci\xf3n en recursos especificados de K8s (por ejemplo, crear/eliminar un despliegue). Para m\xe1s sobre webhooks de admisi\xf3n, ver ",(0,t.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#what-are-admission-webhooks"},"documentaci\xf3n oficial de K8s"),"."),(0,t.kt)("h3",{id:"12-un-ejemplo-ilustrativo-de-c\xf3mo-funciona"},"1.2 Un Ejemplo Ilustrativo de C\xf3mo Funciona"),(0,t.kt)("p",null,"Por ejemplo, cuando alguien quiere crear un despliegue que contenga un pod ejecutando nginx (usando kubectl o clientes de K8s), K8s generar\xe1 una solicitud de admisi\xf3n, que (si se traduce al formato YAML) puede ser algo as\xed:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-deployment\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.14.1\n        ports:\n        - containerPort: 80\n")),(0,t.kt)("p",null,"Esta solicitud pasar\xe1 por el proceso de todos los middleware mostrados en la imagen, incluyendo nuestro K8s-Gatekeeper. K8s-Gatekeeper puede detectar todos los ejecutores de Casbin almacenados en el etcd de K8s, que es creado y mantenido por el usuario (a trav\xe9s de ",(0,t.kt)("inlineCode",{parentName:"p"},"kubectl")," o el cliente de Go que proporcionamos). Cada ejecutor contiene un modelo de Casbin y una pol\xedtica de Casbin. La solicitud de admisi\xf3n ser\xe1 procesada por cada ejecutor, uno por uno, y solo al pasar todos los ejecutores puede una solicitud ser aceptada por este K8s-Gatekeeper."),(0,t.kt)("p",null,"(Si no entiendes qu\xe9 es un ejecutor, modelo o pol\xedtica de Casbin, ver este documento: ",(0,t.kt)("a",{parentName:"p",href:"/docs/get-started"},"Comenzar"),")."),(0,t.kt)("p",null,"Por ejemplo, por alguna raz\xf3n, el administrador quiere prohibir la aparici\xf3n de la imagen 'nginx:1.14.1' mientras permite 'nginx:1.3.1'. Se puede crear un ejecutor que contenga la siguiente regla y pol\xedtica (Explicaremos c\xf3mo crear un ejecutor, qu\xe9 son estos modelos y pol\xedticas, y c\xf3mo escribirlos en los siguientes cap\xedtulos)."),(0,t.kt)("p",null,"Model:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-ini"},'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n\n')),(0,t.kt)("p",null,"Policy:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-csv"},'p, "nginx:1.13.1",allow\np, "nginx:1.14.1",deny\n')),(0,t.kt)("p",null,"Al crear un ejecutor que contenga el modelo y la pol\xedtica anteriores, la solicitud de admisi\xf3n previa ser\xe1 rechazada por este ejecutor, lo que significa que K8s no crear\xe1 este despliegue."),(0,t.kt)("h2",{id:"2-instalar-k8s-gatekeeper"},"2 Instalar K8s-gatekeeper"),(0,t.kt)("p",null,"Hay tres m\xe9todos disponibles para instalar K8s-gatekeeper: webhook externo, webhook interno y Helm."),(0,t.kt)("admonition",{type:"note"},(0,t.kt)("p",{parentName:"admonition"},"Nota: Estos m\xe9todos solo est\xe1n destinados para que los usuarios prueben K8s-gatekeeper y no son seguros. Si deseas usarlo en un entorno productivo, aseg\xfarate de leer ",(0,t.kt)("a",{parentName:"p",href:"#5-advanced-settings"},"Cap\xedtulo 5. Configuraciones avanzadas")," y hacer las modificaciones necesarias antes de la instalaci\xf3n. 2.1 Webhook interno")),(0,t.kt)("h3",{id:"211-paso-1-construir-la-imagen"},"2.1.1 Paso 1: Construir la imagen"),(0,t.kt)("h4",{id:"211-paso-1-construir-la-imagen-1"},"2.1.1 Paso 1: Construir la imagen"),(0,t.kt)("p",null,"Para el m\xe9todo de webhook interno, el propio webhook se implementar\xe1 como un servicio dentro de Kubernetes. Para crear el servicio y despliegue necesarios, necesitas construir una imagen de K8s-gatekeeper. Puedes construir tu propia imagen ejecutando el siguiente comando:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"docker build --target webhook -t k8s-gatekeeper .\n")),(0,t.kt)("p",null,"Este comando crear\xe1 una imagen local llamada 'k8s-gatekeeper:latest'."),(0,t.kt)("admonition",{type:"note"},(0,t.kt)("p",{parentName:"admonition"},"Nota: Si est\xe1s utilizando minikube, por favor ejecuta ",(0,t.kt)("inlineCode",{parentName:"p"},"eval $(minikube -p minikube docker-env)")," antes de correr 'docker build'.")),(0,t.kt)("h4",{id:"212-paso-2-configurar-servicios-y-despliegues-para-k8s-gatekeeper"},"2.1.2 Paso 2: Configurar servicios y despliegues para K8s-gatekeeper"),(0,t.kt)("p",null,"Ejecuta los siguientes comandos:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f config/rbac.yaml\nkubectl apply -f config/webhook_deployment.yaml \nkubectl apply -f config/webhook_internal.yaml \n")),(0,t.kt)("p",null,"Esto comenzar\xe1 a ejecutar K8s-gatekeeper, y puedes confirmarlo ejecutando ",(0,t.kt)("inlineCode",{parentName:"p"},"kubectl get pods"),"."),(0,t.kt)("h4",{id:"213-paso-3-instalar-recursos-crd-para-k8s-gatekeeper"},"2.1.3 Paso 3: Instalar Recursos CRD para K8s-gatekeeper"),(0,t.kt)("p",null,"Ejecuta los siguientes comandos:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\n")),(0,t.kt)("h3",{id:"22-webhook-externo"},"2.2 Webhook externo"),(0,t.kt)("p",null,"Para el m\xe9todo de webhook externo, K8s-gatekeeper se ejecutar\xe1 fuera de Kubernetes, y Kubernetes acceder\xe1 a K8s-gatekeeper como si accediera a un sitio web regular. Kubernetes tiene un requisito obligatorio de que el webhook de admisi\xf3n debe ser HTTPS. Con el prop\xf3sito de probar K8s-gatekeeper, hemos proporcionado un conjunto de certificados y una clave privada (aunque esto no es seguro). Si prefieres usar tu propio certificado, por favor consulta el ",(0,t.kt)("a",{parentName:"p",href:"#5-advanced-settings"},"Cap\xedtulo 5. Configuraci\xf3n avanzada")," para instrucciones sobre c\xf3mo ajustar el certificado y la clave privada. El certificado que proporcionamos est\xe1 emitido para 'webhook.domain.local'."),(0,t.kt)("p",null,"Entonces, modifica el host (por ejemplo, /etc/hosts) y apunta 'webhook.domain.local' a la direcci\xf3n IP en la que K8s-gatekeeper est\xe1 ejecut\xe1ndose. Luego ejecuta el siguiente comando:"),(0,t.kt)("p",null,"2.3 Instalar K8s-gatekeeper a trav\xe9s de Helm"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"go mod tidy\ngo mod vendor\ngo run cmd/webhook/main.go\nkubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\nkubectl apply -f config/webhook_external.yaml \n")),(0,t.kt)("h3",{id:"231-paso-1-construir-la-imagen"},"2.3.1 Paso 1: Construir la imagen"),(0,t.kt)("h4",{id:"por-favor-consulta-el-cap\xedtulo-211"},"Por favor consulta el ",(0,t.kt)("a",{parentName:"h4",href:"#211-step-1-build-the-image"},"Cap\xedtulo 2.1.1"),"."),(0,t.kt)("p",null,"2.3.2 Instalaci\xf3n de Helm"),(0,t.kt)("h4",{id:"ejecuta-el-comando-helm-install-k8sgatekeeper-k8sgatekeeper"},"Ejecuta el comando ",(0,t.kt)("inlineCode",{parentName:"h4"},"helm install k8sgatekeeper ./k8sgatekeeper"),"."),(0,t.kt)("ol",{start:3},(0,t.kt)("li",{parentName:"ol"})),(0,t.kt)("h2",{id:"prueba-k8s-gatekeeper-31-crear-modelo-y-pol\xedtica-de-casbin"},"Prueba K8s-gatekeeper 3.1 Crear Modelo y Pol\xedtica de Casbin"),(0,t.kt)("h3",{id:"tienes-dos-m\xe9todos-para-crear-un-modelo-y-pol\xedtica-a-trav\xe9s-de-kubectl-o-a-trav\xe9s-del-cliente-go-que-proporcionamos"},"Tienes dos m\xe9todos para crear un modelo y pol\xedtica: a trav\xe9s de kubectl o a trav\xe9s del cliente go que proporcionamos."),(0,t.kt)("p",null,"3.1.1 Crear/Actualizar Modelo y Pol\xedtica de Casbin a trav\xe9s de kubectl"),(0,t.kt)("h4",{id:"en-k8s-gatekeeper-el-modelo-de-casbin-se-almacena-en-un-recurso-crd-llamado-casbinmodel"},"En K8s-gatekeeper, el modelo de Casbin se almacena en un recurso CRD llamado 'CasbinModel'."),(0,t.kt)("p",null,"Su definici\xf3n se encuentra en ",(0,t.kt)("inlineCode",{parentName:"p"},"config/auth.casbin.org_casbinmodels.yaml"),". Hay ejemplos en ",(0,t.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/model.yaml"),"."),(0,t.kt)("p",null,"Presta atenci\xf3n a los siguientes campos: metadata.name: el nombre del modelo."),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Este nombre DEBE ser el mismo que el nombre del objeto CasbinPolicy relacionado con este modelo, para que K8s-gatekeeper pueda emparejarlos y crear un ejecutor. spec.enable: si este campo se establece en 'false', este modelo (as\xed como el objeto CasbinPolicy relacionado con este modelo) ser\xe1 ignorado."),(0,t.kt)("li",{parentName:"ul"},"spec.modelText: una cadena que contiene el texto del modelo de un modelo Casbin."),(0,t.kt)("li",{parentName:"ul"},"La Pol\xedtica de Casbin se almacena en otro recurso CRD llamado 'CasbinPolicy', cuya definici\xf3n se puede encontrar en ",(0,t.kt)("inlineCode",{parentName:"li"},"config/auth.casbin.org_casbinpolicies.yaml"),".")),(0,t.kt)("p",null,"Hay ejemplos en ",(0,t.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/policy.yaml"),"."),(0,t.kt)("p",null,"Presta atenci\xf3n a los siguientes campos: metadata.name: el nombre de la pol\xedtica."),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Este nombre DEBE ser el mismo que el nombre del objeto CasbinModel relacionado con esta pol\xedtica, para que K8s-gatekeeper pueda emparejarlos y crear un ejecutor. spec.policyItem: una cadena que contiene el texto de la pol\xedtica de un modelo Casbin."),(0,t.kt)("li",{parentName:"ul"},"Despu\xe9s de crear tus propios archivos CasbinModel y CasbinPolicy, usa el siguiente comando para aplicarlos:")),(0,t.kt)("p",null,"Una vez que se crea un par de CasbinModel y CasbinPolicy, K8s-gatekeeper podr\xe1 detectarlo en 5 segundos."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f <filename>\n")),(0,t.kt)("p",null,"3.1.2 Crear/Actualizar Modelo y Pol\xedtica de Casbin a trav\xe9s del cliente go que proporcionamos"),(0,t.kt)("h4",{id:"entendemos-que-puede-haber-situaciones-en-las-que-no-sea-conveniente-usar-la-shell-para-ejecutar-comandos-directamente-en-un-nodo-del-cl\xfaster-de-k8s-como-cuando-est\xe1s-construyendo-una-plataforma-en-la-nube-autom\xe1tica-para-tu-corporaci\xf3n"},"Entendemos que puede haber situaciones en las que no sea conveniente usar la shell para ejecutar comandos directamente en un nodo del cl\xfaster de K8s, como cuando est\xe1s construyendo una plataforma en la nube autom\xe1tica para tu corporaci\xf3n."),(0,t.kt)("p",null,"Por lo tanto, hemos desarrollado un cliente go para crear y mantener CasbinModel y CasbinPolicy. La biblioteca del cliente go se encuentra en ",(0,t.kt)("inlineCode",{parentName:"p"},"pkg/client"),"."),(0,t.kt)("p",null,"En ",(0,t.kt)("inlineCode",{parentName:"p"},"client.go"),", proporcionamos una funci\xf3n para crear un cliente."),(0,t.kt)("p",null,"En ",(0,t.kt)("inlineCode",{parentName:"p"},"client.go"),", proporcionamos una funci\xf3n para crear un cliente."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-go"},"func NewK8sGateKeeperClient(externalClient bool) (*K8sGateKeeperClient, error) \n")),(0,t.kt)("p",null,"El par\xe1metro ",(0,t.kt)("inlineCode",{parentName:"p"},"externalClient")," determina si K8s-gatekeeper est\xe1 ejecut\xe1ndose dentro del cl\xfaster de K8s o no."),(0,t.kt)("p",null,"En ",(0,t.kt)("inlineCode",{parentName:"p"},"model.go"),", proporcionamos varias funciones para crear, eliminar y modificar CasbinModel. Puedes descubrir c\xf3mo usar estas interfaces en ",(0,t.kt)("inlineCode",{parentName:"p"},"model_test.go"),"."),(0,t.kt)("p",null,"En ",(0,t.kt)("inlineCode",{parentName:"p"},"policy.go"),", proporcionamos varias funciones para crear, eliminar y modificar CasbiPolicy. Puedes descubrir c\xf3mo usar estas interfaces en ",(0,t.kt)("inlineCode",{parentName:"p"},"policy_test.go"),"."),(0,t.kt)("h3",{id:"312-prueba-si-k8s-gatekeeper-funciona"},"3.1.2 Prueba si K8s-gatekeeper funciona"),(0,t.kt)("p",null,"Sup\xf3n que ya has creado el modelo y la pol\xedtica exactos en ",(0,t.kt)("inlineCode",{parentName:"p"},"example/allowed_repo"),". Ahora, prueba el siguiente comando:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f example/allowed_repo/testcase/reject_1.yaml\n")),(0,t.kt)("p",null,"Deber\xedas encontrar que K8s rechazar\xe1 esta solicitud y mencionar\xe1 que el webhook fue la raz\xf3n por la cual esta solicitud es rechazada. Sin embargo, cuando intentes aplicar ",(0,t.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/testcase/approve_2.yaml"),", ser\xe1 aceptado."),(0,t.kt)("h2",{id:"4-c\xf3mo-escribir-modelo-y-pol\xedtica-con-k8s-gatekeeper"},"4. C\xf3mo Escribir Modelo y Pol\xedtica con K8s-gatekeeper"),(0,t.kt)("p",null,"Primero que nada, aseg\xfarate de estar familiarizado con la gram\xe1tica b\xe1sica de los Modelos y Pol\xedticas de Casbin. Si no lo est\xe1s, por favor lee la secci\xf3n ",(0,t.kt)("a",{parentName:"p",href:"/docs/get-started"},"Get Started")," primero. En este cap\xedtulo, asumimos que ya entiendes qu\xe9 son los Modelos y Pol\xedticas de Casbin."),(0,t.kt)("h3",{id:"41-definici\xf3n-de-solicitud-de-modelo"},"4.1 Definici\xf3n de Solicitud de Modelo"),(0,t.kt)("p",null,"Cuando K8s-gatekeeper est\xe1 autorizando una solicitud, la entrada siempre es un objeto: el objeto Go de la Solicitud de Admisi\xf3n. Esto significa que el enforcer siempre se usar\xe1 de esta manera:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-go"},"ok, err := enforcer.Enforce(admission)\n")),(0,t.kt)("p",null,"donde ",(0,t.kt)("inlineCode",{parentName:"p"},"admission")," es un objeto ",(0,t.kt)("inlineCode",{parentName:"p"},"AdmissionReview")," definido por la api oficial de go de K8s ",(0,t.kt)("inlineCode",{parentName:"p"},'"k8s.io/api/admission/v1"'),". Puedes encontrar la definici\xf3n de esta estructura en este repositorio: ",(0,t.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/api/blob/master/admission/v1/types.go"},"https://github.com/kubernetes/api/blob/master/admission/v1/types.go"),". Para m\xe1s informaci\xf3n, tambi\xe9n puedes referirte a ",(0,t.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response"},"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response"),"."),(0,t.kt)("p",null,"Por lo tanto, para cualquier modelo utilizado por K8s-gatekeeper, la definici\xf3n de ",(0,t.kt)("inlineCode",{parentName:"p"},"request_definition")," siempre debe ser as\xed:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-ini"},"    [request_definition]\n    r =  obj\n")),(0,t.kt)("p",null,"El nombre 'obj' no es obligatorio, siempre y cuando el nombre sea consistente con el nombre utilizado en la parte ",(0,t.kt)("inlineCode",{parentName:"p"},"[matchers]"),"."),(0,t.kt)("h3",{id:"42-coincidencias-de-modelo"},"4.2 Coincidencias de Modelo"),(0,t.kt)("p",null,"Se supone que debes usar la caracter\xedstica ABAC de Casbin para escribir tus reglas. Sin embargo, el evaluador de expresiones integrado en Casbin no admite indexaci\xf3n en mapas o arreglos (slices), ni la expansi\xf3n de arreglos. Por lo tanto, K8s-gatekeeper proporciona varias 'funciones de Casbin' como extensiones para implementar estas caracter\xedsticas. Si a\xfan encuentras que tu demanda no puede ser satisfecha por estas extensiones, no dudes en iniciar un issue, o crear un pull request."),(0,t.kt)("p",null,"Si no est\xe1s familiarizado con las funciones de Casbin, puedes referirte a ",(0,t.kt)("a",{parentName:"p",href:"/docs/function"},"Function")," para m\xe1s informaci\xf3n."),(0,t.kt)("p",null,"Aqu\xed est\xe1n las funciones de extensi\xf3n:"),(0,t.kt)("h3",{id:"421-funciones-de-extensi\xf3n"},"4.2.1 Funciones de extensi\xf3n"),(0,t.kt)("h4",{id:"4211-access"},"4.2.1.1 access"),(0,t.kt)("p",null,"Access se utiliza para resolver el problema de que Casbin no admite indexaci\xf3n en mapas o arreglos. El ejemplo ",(0,t.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/model.yaml")," demuestra el uso de esta funci\xf3n:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-ini"},'[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n')),(0,t.kt)("p",null,"En este coincidente, ",(0,t.kt)("inlineCode",{parentName:"p"},'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image")')," es equivalente a ",(0,t.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Image"),", donde ",(0,t.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers")," es un slice."),(0,t.kt)("p",null,"Access tambi\xe9n puede llamar a funciones simples que no tienen par\xe1metros y devuelven un solo valor. El ejemplo ",(0,t.kt)("inlineCode",{parentName:"p"},"example/container_resource_limit/model.yaml")," demuestra esto:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-ini"},'[matchers]\n  m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")) >= parseFloat(p.cpu) && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","memory","Value")) >= parseFloat(p.memory)\n')),(0,t.kt)("p",null,"En este coincidente, ",(0,t.kt)("inlineCode",{parentName:"p"},'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")')," es equivalente a ",(0,t.kt)("inlineCode",{parentName:"p"},'r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits["cpu"].Value()'),", donde ",(0,t.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits")," es un mapa, y ",(0,t.kt)("inlineCode",{parentName:"p"},"Value()")," es una funci\xf3n simple que no tiene par\xe1metros y devuelve un solo valor."),(0,t.kt)("h4",{id:"4212-accesswithwildcard"},"4.2.1.2 accessWithWildcard"),(0,t.kt)("p",null,'A veces, puedes tener una demanda como esta: todos los elementos en un arreglo deben tener un prefijo "aaa". Sin embargo, Casbin no admite bucles ',(0,t.kt)("inlineCode",{parentName:"p"},"for"),". Con ",(0,t.kt)("inlineCode",{parentName:"p"},"accessWithWildcard"),' y la caracter\xedstica de "expansi\xf3n de map/slice", puedes implementar f\xe1cilmente tal demanda.'),(0,t.kt)("p",null,"Por ejemplo, supongamos que ",(0,t.kt)("inlineCode",{parentName:"p"},"a.b.c")," es un arreglo ",(0,t.kt)("inlineCode",{parentName:"p"},"[aaa,bbb,ccc,ddd,eee]"),", entonces el resultado de ",(0,t.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(a,"b","c","*")')," ser\xe1 un slice ",(0,t.kt)("inlineCode",{parentName:"p"},"[aaa,bbb,ccc,ddd,eee]"),". Al usar el comod\xedn ",(0,t.kt)("inlineCode",{parentName:"p"},"*"),", el slice se expande."),(0,t.kt)("p",null,"De manera similar, el comod\xedn puede usarse m\xe1s de una vez. Por ejemplo, el resultado de ",(0,t.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(a,"b","c","*","*")')," ser\xe1 ",(0,t.kt)("inlineCode",{parentName:"p"},"[a.b.c[0][0], a.b.c[0][1], ..., a.b.c[1][0], a.b.c[1][1], ...]"),"."),(0,t.kt)("h3",{id:"4213-funciones-que-admiten-argumentos-de-longitud-variable"},"4.2.1.3 Funciones que admiten argumentos de longitud variable"),(0,t.kt)("p",null,"En el evaluador de expresiones de Casbin, cuando un par\xe1metro es un arreglo, se expandir\xe1 autom\xe1ticamente como un argumento de longitud variable. Utilizando esta caracter\xedstica para admitir la expansi\xf3n de arreglo/slice/mapa, tambi\xe9n hemos integrado varias funciones que aceptan un arreglo/slice como par\xe1metro:"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"contain(): acepta m\xfaltiples par\xe1metros y devuelve si alg\xfan par\xe1metro (excepto el \xfaltimo par\xe1metro) es igual al \xfaltimo par\xe1metro."),(0,t.kt)("li",{parentName:"ul"},"split(a,b,c...,sep,index): devuelve un segmento que contiene ",(0,t.kt)("inlineCode",{parentName:"li"},"[splits(a,sep)[index], splits(b,sep)[index], splits(a,sep)[index], ...]"),"."),(0,t.kt)("li",{parentName:"ul"},"len(): devuelve la longitud del argumento de longitud variable."),(0,t.kt)("li",{parentName:"ul"},"matchRegex(a,b,c...,regex): devuelve si todos los par\xe1metros dados (",(0,t.kt)("inlineCode",{parentName:"li"},"a"),", ",(0,t.kt)("inlineCode",{parentName:"li"},"b"),", ",(0,t.kt)("inlineCode",{parentName:"li"},"c"),", ...) coinciden con la expresi\xf3n regular dada.")),(0,t.kt)("p",null,"Aqu\xed hay un ejemplo en ",(0,t.kt)("inlineCode",{parentName:"p"},"example/disallowed_tag/model.yaml"),":"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-ini"},'    [matchers]\n    m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n    contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n')),(0,t.kt)("p",null,"Suponiendo que ",(0,t.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image")')," devuelve ",(0,t.kt)("inlineCode",{parentName:"p"},"['a:b', 'c:d', 'e:f', 'g:h']"),", porque splits soporta argumentos de longitud variable y realiza la operaci\xf3n de divisi\xf3n en cada elemento, se seleccionar\xe1 y devolver\xe1 el elemento en el \xedndice 1. Por lo tanto, ",(0,t.kt)("inlineCode",{parentName:"p"},'split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1)')," devuelve ",(0,t.kt)("inlineCode",{parentName:"p"},"['b','d','f','h']"),". Y ",(0,t.kt)("inlineCode",{parentName:"p"},'contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)')," devuelve si ",(0,t.kt)("inlineCode",{parentName:"p"},"p.obj")," est\xe1 contenido en ",(0,t.kt)("inlineCode",{parentName:"p"},"['b','d','f','h']"),"."),(0,t.kt)("h4",{id:"4212-funciones-de-conversi\xf3n-de-tipos"},"4.2.1.2 Funciones de Conversi\xf3n de Tipos"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"ParseFloat(): Convierte un entero a un flotante (esto es necesario porque cualquier n\xfamero utilizado en comparaci\xf3n debe ser convertido en un flotante)."),(0,t.kt)("li",{parentName:"ul"},"ToString(): Convierte un objeto a una cadena de texto. Este objeto debe tener un tipo b\xe1sico de cadena (por ejemplo, un objeto de tipo ",(0,t.kt)("inlineCode",{parentName:"li"},"XXX")," cuando hay una declaraci\xf3n ",(0,t.kt)("inlineCode",{parentName:"li"},"type XXX string"),")."),(0,t.kt)("li",{parentName:"ul"},"IsNil(): Devuelve si el par\xe1metro es nulo.")),(0,t.kt)("h2",{id:"5-configuraci\xf3n-avanzada"},"5. Configuraci\xf3n Avanzada"),(0,t.kt)("h3",{id:"51-acerca-de-los-certificados"},"5.1 Acerca de los Certificados"),(0,t.kt)("p",null,"En Kubernetes (k8s), es obligatorio que un webhook utilice HTTPS. Hay dos enfoques para lograr esto:"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Usar certificados autofirmados (los ejemplos en este repositorio utilizan este m\xe9todo)"),(0,t.kt)("li",{parentName:"ul"},"Usar un certificado normal")),(0,t.kt)("h4",{id:"511-certificados-autofirmados"},"5.1.1 Certificados autofirmados"),(0,t.kt)("p",null,"Usar un certificado autofirmado significa que la Autoridad de Certificaci\xf3n (CA) que emite el certificado no es una de las CA bien conocidas. Por lo tanto, debes informar a k8s sobre esta CA."),(0,t.kt)("p",null,"Actualmente, el ejemplo en este repositorio utiliza una CA hecha por s\xed misma, cuya clave privada y certificado se almacenan en ",(0,t.kt)("inlineCode",{parentName:"p"},"config/certificate/ca.crt")," y ",(0,t.kt)("inlineCode",{parentName:"p"},"config/certificate/ca.key")," respectivamente. El certificado para el webhook es ",(0,t.kt)("inlineCode",{parentName:"p"},"config/certificate/server.crt"),', que es emitido por la CA hecha por s\xed misma. Los dominios de este certificado son "webhook.domain.local" (para webhook externo) y "casbin-webhook-svc.default.svc" (para webhook interno).'),(0,t.kt)("p",null,"La informaci\xf3n sobre la CA se pasa a k8s a trav\xe9s de archivos de configuraci\xf3n de webhook. Ambos ",(0,t.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," y ",(0,t.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml"),' tienen un campo llamado "CABundle", que contiene una cadena codificada en base64 del certificado de la CA.'),(0,t.kt)("p",null,"En caso de que necesites cambiar el certificado/dominio (por ejemplo, si quieres poner este webhook en otro espacio de nombres de k8s mientras usas un webhook interno, o si quieres cambiar el dominio mientras usas un webhook externo), se deben seguir los siguientes procedimientos:"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Generar una nueva CA:"),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Generar la clave privada para la CA falsa:"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"openssl genrsa -des3 -out ca.key 2048\n"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Eliminar la protecci\xf3n por contrase\xf1a de la clave privada:"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"openssl rsa -in ca.key -out ca.key\n"))))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Generar una clave privada para el servidor webhook:"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"openssl genrsa -des3 -out server.key 2048\nopenssl rsa -in server.key -out server.key\n"))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Usar la CA autogenerada para firmar el certificado para el webhook:"),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Copiar el archivo de configuraci\xf3n de openssl de tu sistema para uso temporal. Puedes encontrar la ubicaci\xf3n del archivo de configuraci\xf3n ejecutando ",(0,t.kt)("inlineCode",{parentName:"p"},"openssl version -a"),", generalmente llamado ",(0,t.kt)("inlineCode",{parentName:"p"},"openssl.cnf"),".")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"En el archivo de configuraci\xf3n:"),(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Encuentra el p\xe1rrafo ",(0,t.kt)("inlineCode",{parentName:"p"},"[req]")," y a\xf1ade la siguiente l\xednea: ",(0,t.kt)("inlineCode",{parentName:"p"},"req_extensions = v3_req"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Encuentra el p\xe1rrafo ",(0,t.kt)("inlineCode",{parentName:"p"},"[v3_req]")," y a\xf1ade la siguiente l\xednea: ",(0,t.kt)("inlineCode",{parentName:"p"},"subjectAltName = @alt_names"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"A\xf1ade las siguientes l\xedneas al archivo:"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-ini"},"[alt_names]\nDNS.2=<The domain you want>\n")),(0,t.kt)("p",{parentName:"li"},"Nota: Reemplaza 'casbin-webhook-svc.default.svc' con el nombre real del servicio de tu propio servicio si decides modificar el nombre del servicio.")))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Usa el archivo de configuraci\xf3n modificado para generar un archivo de solicitud de certificado:"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"openssl req -new -nodes -keyout server.key -out server.csr -config openssl.cnf\n"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Usa la CA hecha por s\xed misma para responder a la solicitud y firmar el certificado:"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-shell"},"openssl x509 -req -days 3650 -in server.csr -out server.crt -CA ca.crt -CAkey ca.key -CAcreateserial -extensions v3_req -extensions SAN -extfile openssl.cnf\n"))))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Reemplazar el campo 'CABundle': Ambos ",(0,t.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," y ",(0,t.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml"),' tienen un campo llamado "CABundle", que contiene una cadena codificada en base64 del certificado de la CA.')),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Actualiza este campo con el nuevo certificado."))),(0,t.kt)("h4",{id:"si-est\xe1s-usando-helm-se-deben-aplicar-cambios-similares-a-los-gr\xe1ficos-de-helm"},"Si est\xe1s usando helm, se deben aplicar cambios similares a los gr\xe1ficos de helm."),(0,t.kt)("p",null,'5.1.2 Certificados legales Elimina el campo "CABundle" en ',(0,t.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," y ",(0,t.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml"),", y cambia el dominio en estos archivos por el dominio que posees."))}d.isMDXComponent=!0}}]);