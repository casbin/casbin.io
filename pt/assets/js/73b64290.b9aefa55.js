"use strict";(self.webpackChunkcasbin_website_v2=self.webpackChunkcasbin_website_v2||[]).push([[264],{3905:(e,a,o)=>{o.d(a,{Zo:()=>c,kt:()=>u});var t=o(7294);function r(e,a,o){return a in e?Object.defineProperty(e,a,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[a]=o,e}function s(e,a){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),o.push.apply(o,t)}return o}function n(e){for(var a=1;a<arguments.length;a++){var o=null!=arguments[a]?arguments[a]:{};a%2?s(Object(o),!0).forEach((function(a){r(e,a,o[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):s(Object(o)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(o,a))}))}return e}function i(e,a){if(null==e)return{};var o,t,r=function(e,a){if(null==e)return{};var o,t,r={},s=Object.keys(e);for(t=0;t<s.length;t++)o=s[t],a.indexOf(o)>=0||(r[o]=e[o]);return r}(e,a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(t=0;t<s.length;t++)o=s[t],a.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var l=t.createContext({}),p=function(e){var a=t.useContext(l),o=a;return e&&(o="function"==typeof e?e(a):n(n({},a),e)),o},c=function(e){var a=p(e.components);return t.createElement(l.Provider,{value:a},e.children)},m={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},d=t.forwardRef((function(e,a){var o=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=p(o),u=r,k=d["".concat(l,".").concat(u)]||d[u]||m[u]||s;return o?t.createElement(k,n(n({ref:a},c),{},{components:o})):t.createElement(k,n({ref:a},c))}));function u(e,a){var o=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var s=o.length,n=new Array(s);n[0]=d;var i={};for(var l in a)hasOwnProperty.call(a,l)&&(i[l]=a[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,n[1]=i;for(var p=2;p<s;p++)n[p]=o[p];return t.createElement.apply(null,n)}return t.createElement.apply(null,o)}d.displayName="MDXCreateElement"},9303:(e,a,o)=>{o.r(a),o.d(a,{assets:()=>l,contentTitle:()=>n,default:()=>m,frontMatter:()=>s,metadata:()=>i,toc:()=>p});var t=o(7462),r=(o(7294),o(3905));const s={id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC & ABAC Authorization Middleware baseado no Casbin",keywords:["k8s-gatekeeper","Kubernetes","K8s"],authors:["ComradeProgrammer"]},n=void 0,i={unversionedId:"k8s-gatekeeper",id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC & ABAC Authorization Middleware baseado no Casbin",source:"@site/i18n/pt/docusaurus-plugin-content-docs/current/K8sGateKeeper.mdx",sourceDirName:".",slug:"/k8s-gatekeeper",permalink:"/pt/docs/k8s-gatekeeper",draft:!1,editUrl:"https://github.com/casbin/casbin-website-v2/edit/master/docs/K8sGateKeeper.mdx",tags:[],version:"current",frontMatter:{id:"k8s-gatekeeper",title:"Admission Webhook for K8s",description:"Kubernetes (K8s) RBAC & ABAC Authorization Middleware baseado no Casbin",keywords:["k8s-gatekeeper","Kubernetes","K8s"],authors:["ComradeProgrammer"]},sidebar:"docs",previous:{title:"Authorization of Kubernetes",permalink:"/pt/docs/k8s"},next:{title:"Authorization of Service Mesh through Envoy",permalink:"/pt/docs/envoy"}},l={},p=[{value:"1. Vis\xe3o Geral &amp; Documentos para Casbin K8s-Gatekeeper",id:"1-vis\xe3o-geral--documentos-para-casbin-k8s-gatekeeper",level:2},{value:"0.1 Um Exemplo Simples",id:"01-um-exemplo-simples",level:3},{value:"1.1 Como o Casbin K8s-Gatekeeper Funciona?",id:"11-como-o-casbin-k8s-gatekeeper-funciona",level:3},{value:"1.2 Um Exemplo Ilustrando Como Funciona",id:"12-um-exemplo-ilustrando-como-funciona",level:3},{value:"2 Instalar K8s-gatekeeper",id:"2-instalar-k8s-gatekeeper",level:2},{value:"2.1.1 Passo 1: Construir a imagem",id:"211-passo-1-construir-a-imagem",level:3},{value:"2.1.1 Step 1: Build the image",id:"211-step-1-build-the-image",level:4},{value:"2.1.2 Passo 2: Configurar servi\xe7os e implanta\xe7\xf5es para o K8s-gatekeeper",id:"212-passo-2-configurar-servi\xe7os-e-implanta\xe7\xf5es-para-o-k8s-gatekeeper",level:4},{value:"2.1.3 Passo 3: Instalar Recursos CRD para o K8s-gatekeeper",id:"213-passo-3-instalar-recursos-crd-para-o-k8s-gatekeeper",level:4},{value:"2.2 Webhook externo",id:"22-webhook-externo",level:3},{value:"2.3.1 Passo 1: Construir a imagem",id:"231-passo-1-construir-a-imagem",level:3},{value:"Por favor, consulte Cap\xedtulo 2.1.1.",id:"por-favor-consulte-cap\xedtulo-211",level:4},{value:"Execute o comando <code>helm install k8sgatekeeper ./k8sgatekeeper</code>.",id:"execute-o-comando-helm-install-k8sgatekeeper-k8sgatekeeper",level:4},{value:"Experimente o K8s-gatekeeper 3.1 Criar Modelo e Pol\xedtica Casbin",id:"experimente-o-k8s-gatekeeper-31-criar-modelo-e-pol\xedtica-casbin",level:2},{value:"Voc\xea tem dois m\xe9todos para criar um modelo e pol\xedtica: via kubectl ou via o cliente go que fornecemos.",id:"voc\xea-tem-dois-m\xe9todos-para-criar-um-modelo-e-pol\xedtica-via-kubectl-ou-via-o-cliente-go-que-fornecemos",level:3},{value:"No K8s-gatekeeper, o Modelo Casbin \xe9 armazenado em um recurso CRD chamado &#39;CasbinModel&#39;.",id:"no-k8s-gatekeeper-o-modelo-casbin-\xe9-armazenado-em-um-recurso-crd-chamado-casbinmodel",level:4},{value:"Entendemos que pode haver situa\xe7\xf5es em que n\xe3o \xe9 conveniente usar o shell para executar comandos diretamente em um n\xf3 do cluster K8s, como quando voc\xea est\xe1 construindo uma plataforma de nuvem autom\xe1tica para sua corpora\xe7\xe3o.",id:"entendemos-que-pode-haver-situa\xe7\xf5es-em-que-n\xe3o-\xe9-conveniente-usar-o-shell-para-executar-comandos-diretamente-em-um-n\xf3-do-cluster-k8s-como-quando-voc\xea-est\xe1-construindo-uma-plataforma-de-nuvem-autom\xe1tica-para-sua-corpora\xe7\xe3o",level:4},{value:"3.1.2 Tente se o K8s-gatekeeper funciona",id:"312-tente-se-o-k8s-gatekeeper-funciona",level:3},{value:"4. Como Escrever Modelo e Pol\xedtica com K8s-gatekeeper",id:"4-como-escrever-modelo-e-pol\xedtica-com-k8s-gatekeeper",level:2},{value:"4.1 Defini\xe7\xe3o de Solicita\xe7\xe3o de Modelo",id:"41-defini\xe7\xe3o-de-solicita\xe7\xe3o-de-modelo",level:3},{value:"4.2 Correspondentes de Modelo",id:"42-correspondentes-de-modelo",level:3},{value:"4.2.1 Fun\xe7\xf5es de extens\xe3o",id:"421-fun\xe7\xf5es-de-extens\xe3o",level:3},{value:"4.2.1.1 access",id:"4211-access",level:4},{value:"4.2.1.2 accessWithWildcard",id:"4212-accesswithwildcard",level:4},{value:"4.2.1.3 Fun\xe7\xf5es que Suportam Argumentos de Comprimento Vari\xe1vel",id:"4213-fun\xe7\xf5es-que-suportam-argumentos-de-comprimento-vari\xe1vel",level:3},{value:"4.2.1.2 Fun\xe7\xf5es de Convers\xe3o de Tipo",id:"4212-fun\xe7\xf5es-de-convers\xe3o-de-tipo",level:4},{value:"5. Configura\xe7\xf5es Avan\xe7adas",id:"5-configura\xe7\xf5es-avan\xe7adas",level:2},{value:"5.1 Sobre Certificados",id:"51-sobre-certificados",level:3},{value:"5.1.1 Certificados autoassinados",id:"511-certificados-autoassinados",level:4},{value:"Se voc\xea estiver usando helm, mudan\xe7as semelhantes precisam ser aplicadas aos gr\xe1ficos do helm.",id:"se-voc\xea-estiver-usando-helm-mudan\xe7as-semelhantes-precisam-ser-aplicadas-aos-gr\xe1ficos-do-helm",level:4}],c={toc:p};function m(e){let{components:a,...o}=e;return(0,r.kt)("wrapper",(0,t.Z)({},c,o,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"1-vis\xe3o-geral--documentos-para-casbin-k8s-gatekeeper"},"1. Vis\xe3o Geral & Documentos para Casbin K8s-Gatekeeper"),(0,r.kt)("p",null,"Casbin K8s-GateKeeper \xe9 um webhook de admiss\xe3o do Kubernetes que integra o Casbin como ferramenta de Controle de Acesso. Ao usar o Casbin K8s-GateKeeper, voc\xea pode estabelecer regras flex\xedveis para autorizar ou interceptar qualquer opera\xe7\xe3o em recursos do K8s, SEM escrever nenhum c\xf3digo, mas apenas v\xe1rias linhas de configura\xe7\xf5es declarativas de modelos e pol\xedticas do Casbin, que fazem parte da linguagem ACL (Lista de Controle de Acesso) do Casbin."),(0,r.kt)("p",null,"Casbin K8s-GateKeeper \xe9 desenvolvido e mantido pela comunidade Casbin. O reposit\xf3rio deste projeto est\xe1 dispon\xedvel aqui: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/casbin/k8s-gatekeeper"},"https://github.com/casbin/k8s-gatekeeper")),(0,r.kt)("h3",{id:"01-um-exemplo-simples"},"0.1 Um Exemplo Simples"),(0,r.kt)("p",null,"Por exemplo, voc\xea n\xe3o precisa escrever nenhum c\xf3digo, mas usar as seguintes linhas de configura\xe7\xe3o para alcan\xe7ar esta fun\xe7\xe3o: 'Proibir imagens com algumas tags especificadas de serem usadas em quaisquer implanta\xe7\xf5es':"),(0,r.kt)("p",null,"Model:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\ncontain(split(accessWithWildcard(${OBJECT}.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n')),(0,r.kt)("p",null,"And Policy:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csv"},'p, "1.14.1",deny\n')),(0,r.kt)("p",null,"Estas est\xe3o na linguagem comum de ACL do Casbin. Suponha que voc\xea j\xe1 tenha lido cap\xedtulos sobre eles, ser\xe1 muito f\xe1cil de entender."),(0,r.kt)("p",null,"Casbin K8s-Gatekeeper tem as seguintes vantagens:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"F\xe1cil de usar. Escrever v\xe1rias linhas de ACL \xe9 muito melhor do que escrever muitos c\xf3digos."),(0,r.kt)("li",{parentName:"ul"},"Permite atualiza\xe7\xf5es quentes de configura\xe7\xf5es. Voc\xea n\xe3o precisa desligar todo o plugin para modificar configura\xe7\xf5es."),(0,r.kt)("li",{parentName:"ul"},"\xc9 flex\xedvel. Regras arbitr\xe1rias podem ser feitas em qualquer recurso do K8s, que podem ser exploradas com ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl gatekeeper"),"."),(0,r.kt)("li",{parentName:"ul"},"Simplifica a implementa\xe7\xe3o do webhook de admiss\xe3o do K8s, que \xe9 muito complicado. Voc\xea n\xe3o precisa saber o que \xe9 um webhook de admiss\xe3o do K8s ou como escrever c\xf3digo para ele. Tudo o que voc\xea precisa fazer \xe9 conhecer o recurso no qual deseja impor restri\xe7\xf5es e depois escrever ACL do Casbin. Todos sabem que o K8s \xe9 complexo, mas ao usar o Casbin K8s-Gatekeeper, seu tempo pode ser economizado."),(0,r.kt)("li",{parentName:"ul"},"\xc9 mantido pela comunidade Casbin. Sinta-se \xe0 vontade para nos contatar se algo sobre este plugin o confundir ou se voc\xea encontrar algum problema ao tentar isso.")),(0,r.kt)("h3",{id:"11-como-o-casbin-k8s-gatekeeper-funciona"},"1.1 Como o Casbin K8s-Gatekeeper Funciona?"),(0,r.kt)("p",null,"K8s-Gatekeeper \xe9 um webhook de admiss\xe3o para K8s que usa ",(0,r.kt)("a",{parentName:"p",href:"/docs/overview"},"Casbin")," para aplicar regras de controle de acesso definidas pelo usu\xe1rio de forma arbitr\xe1ria para ajudar a prevenir qualquer opera\xe7\xe3o no K8s que o administrador n\xe3o deseje."),(0,r.kt)("p",null,"Casbin \xe9 uma biblioteca de controle de acesso de c\xf3digo aberto poderosa e eficiente. Ela oferece suporte para a aplica\xe7\xe3o de autoriza\xe7\xe3o baseada em v\xe1rios modelos de controle de acesso. Para mais detalhes sobre o Casbin, veja ",(0,r.kt)("a",{parentName:"p",href:"/docs/overview"},"Vis\xe3o Geral"),"."),(0,r.kt)("p",null,"Webhooks de admiss\xe3o no K8s s\xe3o callbacks HTTP que recebem 'solicita\xe7\xf5es de admiss\xe3o' e fazem algo com elas. Em particular, K8s-Gatekeeper \xe9 um tipo especial de webhook de admiss\xe3o: 'ValidatingAdmissionWebhook', que pode decidir se aceita ou rejeita esta solicita\xe7\xe3o de admiss\xe3o ou n\xe3o. Quanto \xe0s solicita\xe7\xf5es de admiss\xe3o, s\xe3o solicita\xe7\xf5es HTTP descrevendo uma opera\xe7\xe3o em recursos especificados do K8s (por exemplo, criar/deletar uma implanta\xe7\xe3o). Para mais sobre webhooks de admiss\xe3o, veja ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#what-are-admission-webhooks"},"documenta\xe7\xe3o oficial do K8s"),"."),(0,r.kt)("h3",{id:"12-um-exemplo-ilustrando-como-funciona"},"1.2 Um Exemplo Ilustrando Como Funciona"),(0,r.kt)("p",null,"Por exemplo, quando algu\xe9m quer criar uma implanta\xe7\xe3o contendo um pod executando nginx (usando kubectl ou clientes K8s), o K8s gerar\xe1 uma solicita\xe7\xe3o de admiss\xe3o, que (se traduzida para o formato YAML) pode ser algo assim:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-deployment\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:1.14.1\n        ports:\n        - containerPort: 80\n")),(0,r.kt)("p",null,"Esta solicita\xe7\xe3o passar\xe1 pelo processo de todos os middlewares mostrados na imagem, incluindo nosso K8s-Gatekeeper. K8s-Gatekeeper pode detectar todos os aplicadores de regras do Casbin armazenados no etcd do K8s, que \xe9 criado e mantido pelo usu\xe1rio (via ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl")," ou o cliente Go que fornecemos). Cada aplicador cont\xe9m um modelo Casbin e uma pol\xedtica Casbin. A solicita\xe7\xe3o de admiss\xe3o ser\xe1 processada por cada aplicador, um por um, e apenas passando por todos os aplicadores uma solicita\xe7\xe3o pode ser aceita por este K8s-Gatekeeper."),(0,r.kt)("p",null,"(Se voc\xea n\xe3o entende o que \xe9 um aplicador, modelo ou pol\xedtica do Casbin, veja este documento: ",(0,r.kt)("a",{parentName:"p",href:"/docs/get-started"},"Come\xe7ar"),")."),(0,r.kt)("p",null,"Por exemplo, por algum motivo, o administrador quer proibir a apari\xe7\xe3o da imagem 'nginx:1.14.1' enquanto permite 'nginx:1.3.1'. Um aplicador contendo a seguinte regra e pol\xedtica pode ser criado (Explicaremos como criar um aplicador, o que s\xe3o esses modelos e pol\xedticas, e como escrev\xea-los nos cap\xedtulos seguintes)."),(0,r.kt)("p",null,"Model:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'[request_definition]\nr =  obj\n\n[policy_definition]\np =  obj,eft\n\n[policy_effect]\ne = !some(where (p.eft == deny))\n\n[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n\n')),(0,r.kt)("p",null,"Policy:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csv"},'p, "nginx:1.13.1",allow\np, "nginx:1.14.1",deny\n')),(0,r.kt)("p",null,"Ao criar um aplicador contendo o modelo e a pol\xedtica acima, a solicita\xe7\xe3o de admiss\xe3o anterior ser\xe1 rejeitada por este aplicador, o que significa que o K8s n\xe3o criar\xe1 esta implanta\xe7\xe3o."),(0,r.kt)("h2",{id:"2-instalar-k8s-gatekeeper"},"2 Instalar K8s-gatekeeper"),(0,r.kt)("p",null,"H\xe1 tr\xeas m\xe9todos dispon\xedveis para instalar K8s-gatekeeper: Webhook externo, Webhook interno e Helm."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Observa\xe7\xe3o: Esses m\xe9todos s\xe3o apenas para usu\xe1rios experimentarem o K8s-gatekeeper e n\xe3o s\xe3o seguros. Se voc\xea deseja us\xe1-lo em um ambiente produtivo, por favor, certifique-se de ler ",(0,r.kt)("a",{parentName:"p",href:"#5-advanced-settings"},"Cap\xedtulo 5. Configura\xe7\xf5es avan\xe7adas")," e fazer as modifica\xe7\xf5es necess\xe1rias antes da instala\xe7\xe3o. 2.1 Webhook interno")),(0,r.kt)("h3",{id:"211-passo-1-construir-a-imagem"},"2.1.1 Passo 1: Construir a imagem"),(0,r.kt)("h4",{id:"211-step-1-build-the-image"},"2.1.1 Step 1: Build the image"),(0,r.kt)("p",null,"Para o m\xe9todo interno de webhook, o pr\xf3prio webhook ser\xe1 implementado como um servi\xe7o dentro do Kubernetes. Para criar o servi\xe7o e a implanta\xe7\xe3o necess\xe1rios, voc\xea precisa construir uma imagem do K8s-gatekeeper. Voc\xea pode construir sua pr\xf3pria imagem executando o seguinte comando:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"docker build --target webhook -t k8s-gatekeeper .\n")),(0,r.kt)("p",null,"Este comando criar\xe1 uma imagem local chamada 'k8s-gatekeeper:latest'."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Nota: Se voc\xea estiver usando minikube, por favor execute ",(0,r.kt)("inlineCode",{parentName:"p"},"eval $(minikube -p minikube docker-env)")," antes de rodar 'docker build'.")),(0,r.kt)("h4",{id:"212-passo-2-configurar-servi\xe7os-e-implanta\xe7\xf5es-para-o-k8s-gatekeeper"},"2.1.2 Passo 2: Configurar servi\xe7os e implanta\xe7\xf5es para o K8s-gatekeeper"),(0,r.kt)("p",null,"Execute os seguintes comandos:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f config/rbac.yaml\nkubectl apply -f config/webhook_deployment.yaml \nkubectl apply -f config/webhook_internal.yaml \n")),(0,r.kt)("p",null,"Isso iniciar\xe1 a execu\xe7\xe3o do K8s-gatekeeper, e voc\xea pode confirmar isso executando ",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl get pods"),"."),(0,r.kt)("h4",{id:"213-passo-3-instalar-recursos-crd-para-o-k8s-gatekeeper"},"2.1.3 Passo 3: Instalar Recursos CRD para o K8s-gatekeeper"),(0,r.kt)("p",null,"Execute os seguintes comandos:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\n")),(0,r.kt)("h3",{id:"22-webhook-externo"},"2.2 Webhook externo"),(0,r.kt)("p",null,"Para o m\xe9todo de webhook externo, o K8s-gatekeeper estar\xe1 rodando fora do Kubernetes, e o Kubernetes acessar\xe1 o K8s-gatekeeper como acessaria um site comum. O Kubernetes tem um requisito obrigat\xf3rio de que o webhook de admiss\xe3o deve ser HTTPS. Para o prop\xf3sito de testar o K8s-gatekeeper, fornecemos um conjunto de certificados e uma chave privada (embora isso n\xe3o seja seguro). Se voc\xea preferir usar seu pr\xf3prio certificado, por favor consulte ",(0,r.kt)("a",{parentName:"p",href:"#5-advanced-settings"},"Cap\xedtulo 5. Configura\xe7\xf5es avan\xe7adas")," para instru\xe7\xf5es sobre como ajustar o certificado e a chave privada. O certificado que fornecemos \xe9 emitido para 'webhook.domain.local'."),(0,r.kt)("p",null,"Ent\xe3o, modifique o host (por exemplo, /etc/hosts) e aponte 'webhook.domain.local' para o endere\xe7o IP no qual o K8s-gatekeeper est\xe1 rodando. Em seguida, execute o seguinte comando:"),(0,r.kt)("p",null,"2.3 Instalar o K8s-gatekeeper via Helm"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"go mod tidy\ngo mod vendor\ngo run cmd/webhook/main.go\nkubectl apply -f config/auth.casbin.org_casbinmodels.yaml \nkubectl apply -f config/auth.casbin.org_casbinpolicies.yaml\nkubectl apply -f config/webhook_external.yaml \n")),(0,r.kt)("h3",{id:"231-passo-1-construir-a-imagem"},"2.3.1 Passo 1: Construir a imagem"),(0,r.kt)("h4",{id:"por-favor-consulte-cap\xedtulo-211"},"Por favor, consulte ",(0,r.kt)("a",{parentName:"h4",href:"#211-step-1-build-the-image"},"Cap\xedtulo 2.1.1"),"."),(0,r.kt)("p",null,"2.3.2 Instala\xe7\xe3o via Helm"),(0,r.kt)("h4",{id:"execute-o-comando-helm-install-k8sgatekeeper-k8sgatekeeper"},"Execute o comando ",(0,r.kt)("inlineCode",{parentName:"h4"},"helm install k8sgatekeeper ./k8sgatekeeper"),"."),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"})),(0,r.kt)("h2",{id:"experimente-o-k8s-gatekeeper-31-criar-modelo-e-pol\xedtica-casbin"},"Experimente o K8s-gatekeeper 3.1 Criar Modelo e Pol\xedtica Casbin"),(0,r.kt)("h3",{id:"voc\xea-tem-dois-m\xe9todos-para-criar-um-modelo-e-pol\xedtica-via-kubectl-ou-via-o-cliente-go-que-fornecemos"},"Voc\xea tem dois m\xe9todos para criar um modelo e pol\xedtica: via kubectl ou via o cliente go que fornecemos."),(0,r.kt)("p",null,"3.1.1 Criar/Atualizar Modelo e Pol\xedtica Casbin via kubectl"),(0,r.kt)("h4",{id:"no-k8s-gatekeeper-o-modelo-casbin-\xe9-armazenado-em-um-recurso-crd-chamado-casbinmodel"},"No K8s-gatekeeper, o Modelo Casbin \xe9 armazenado em um recurso CRD chamado 'CasbinModel'."),(0,r.kt)("p",null,"Sua defini\xe7\xe3o est\xe1 localizada em ",(0,r.kt)("inlineCode",{parentName:"p"},"config/auth.casbin.org_casbinmodels.yaml"),". Existem exemplos em ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/model.yaml"),"."),(0,r.kt)("p",null,"Preste aten\xe7\xe3o nos seguintes campos: metadata.name: o nome do modelo."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Este nome DEVE ser o mesmo que o nome do objeto CasbinPolicy relacionado a este modelo, para que o K8s-gatekeeper possa emparelh\xe1-los e criar um executor. spec.enable: se este campo estiver definido como 'false', este modelo (bem como o objeto CasbinPolicy relacionado a este modelo) ser\xe1 ignorado."),(0,r.kt)("li",{parentName:"ul"},"spec.modelText: uma string que cont\xe9m o texto do modelo de um Modelo Casbin."),(0,r.kt)("li",{parentName:"ul"},"A Pol\xedtica Casbin \xe9 armazenada em outro recurso CRD chamado 'CasbinPolicy', cuja defini\xe7\xe3o pode ser encontrada em ",(0,r.kt)("inlineCode",{parentName:"li"},"config/auth.casbin.org_casbinpolicies.yaml"),".")),(0,r.kt)("p",null,"Existem exemplos em ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/policy.yaml"),"."),(0,r.kt)("p",null,"Preste aten\xe7\xe3o nos seguintes campos: metadata.name: o nome da pol\xedtica."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Este nome DEVE ser o mesmo que o nome do objeto CasbinModel relacionado a esta pol\xedtica, para que o K8s-gatekeeper possa emparelh\xe1-los e criar um executor. spec.policyItem: uma string que cont\xe9m o texto da pol\xedtica de um Modelo Casbin."),(0,r.kt)("li",{parentName:"ul"},"Ap\xf3s criar seus pr\xf3prios arquivos CasbinModel e CasbinPolicy, use o seguinte comando para aplic\xe1-los:")),(0,r.kt)("p",null,"Uma vez que um par de CasbinModel e CasbinPolicy \xe9 criado, o K8s-gatekeeper ser\xe1 capaz de detect\xe1-lo dentro de 5 segundos."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f <filename>\n")),(0,r.kt)("p",null,"3.1.2 Criar/Atualizar Modelo e Pol\xedtica Casbin via o cliente go que fornecemos"),(0,r.kt)("h4",{id:"entendemos-que-pode-haver-situa\xe7\xf5es-em-que-n\xe3o-\xe9-conveniente-usar-o-shell-para-executar-comandos-diretamente-em-um-n\xf3-do-cluster-k8s-como-quando-voc\xea-est\xe1-construindo-uma-plataforma-de-nuvem-autom\xe1tica-para-sua-corpora\xe7\xe3o"},"Entendemos que pode haver situa\xe7\xf5es em que n\xe3o \xe9 conveniente usar o shell para executar comandos diretamente em um n\xf3 do cluster K8s, como quando voc\xea est\xe1 construindo uma plataforma de nuvem autom\xe1tica para sua corpora\xe7\xe3o."),(0,r.kt)("p",null,"Portanto, desenvolvemos um cliente go para criar e manter CasbinModel e CasbinPolicy. A biblioteca do cliente go est\xe1 localizada em ",(0,r.kt)("inlineCode",{parentName:"p"},"pkg/client"),"."),(0,r.kt)("p",null,"Em ",(0,r.kt)("inlineCode",{parentName:"p"},"client.go"),", fornecemos uma fun\xe7\xe3o para criar um cliente."),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"client.go"),", we provide a function to create a client."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func NewK8sGateKeeperClient(externalClient bool) (*K8sGateKeeperClient, error) \n")),(0,r.kt)("p",null,"O par\xe2metro ",(0,r.kt)("inlineCode",{parentName:"p"},"externalClient")," determina se o K8s-gatekeeper est\xe1 executando dentro do cluster K8s ou n\xe3o."),(0,r.kt)("p",null,"Em ",(0,r.kt)("inlineCode",{parentName:"p"},"model.go"),", fornecemos v\xe1rias fun\xe7\xf5es para criar, deletar e modificar CasbinModel. Voc\xea pode descobrir como usar essas interfaces em ",(0,r.kt)("inlineCode",{parentName:"p"},"model_test.go"),"."),(0,r.kt)("p",null,"Em ",(0,r.kt)("inlineCode",{parentName:"p"},"policy.go"),", fornecemos v\xe1rias fun\xe7\xf5es para criar, deletar e modificar CasbiPolicy. Voc\xea pode descobrir como usar essas interfaces em ",(0,r.kt)("inlineCode",{parentName:"p"},"policy_test.go"),"."),(0,r.kt)("h3",{id:"312-tente-se-o-k8s-gatekeeper-funciona"},"3.1.2 Tente se o K8s-gatekeeper funciona"),(0,r.kt)("p",null,"Suponha que voc\xea j\xe1 tenha criado o modelo e a pol\xedtica exatos em ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo"),". Agora, tente o seguinte comando:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f example/allowed_repo/testcase/reject_1.yaml\n")),(0,r.kt)("p",null,"Voc\xea deve descobrir que o K8s rejeitar\xe1 esta solicita\xe7\xe3o e mencionar\xe1 que o webhook foi a raz\xe3o pela qual esta solicita\xe7\xe3o foi rejeitada. No entanto, quando voc\xea tentar aplicar ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/testcase/approve_2.yaml"),", ele ser\xe1 aceito."),(0,r.kt)("h2",{id:"4-como-escrever-modelo-e-pol\xedtica-com-k8s-gatekeeper"},"4. Como Escrever Modelo e Pol\xedtica com K8s-gatekeeper"),(0,r.kt)("p",null,"Antes de tudo, certifique-se de que voc\xea est\xe1 familiarizado com a gram\xe1tica b\xe1sica dos Modelos e Pol\xedticas Casbin. Se voc\xea n\xe3o est\xe1, por favor, leia a se\xe7\xe3o ",(0,r.kt)("a",{parentName:"p",href:"/docs/get-started"},"Get Started")," primeiro. Neste cap\xedtulo, assumimos que voc\xea j\xe1 entende o que s\xe3o Modelos e Pol\xedticas Casbin."),(0,r.kt)("h3",{id:"41-defini\xe7\xe3o-de-solicita\xe7\xe3o-de-modelo"},"4.1 Defini\xe7\xe3o de Solicita\xe7\xe3o de Modelo"),(0,r.kt)("p",null,"Quando o K8s-gatekeeper est\xe1 autorizando uma solicita\xe7\xe3o, a entrada \xe9 sempre um objeto: o objeto Go da Solicita\xe7\xe3o de Admiss\xe3o. Isso significa que o executor sempre ser\xe1 usado assim:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"ok, err := enforcer.Enforce(admission)\n")),(0,r.kt)("p",null,"onde ",(0,r.kt)("inlineCode",{parentName:"p"},"admission")," \xe9 um objeto ",(0,r.kt)("inlineCode",{parentName:"p"},"AdmissionReview")," definido pela api oficial do K8s ",(0,r.kt)("inlineCode",{parentName:"p"},'"k8s.io/api/admission/v1"'),". Voc\xea pode encontrar a defini\xe7\xe3o desta estrutura neste reposit\xf3rio: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/api/blob/master/admission/v1/types.go"},"https://github.com/kubernetes/api/blob/master/admission/v1/types.go"),". Para mais informa\xe7\xf5es, voc\xea tamb\xe9m pode consultar ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response"},"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-request-and-response"),"."),(0,r.kt)("p",null,"Portanto, para qualquer modelo usado pelo K8s-gatekeeper, a defini\xe7\xe3o do ",(0,r.kt)("inlineCode",{parentName:"p"},"request_definition")," deve ser sempre assim:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},"    [request_definition]\n    r =  obj\n")),(0,r.kt)("p",null,"O nome 'obj' n\xe3o \xe9 obrigat\xf3rio, desde que o nome seja consistente com o nome usado na parte ",(0,r.kt)("inlineCode",{parentName:"p"},"[matchers]"),"."),(0,r.kt)("h3",{id:"42-correspondentes-de-modelo"},"4.2 Correspondentes de Modelo"),(0,r.kt)("p",null,"Voc\xea deve usar o recurso ABAC do Casbin para escrever suas regras. No entanto, o avaliador de express\xe3o integrado no Casbin n\xe3o suporta indexa\xe7\xe3o em mapas ou arrays (fatias), nem a expans\xe3o de arrays. Portanto, o K8s-gatekeeper fornece v\xe1rias 'fun\xe7\xf5es Casbin' como extens\xf5es para implementar esses recursos. Se voc\xea ainda achar que sua demanda n\xe3o pode ser atendida por essas extens\xf5es, sinta-se \xe0 vontade para iniciar um problema ou criar um pull request."),(0,r.kt)("p",null,"Se voc\xea n\xe3o est\xe1 familiarizado com as fun\xe7\xf5es Casbin, voc\xea pode consultar ",(0,r.kt)("a",{parentName:"p",href:"/docs/function"},"Function")," para mais informa\xe7\xf5es."),(0,r.kt)("p",null,"Aqui est\xe3o as fun\xe7\xf5es de extens\xe3o:"),(0,r.kt)("h3",{id:"421-fun\xe7\xf5es-de-extens\xe3o"},"4.2.1 Fun\xe7\xf5es de extens\xe3o"),(0,r.kt)("h4",{id:"4211-access"},"4.2.1.1 access"),(0,r.kt)("p",null,"Access \xe9 usado para resolver o problema de que o Casbin n\xe3o suporta indexa\xe7\xe3o em mapas ou arrays. O exemplo ",(0,r.kt)("inlineCode",{parentName:"p"},"example/allowed_repo/model.yaml")," demonstra o uso desta fun\xe7\xe3o:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'[matchers]\nm = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\naccess(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image") == p.obj\n')),(0,r.kt)("p",null,"Neste correspondente, ",(0,r.kt)("inlineCode",{parentName:"p"},'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Image")')," \xe9 equivalente a ",(0,r.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Image"),", onde ",(0,r.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers")," \xe9 uma fatia."),(0,r.kt)("p",null,"Access tamb\xe9m pode chamar fun\xe7\xf5es simples que n\xe3o t\xeam par\xe2metros e retornam um \xfanico valor. O exemplo ",(0,r.kt)("inlineCode",{parentName:"p"},"example/container_resource_limit/model.yaml")," demonstra isso:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'[matchers]\n  m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")) >= parseFloat(p.cpu) && \\\n  parseFloat(access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","memory","Value")) >= parseFloat(p.memory)\n')),(0,r.kt)("p",null,"Neste correspondente, ",(0,r.kt)("inlineCode",{parentName:"p"},'access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , 0, "Resources","Limits","cpu","Value")')," \xe9 equivalente a ",(0,r.kt)("inlineCode",{parentName:"p"},'r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits["cpu"].Value()'),", onde ",(0,r.kt)("inlineCode",{parentName:"p"},"r.obj.Request.Object.Object.Spec.Template.Spec.Containers[0].Resources.Limits")," \xe9 um mapa, e ",(0,r.kt)("inlineCode",{parentName:"p"},"Value()")," \xe9 uma fun\xe7\xe3o simples que n\xe3o tem par\xe2metros e retorna um \xfanico valor."),(0,r.kt)("h4",{id:"4212-accesswithwildcard"},"4.2.1.2 accessWithWildcard"),(0,r.kt)("p",null,'\xc0s vezes, voc\xea pode ter uma demanda como esta: todos os elementos de um array devem ter um prefixo "aaa". No entanto, o Casbin n\xe3o suporta loops ',(0,r.kt)("inlineCode",{parentName:"p"},"for"),". Com ",(0,r.kt)("inlineCode",{parentName:"p"},"accessWithWildcard"),' e o recurso de "expans\xe3o de map/slice", voc\xea pode implementar facilmente tal demanda.'),(0,r.kt)("p",null,"Por exemplo, suponha que ",(0,r.kt)("inlineCode",{parentName:"p"},"a.b.c")," seja um array ",(0,r.kt)("inlineCode",{parentName:"p"},"[aaa,bbb,ccc,ddd,eee]"),", ent\xe3o o resultado de ",(0,r.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(a,"b","c","*")')," ser\xe1 uma fatia ",(0,r.kt)("inlineCode",{parentName:"p"},"[aaa,bbb,ccc,ddd,eee]"),". Usando o curinga ",(0,r.kt)("inlineCode",{parentName:"p"},"*"),", a fatia \xe9 expandida."),(0,r.kt)("p",null,"Da mesma forma, o curinga pode ser usado mais de uma vez. Por exemplo, o resultado de ",(0,r.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(a,"b","c","*","*")')," ser\xe1 ",(0,r.kt)("inlineCode",{parentName:"p"},"[a.b.c[0][0], a.b.c[0][1], ..., a.b.c[1][0], a.b.c[1][1], ...]"),"."),(0,r.kt)("h3",{id:"4213-fun\xe7\xf5es-que-suportam-argumentos-de-comprimento-vari\xe1vel"},"4.2.1.3 Fun\xe7\xf5es que Suportam Argumentos de Comprimento Vari\xe1vel"),(0,r.kt)("p",null,"No avaliador de express\xe3o do Casbin, quando um par\xe2metro \xe9 um array, ele ser\xe1 automaticamente expandido como um argumento de comprimento vari\xe1vel. Utilizando esse recurso para suportar a expans\xe3o de array/fatia/mapa, tamb\xe9m integramos v\xe1rias fun\xe7\xf5es que aceitam um array/fatia como par\xe2metro:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"contain(): aceita v\xe1rios par\xe2metros e retorna se algum par\xe2metro (exceto o \xfaltimo par\xe2metro) \xe9 igual ao \xfaltimo par\xe2metro."),(0,r.kt)("li",{parentName:"ul"},"split(a,b,c...,sep,index): retorna um slice que cont\xe9m ",(0,r.kt)("inlineCode",{parentName:"li"},"[splits(a,sep)[index], splits(b,sep)[index], splits(a,sep)[index], ...]"),"."),(0,r.kt)("li",{parentName:"ul"},"len(): retorna o comprimento do argumento de comprimento vari\xe1vel."),(0,r.kt)("li",{parentName:"ul"},"matchRegex(a,b,c...,regex): retorna se todos os par\xe2metros dados (",(0,r.kt)("inlineCode",{parentName:"li"},"a"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"b"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"c"),", ...) correspondem ao regex fornecido.")),(0,r.kt)("p",null,"Aqui est\xe1 um exemplo em ",(0,r.kt)("inlineCode",{parentName:"p"},"example/disallowed_tag/model.yaml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},'    [matchers]\n    m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource =="deployments" && \\\n    contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)\n')),(0,r.kt)("p",null,"Assumindo que ",(0,r.kt)("inlineCode",{parentName:"p"},'accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image")')," retorna ",(0,r.kt)("inlineCode",{parentName:"p"},"['a:b', 'c:d', 'e:f', 'g:h']"),", porque splits suporta argumentos de comprimento vari\xe1vel e realiza a opera\xe7\xe3o de splits em cada elemento, o elemento no \xedndice 1 ser\xe1 selecionado e retornado. Portanto, ",(0,r.kt)("inlineCode",{parentName:"p"},'split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1)')," retorna ",(0,r.kt)("inlineCode",{parentName:"p"},"['b','d','f','h']"),". E ",(0,r.kt)("inlineCode",{parentName:"p"},'contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers , "*", "Image"),":",1) , p.obj)')," retorna se ",(0,r.kt)("inlineCode",{parentName:"p"},"p.obj")," est\xe1 contido em ",(0,r.kt)("inlineCode",{parentName:"p"},"['b','d','f','h']"),"."),(0,r.kt)("h4",{id:"4212-fun\xe7\xf5es-de-convers\xe3o-de-tipo"},"4.2.1.2 Fun\xe7\xf5es de Convers\xe3o de Tipo"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"ParseFloat(): Converte um inteiro para um float (isso \xe9 necess\xe1rio porque qualquer n\xfamero usado na compara\xe7\xe3o deve ser convertido em um float)."),(0,r.kt)("li",{parentName:"ul"},"ToString(): Converte um objeto para uma string. Este objeto deve ter um tipo b\xe1sico de string (por exemplo, um objeto do tipo ",(0,r.kt)("inlineCode",{parentName:"li"},"XXX")," quando h\xe1 uma declara\xe7\xe3o ",(0,r.kt)("inlineCode",{parentName:"li"},"type XXX string"),")."),(0,r.kt)("li",{parentName:"ul"},"IsNil(): Retorna se o par\xe2metro \xe9 nulo.")),(0,r.kt)("h2",{id:"5-configura\xe7\xf5es-avan\xe7adas"},"5. Configura\xe7\xf5es Avan\xe7adas"),(0,r.kt)("h3",{id:"51-sobre-certificados"},"5.1 Sobre Certificados"),(0,r.kt)("p",null,"No Kubernetes (k8s), \xe9 obrigat\xf3rio que um webhook use HTTPS. Existem duas abordagens para alcan\xe7ar isso:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Use certificados autoassinados (exemplos neste reposit\xf3rio usam este m\xe9todo)"),(0,r.kt)("li",{parentName:"ul"},"Use um certificado normal")),(0,r.kt)("h4",{id:"511-certificados-autoassinados"},"5.1.1 Certificados autoassinados"),(0,r.kt)("p",null,"Usar um certificado autoassinado significa que a Autoridade Certificadora (CA) que emite o certificado n\xe3o \xe9 uma das CAs bem conhecidas. Portanto, voc\xea deve informar o k8s sobre esta CA."),(0,r.kt)("p",null,"Atualmente, o exemplo neste reposit\xf3rio usa uma CA auto-criada, cuja chave privada e certificado est\xe3o armazenados em ",(0,r.kt)("inlineCode",{parentName:"p"},"config/certificate/ca.crt")," e ",(0,r.kt)("inlineCode",{parentName:"p"},"config/certificate/ca.key")," respectivamente. O certificado para o webhook \xe9 ",(0,r.kt)("inlineCode",{parentName:"p"},"config/certificate/server.crt"),', que \xe9 emitido pela CA auto-criada. Os dom\xednios deste certificado s\xe3o "webhook.domain.local" (para webhook externo) e "casbin-webhook-svc.default.svc" (para webhook interno).'),(0,r.kt)("p",null,"Informa\xe7\xf5es sobre a CA s\xe3o passadas para o k8s via arquivos de configura\xe7\xe3o do webhook. Tanto ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," quanto ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml"),' t\xeam um campo chamado "CABundle", que cont\xe9m uma string codificada em base64 do certificado da CA.'),(0,r.kt)("p",null,"Caso voc\xea precise mudar o certificado/dom\xednio (por exemplo, se voc\xea quiser colocar este webhook em outro namespace do k8s ao usar um webhook interno, ou se voc\xea quiser mudar o dom\xednio ao usar um webhook externo), os seguintes procedimentos devem ser seguidos:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Gere uma nova CA:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Gere a chave privada para a CA falsa:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl genrsa -des3 -out ca.key 2048\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Remova a prote\xe7\xe3o por senha da chave privada:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl rsa -in ca.key -out ca.key\n"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Gere uma chave privada para o servidor webhook:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl genrsa -des3 -out server.key 2048\nopenssl rsa -in server.key -out server.key\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Use a CA auto-gerada para assinar o certificado para o webhook:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Copie o arquivo de configura\xe7\xe3o do openssl do seu sistema para uso tempor\xe1rio. Voc\xea pode descobrir a localiza\xe7\xe3o do arquivo de configura\xe7\xe3o executando ",(0,r.kt)("inlineCode",{parentName:"p"},"openssl version -a"),", geralmente chamado ",(0,r.kt)("inlineCode",{parentName:"p"},"openssl.cnf"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"No arquivo de configura\xe7\xe3o:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Encontre o par\xe1grafo ",(0,r.kt)("inlineCode",{parentName:"p"},"[req]")," e adicione a seguinte linha: ",(0,r.kt)("inlineCode",{parentName:"p"},"req_extensions = v3_req"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Encontre o par\xe1grafo ",(0,r.kt)("inlineCode",{parentName:"p"},"[v3_req]")," e adicione a seguinte linha: ",(0,r.kt)("inlineCode",{parentName:"p"},"subjectAltName = @alt_names"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Acrescente as seguintes linhas ao arquivo:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-ini"},"[alt_names]\nDNS.2=<The domain you want>\n")),(0,r.kt)("p",{parentName:"li"},"Nota: Substitua 'casbin-webhook-svc.default.svc' pelo nome real do servi\xe7o do seu pr\xf3prio servi\xe7o se voc\xea decidir modificar o nome do servi\xe7o.")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Use o arquivo de configura\xe7\xe3o modificado para gerar um arquivo de solicita\xe7\xe3o de certificado:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl req -new -nodes -keyout server.key -out server.csr -config openssl.cnf\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Use a CA auto-criada para responder ao pedido e assinar o certificado:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"openssl x509 -req -days 3650 -in server.csr -out server.crt -CA ca.crt -CAkey ca.key -CAcreateserial -extensions v3_req -extensions SAN -extfile openssl.cnf\n"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Substitua o campo 'CABundle': Tanto ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_external.yaml")," quanto ",(0,r.kt)("inlineCode",{parentName:"p"},"config/webhook_internal.yaml"),' t\xeam um campo chamado "CABundle", que cont\xe9m uma string codificada em base64 do certificado da CA.')),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Atualize este campo com o novo certificado."))),(0,r.kt)("h4",{id:"se-voc\xea-estiver-usando-helm-mudan\xe7as-semelhantes-precisam-ser-aplicadas-aos-gr\xe1ficos-do-helm"},"Se voc\xea estiver usando helm, mudan\xe7as semelhantes precisam ser aplicadas aos gr\xe1ficos do helm."),(0,r.kt)("p",null,"5.1.2 Certificados legais Se voc\xea usar certificados legais, n\xe3o precisar\xe1 passar por todos esses procedimentos."))}m.isMDXComponent=!0}}]);