"use strict";(self.webpackChunkcasbin_website_v2=self.webpackChunkcasbin_website_v2||[]).push([[2010],{3905:(e,a,o)=>{o.d(a,{Zo:()=>d,kt:()=>c});var t=o(7294);function n(e,a,o){return a in e?Object.defineProperty(e,a,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[a]=o,e}function i(e,a){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),o.push.apply(o,t)}return o}function r(e){for(var a=1;a<arguments.length;a++){var o=null!=arguments[a]?arguments[a]:{};a%2?i(Object(o),!0).forEach((function(a){n(e,a,o[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):i(Object(o)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(o,a))}))}return e}function s(e,a){if(null==e)return{};var o,t,n=function(e,a){if(null==e)return{};var o,t,n={},i=Object.keys(e);for(t=0;t<i.length;t++)o=i[t],a.indexOf(o)>=0||(n[o]=e[o]);return n}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)o=i[t],a.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var u=t.createContext({}),l=function(e){var a=t.useContext(u),o=a;return e&&(o="function"==typeof e?e(a):r(r({},a),e)),o},d=function(e){var a=l(e.components);return t.createElement(u.Provider,{value:a},e.children)},p={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},m=t.forwardRef((function(e,a){var o=e.components,n=e.mdxType,i=e.originalType,u=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=l(o),c=n,b=m["".concat(u,".").concat(c)]||m[c]||p[c]||i;return o?t.createElement(b,r(r({ref:a},d),{},{components:o})):t.createElement(b,r({ref:a},d))}));function c(e,a){var o=arguments,n=a&&a.mdxType;if("string"==typeof e||n){var i=o.length,r=new Array(i);r[0]=m;var s={};for(var u in a)hasOwnProperty.call(a,u)&&(s[u]=a[u]);s.originalType=e,s.mdxType="string"==typeof e?e:n,r[1]=s;for(var l=2;l<i;l++)r[l]=o[l];return t.createElement.apply(null,r)}return t.createElement.apply(null,o)}m.displayName="MDXCreateElement"},36:(e,a,o)=>{o.r(a),o.d(a,{assets:()=>u,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var t=o(7462),n=(o(7294),o(3905));const i={title:"Autoriza\xe7\xe3o no APISIX usando Casbin",author:"Rushikesh Tote",authorTitle:"Membro do Casbin",authorURL:"http://github.com/rushitote",authorImageURL:"https://avatars.githubusercontent.com/rushitote"},r=void 0,s={permalink:"/pt/blog/2021/08/19/apisix-casbin-authorization",editUrl:"https://github.com/casbin/casbin-website-v2/edit/master/i18n/pt/docusaurus-plugin-content-blog/2021-08-19-apisix-casbin-authorization.md",source:"@site/i18n/pt/docusaurus-plugin-content-blog/2021-08-19-apisix-casbin-authorization.md",title:"Autoriza\xe7\xe3o no APISIX usando Casbin",description:"Introdu\xe7\xe3o",date:"2021-08-19T00:00:00.000Z",formattedDate:"19 de agosto de 2021",tags:[],readingTime:5.75,hasTruncateMarker:!1,authors:[{name:"Rushikesh Tote",title:"Membro do Casbin",url:"http://github.com/rushitote",imageURL:"https://avatars.githubusercontent.com/rushitote"}],frontMatter:{title:"Autoriza\xe7\xe3o no APISIX usando Casbin",author:"Rushikesh Tote",authorTitle:"Membro do Casbin",authorURL:"http://github.com/rushitote",authorImageURL:"https://avatars.githubusercontent.com/rushitote"},nextItem:{title:"Yang Luo - Vencedor do Pr\xeamio Google Open Source Peer Bonus",permalink:"/pt/blog/2020/04/21/google-award"}},u={authorsImageUrls:[void 0]},l=[{value:"Introdu\xe7\xe3o",id:"introdu\xe7\xe3o",level:2},{value:"Criando um modelo",id:"criando-um-modelo",level:2},{value:"Criando uma pol\xedtica",id:"criando-uma-pol\xedtica",level:2},{value:"Habilitando o plugin em uma rota",id:"habilitando-o-plugin-em-uma-rota",level:2},{value:"Habilitando o plugin usando um modelo/pol\xedtica global",id:"habilitando-o-plugin-usando-um-modelopol\xedtica-global",level:2},{value:"Casos de Uso",id:"casos-de-uso",level:2}],d={toc:l};function p(e){let{components:a,...i}=e;return(0,n.kt)("wrapper",(0,t.Z)({},d,i,{components:a,mdxType:"MDXLayout"}),(0,n.kt)("h2",{id:"introdu\xe7\xe3o"},"Introdu\xe7\xe3o"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://apisix.apache.org/"},"APISIX")," \xe9 um gateway de API nativo da nuvem de alta performance e escal\xe1vel baseado em Nginx e etcd. \xc9 um projeto de c\xf3digo aberto da Apache Software Foundation. Al\xe9m disso, o que torna o APISIX t\xe3o bom \xe9 o suporte de muitos \xf3timos plugins integrados que podem ser usados para implementar recursos como autentica\xe7\xe3o, monitoramento, roteamento, etc. E o fato de que os plugins no APISIX s\xe3o recarregados em tempo real (sem reinicializa\xe7\xf5es) o torna muito din\xe2mico."),(0,n.kt)("p",null,"Mas ao usar o APISIX, podem surgir cen\xe1rios em que voc\xea queira adicionar l\xf3gica de autoriza\xe7\xe3o complexa em sua aplica\xe7\xe3o. \xc9 aqui que o authz-casbin pode ajud\xe1-lo, authz-casbin \xe9 um plugin do APISIX baseado no ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/casbin/lua-casbin/"},"Lua Casbin")," que permite uma autoriza\xe7\xe3o poderosa baseada em v\xe1rios modelos de controle de acesso. ",(0,n.kt)("a",{parentName:"p",href:"/"},"Casbin")," \xe9 uma biblioteca de autoriza\xe7\xe3o que suporta modelos de controle de acesso como ACL, RBAC, ABAC. Originalmente escrito em Go, foi portado para muitas linguagens e Lua Casbin \xe9 a implementa\xe7\xe3o em Lua do Casbin. O desenvolvimento do authz-casbin come\xe7ou quando propusemos um novo plugin para autoriza\xe7\xe3o no reposit\xf3rio do APISIX (",(0,n.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/issues/4674"},"#4674"),") ao qual os membros principais concordaram. E ap\xf3s as revis\xf5es \xfateis que levaram a algumas mudan\xe7as importantes e melhorias, o PR (",(0,n.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/pull/4710"},"#4710"),") foi finalmente mesclado."),(0,n.kt)("p",null,"Neste blog, usaremos o plugin authz-casbin para mostrar como voc\xea pode implementar um modelo de autoriza\xe7\xe3o baseado em Controle de Acesso Baseado em Fun\xe7\xf5es (RBAC) no APISIX."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"NOTA"),": Voc\xea precisar\xe1 usar algum outro plugin ou fluxo de trabalho personalizado para autenticar o usu\xe1rio, j\xe1 que o Casbin far\xe1 apenas autoriza\xe7\xe3o e n\xe3o autentica\xe7\xe3o."),(0,n.kt)("h2",{id:"criando-um-modelo"},"Criando um modelo"),(0,n.kt)("p",null,"O plugin usa tr\xeas par\xe2metros para autorizar qualquer solicita\xe7\xe3o - sujeito, objeto e a\xe7\xe3o. Aqui, sujeito \xe9 o valor do cabe\xe7alho do nome de usu\xe1rio, que poderia ser algo como ",(0,n.kt)("inlineCode",{parentName:"p"},"[username: alice]"),". Ent\xe3o, o objeto \xe9 o caminho da URL que est\xe1 sendo acessado e a a\xe7\xe3o \xe9 o m\xe9todo de solicita\xe7\xe3o usado."),(0,n.kt)("p",null,"Vamos dizer que queremos criar um modelo com tr\xeas recursos nos caminhos - ",(0,n.kt)("inlineCode",{parentName:"p"},"/"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"/res1")," e ",(0,n.kt)("inlineCode",{parentName:"p"},"/res2"),". E queremos ter um modelo assim:"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"imagem",src:o(8478).Z,width:"4520",height:"1720"})),(0,n.kt)("p",null,"Isso significaria que todos os usu\xe1rios (",(0,n.kt)("inlineCode",{parentName:"p"},"*"),") como por exemplo ",(0,n.kt)("inlineCode",{parentName:"p"},"jack")," podem acessar a p\xe1gina inicial (",(0,n.kt)("inlineCode",{parentName:"p"},"/"),"). E usu\xe1rios com permiss\xf5es de ",(0,n.kt)("inlineCode",{parentName:"p"},"admin")," como ",(0,n.kt)("inlineCode",{parentName:"p"},"alice")," e ",(0,n.kt)("inlineCode",{parentName:"p"},"bob")," podem acessar todas as p\xe1ginas e recursos (como ",(0,n.kt)("inlineCode",{parentName:"p"},"res1")," e ",(0,n.kt)("inlineCode",{parentName:"p"},"res2"),"). Al\xe9m disso, vamos restringir usu\xe1rios sem quaisquer permiss\xf5es de admin a usar apenas o m\xe9todo de solicita\xe7\xe3o ",(0,n.kt)("inlineCode",{parentName:"p"},"GET"),". Para este cen\xe1rio, poder\xedamos definir o modelo como:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-ini"},"[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = (g(r.sub, p.sub) || keyMatch(r.sub, p.sub)) && keyMatch(r.obj, p.obj) && keyMatch(r.act, p.act)\n")),(0,n.kt)("h2",{id:"criando-uma-pol\xedtica"},"Criando uma pol\xedtica"),(0,n.kt)("p",null,"Do cen\xe1rio acima, a pol\xedtica seria:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-csv"},"p, *, /, GET\np, admin, *, *\ng, alice, admin\ng, bob, admin\n")),(0,n.kt)("p",null,"O matcher do modelo significa:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("inlineCode",{parentName:"li"},"(g(r.sub, p.sub) || keyMatch(r.sub, p.sub))"),": Ou o sujeito da solicita\xe7\xe3o tem um papel como o sujeito da pol\xedtica ou o sujeito da solicita\xe7\xe3o corresponde ao sujeito da pol\xedtica em ",(0,n.kt)("inlineCode",{parentName:"li"},"keyMatch"),". ",(0,n.kt)("inlineCode",{parentName:"li"},"keyMatch")," \xe9 uma fun\xe7\xe3o integrada no Lua Casbin, voc\xea pode dar uma olhada na descri\xe7\xe3o da fun\xe7\xe3o e em mais fun\xe7\xf5es que podem ser \xfateis ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/casbin/lua-casbin/blob/master/src/util/BuiltInFunctions.lua"},"aqui"),"."),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("inlineCode",{parentName:"li"},"keyMatch(r.obj, p.obj)"),": O objeto da solicita\xe7\xe3o corresponde ao objeto da pol\xedtica (caminho da URL aqui)."),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("inlineCode",{parentName:"li"},"keyMatch(r.act, p.act)"),": A a\xe7\xe3o da solicita\xe7\xe3o corresponde \xe0 a\xe7\xe3o da pol\xedtica (m\xe9todo de solicita\xe7\xe3o HTTP aqui).")),(0,n.kt)("h2",{id:"habilitando-o-plugin-em-uma-rota"},"Habilitando o plugin em uma rota"),(0,n.kt)("p",null,"Uma vez que voc\xea tenha criado o modelo e a pol\xedtica, voc\xea pode habilit\xe1-los em uma rota usando a API Admin do APISIX. Para habilit\xe1-los usando caminhos de arquivos de modelo e pol\xedtica:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},'curl http://127.0.0.1:9080/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "plugins": {\n        "authz-casbin": {\n            "model_path": "/path/to/model.conf",\n            "policy_path": "/path/to/policy.csv",\n            "username": "username"\n        }\n    },\n    "upstream": {\n        "nodes": {\n            "127.0.0.1:1980": 1\n        },\n        "type": "roundrobin"\n    },\n    "uri": "/*"\n}\'\n')),(0,n.kt)("p",null,"Aqui, o campo de nome de usu\xe1rio \xe9 o nome do cabe\xe7alho que voc\xea usar\xe1 para passar o sujeito. Por exemplo, se voc\xea for passar o cabe\xe7alho de nome de usu\xe1rio como ",(0,n.kt)("inlineCode",{parentName:"p"},"user: alice"),", voc\xea usaria ",(0,n.kt)("inlineCode",{parentName:"p"},'"username": "user"'),"."),(0,n.kt)("p",null,"Para usar texto de modelo/pol\xedtica em vez de arquivos, voc\xea pode usar os campos ",(0,n.kt)("inlineCode",{parentName:"p"},"model")," e ",(0,n.kt)("inlineCode",{parentName:"p"},"policy")," em vez disso:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},'curl http://127.0.0.1:9080/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "plugins": {\n        "authz-casbin": {\n            "model": "[request_definition]\n            r = sub, obj, act\n\n            [policy_definition]\n            p = sub, obj, act\n\n            [role_definition]\n            g = _, _\n\n            [policy_effect]\n            e = some(where (p.eft == allow))\n\n            [matchers]\n            m = (g(r.sub, p.sub) || keyMatch(r.sub, p.sub)) && keyMatch(r.obj, p.obj) && keyMatch(r.act, p.act)",\n\n            "policy": "p, *, /, GET\n            p, admin, *, *\n            g, alice, admin\n            g, bob, admin",\n\n            "username": "username"\n        }\n    },\n    "upstream": {\n        "nodes": {\n            "127.0.0.1:1980": 1\n        },\n        "type": "roundrobin"\n    },\n    "uri": "/*"\n}\'\n')),(0,n.kt)("h2",{id:"habilitando-o-plugin-usando-um-modelopol\xedtica-global"},"Habilitando o plugin usando um modelo/pol\xedtica global"),(0,n.kt)("p",null,"Pode haver situa\xe7\xf5es em que voc\xea queira usar uma \xfanica configura\xe7\xe3o de modelo e pol\xedtica em v\xe1rias rotas. Voc\xea pode fazer isso primeiro enviando uma solicita\xe7\xe3o ",(0,n.kt)("inlineCode",{parentName:"p"},"PUT")," para adicionar a configura\xe7\xe3o de modelo e pol\xedtica aos metadados do plugin por:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},'curl http://127.0.0.1:9080/apisix/admin/plugin_metadata/authz-casbin -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -i -X PUT -d \'\n{\n"model": "[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = (g(r.sub, p.sub) || keyMatch(r.sub, p.sub)) && keyMatch(r.obj, p.obj) && keyMatch(r.act, p.act)",\n\n"policy": "p, *, /, GET\np, admin, *, *\ng, alice, admin\ng, bob, admin"\n}\'\n')),(0,n.kt)("p",null,"E ent\xe3o para habilitar a mesma configura\xe7\xe3o em alguma rota, envie uma solicita\xe7\xe3o usando a API Admin:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sh"},'curl http://127.0.0.1:9080/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "plugins": {\n        "authz-casbin": {\n            "username": "username"\n        }\n    },\n    "upstream": {\n        "nodes": {\n            "127.0.0.1:1980": 1\n        },\n        "type": "roundrobin"\n    },\n    "uri": "/route1/*"\n}\'\n')),(0,n.kt)("p",null,"Isso adicionar\xe1 a configura\xe7\xe3o de metadados do plugin \xe0 rota. Voc\xea tamb\xe9m pode facilmente atualizar a configura\xe7\xe3o de metadados do plugin reenviando a solicita\xe7\xe3o aos metadados do plugin com a configura\xe7\xe3o de modelo e pol\xedtica atualizada, o plugin atualizar\xe1 automaticamente todas as rotas usando a configura\xe7\xe3o de metadados do plugin."),(0,n.kt)("h2",{id:"casos-de-uso"},"Casos de Uso"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"O principal caso de uso deste plugin seria na implementa\xe7\xe3o de autoriza\xe7\xe3o em suas APIs. Voc\xea pode facilmente adicionar este plugin em qualquer rota de API que voc\xea esteja usando com seu modelo de autoriza\xe7\xe3o e configura\xe7\xe3o de pol\xedtica."),(0,n.kt)("li",{parentName:"ul"},"Se voc\xea quiser ter um \xfanico modelo de autoriza\xe7\xe3o para todas as suas APIs, voc\xea pode usar o m\xe9todo de modelo/pol\xedtica global. Isso facilita a atualiza\xe7\xe3o da pol\xedtica para todas as rotas, j\xe1 que voc\xea s\xf3 precisa atualizar os metadados no etcd."),(0,n.kt)("li",{parentName:"ul"},"Enquanto se voc\xea gostaria de usar um modelo diferente para cada rota diferente, voc\xea pode usar o m\xe9todo de rota. Isso \xe9 \xfatil quando diferentes rotas de API t\xeam diferentes conjuntos de permiss\xf5es de usu\xe1rio. Voc\xea tamb\xe9m pode usar isso quando estiver lidando com pol\xedticas maiores, pois tornar\xe1 a autoriza\xe7\xe3o mais r\xe1pida quando filtrada em v\xe1rias rotas.")))}p.isMDXComponent=!0},8478:(e,a,o)=>{o.d(a,{Z:()=>t});const t=o.p+"assets/images/model-1c0c2441dd19f8b957744635985283eb.png"}}]);